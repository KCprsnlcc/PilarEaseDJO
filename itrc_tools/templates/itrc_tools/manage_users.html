{% extends "itrc_tools/base_itrc.html" %} {% load static %} {%block page_title%}
Manage Users {% endblock %} {% block itrc_content %}
<div
  class="pilarease-itrc-manage-users-container animate__animated animate__fadeIn"
>
  <h1 class="pilarease-itrc-section-title">Manage Users</h1>
  <p class="pilarease-itrc-section-info">
    View, edit, and manage user accounts within the system.
  </p>

  <!-- Add User Button -->
  <div class="pilarease-itrc-add-user">
    <button
      type="button"
      class="pilarease-itrc-action-button upload-button"
      id="addUserButton"
    >
      <i class="bx bx-user-plus"></i> Add User
    </button>
  </div>

  <!-- Search Form -->
  <form method="get" class="pilarease-itrc-search-form">
    <input
      type="text"
      name="search"
      placeholder="Search users..."
      class="pilarease-itrc-search-input"
      value="{{ search_query }}"
    />
    <button type="submit" class="pilarease-itrc-search-button">
      <i class="bx bx-search"></i>
    </button>
  </form>

  <!-- Bulk Actions Form -->
  <form
    id="bulk-action-form"
    method="post"
    action="{% url 'manage_users_bulk_action' %}"
  >
    {% csrf_token %}
    <div class="pilarease-itrc-bulk-actions">
      <select
        name="bulk_action"
        id="bulk-action-select"
        class="pilarease-itrc-role-dropdown"
      >
        <option value="">Select Action</option>
        <option value="verify">Verify Selected</option>
        <option value="activate">Activate Selected</option>
        <option value="deactivate">Deactivate Selected</option>
        <option value="delete">Delete Selected</option>
      </select>
      <button type="submit" class="pilarease-itrc-action-button save-button">
        Apply
      </button>
    </div>

    <!-- User Table with Checkboxes and Avatars -->
    <table class="pilarease-itrc-table">
      <thead>
        <tr>
          <th>
            <input
              type="checkbox"
              id="select-all"
              class="pilarease-itrc-select-all"
            />
          </th>
          <th>Avatar</th>
          <!-- New Avatar Column -->
          <th>User ID</th>
          <th>Student ID</th>
          <th>Username</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>
            <input
              type="checkbox"
              name="selected_users"
              value="{{ user.id }}"
              class="pilarease-itrc-user-checkbox"
            />
          </td>
          <td>
            {% if user.profile.avatar %}
            <img
              src="{{ user.profile.avatar.url }}"
              alt="{{ user.username }}'s Avatar"
              class="pilarease-itrc-avatar"
            />
            {% else %}
            <img
              src="{% static 'images/avatars/placeholder.png' %}"
              alt="Default Avatar"
              class="pilarease-itrc-avatar"
            />
            {% endif %}
          </td>
          <td>{{ user.id }}</td>
          <td>{{ user.student_id }}</td>
          <td>{{ user.username }}</td>
          <td>{{ user.full_name }}</td>
          <td>{{ user.email }}</td>
          <td>
            {% if user.is_itrc_staff %} ITRC Staff {% elif user.is_counselor %}
            Counselor {% else %} User {% endif %}
          </td>
          <td>
            {% if user.verification_status == 'verified' %}
            <span class="pilarease-itrc-status-label verified">Verified</span>
            {% elif user.verification_status == 'pending' %}
            <span class="pilarease-itrc-status-label pending">Pending</span>
            {% elif user.verification_status == 'deactivated' %}
            <span class="pilarease-itrc-status-label deactivated">
              Deactivated
            </span>
            {% else %}
            <span class="pilarease-itrc-status-label rejected">Rejected</span>
            {% endif %}
          </td>
          <td>
            <!-- Action buttons (Edit, Activate, Deactivate, Delete) -->
            <button
              type="button"
              class="pilarease-itrc-action-button edit-button"
              data-user-id="{{ user.id }}"
              title="Edit User"
            >
              <i class="bx bxs-edit"></i>
            </button>

            <select
              class="pilarease-itrc-role-dropdown"
              data-user-id="{{ user.id }}"
            >
              <option
                value="user"
                {%
                if
                not
                user.is_itrc_staff
                and
                not
                user.is_counselor
                %}selected{%
                endif
                %}
              >
                User
              </option>
              <option
                value="counselor"
                {%
                if
                user.is_counselor
                %}selected{%
                endif
                %}
              >
                Counselor
              </option>
              <option
                value="itrc_staff"
                {%
                if
                user.is_itrc_staff
                %}selected{%
                endif
                %}
              >
                ITRC Staff
              </option>
            </select>

            {% if user.verification_status != 'verified' %}
            <button
              type="button"
              class="pilarease-itrc-action-button activate-button"
              data-user-id="{{ user.id }}"
              title="Activate User"
            >
              <i class="bx bxs-check-circle"></i>
            </button>
            {% else %}
            <button
              type="button"
              class="pilarease-itrc-action-button deactivate-button"
              data-user-id="{{ user.id }}"
              title="Deactivate User"
            >
              <i class="bx bxs-x-circle"></i>
            </button>
            {% endif %}

            <button
              type="button"
              class="pilarease-itrc-action-button delete-button"
              data-user-id="{{ user.id }}"
              title="Delete User"
            >
              <i class="bx bxs-trash"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="pilarease-itrc-no-data">No users found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>

  <!-- Pagination -->
  <nav aria-label="Page navigation" class="pilarease-itrc-pagination">
    <ul class="pagination">
      {% if users.has_previous %}
      <li class="page-item">
        <a
          class="page-link"
          href="?page={{ users.previous_page_number }}&search={{ search_query }}"
          >&laquo;</a
        >
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">&laquo;</span>
      </li>
      {% endif %} {% for num in users_page_range %} {% if num == users.number %}
      <li class="page-item active">
        <span class="page-link">{{ num }}</span>
      </li>
      {% else %}
      <li class="page-item">
        <a class="page-link" href="?page={{ num }}&search={{ search_query }}"
          >{{ num }}</a
        >
      </li>
      {% endif %} {% endfor %} {% if users.has_next %}
      <li class="page-item">
        <a
          class="page-link"
          href="?page={{ users.next_page_number }}&search={{ search_query }}"
          >&raquo;</a
        >
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">&raquo;</span>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>

<!-- Add User Modal -->
<div
  class="pilarease-itrc-modal-overlay"
  id="addUserModalOverlay"
  style="display: none"
>
  <div class="pilarease-itrc-modal">
    <div class="pilarease-itrc-modal-header">
      <h2>Add New User</h2>
      <span class="pilarease-itrc-close-modal" id="closeAddUserModal"
        >&times;</span
      >
    </div>
    <div class="pilarease-itrc-modal-body">
      <form
        id="addUserForm"
        method="post"
        enctype="multipart/form-data"
        action="{% url 'add_user' %}"
      >
        {% csrf_token %}
        <div class="pilarease-itrc-form-group">
          <label for="username">Username</label>
          <input
            type="text"
            name="username"
            id="username"
            required
            class="pilarease-itrc-form-input"
          />
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="email">Email</label>
          <input
            type="email"
            name="email"
            id="email"
            required
            class="pilarease-itrc-form-input"
          />
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="student_id">Student ID</label>
          <input
            type="text"
            name="student_id"
            id="student_id"
            required
            class="pilarease-itrc-form-input"
          />
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="full_name">Full Name</label>
          <input
            type="text"
            name="full_name"
            id="full_name"
            required
            class="pilarease-itrc-form-input"
          />
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="academic_year_level">Academic Year Level</label>
          <input
            type="text"
            name="academic_year_level"
            id="academic_year_level"
            required
            class="pilarease-itrc-form-input"
          />
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="contact_number">Contact Number</label>
          <input
            type="text"
            name="contact_number"
            id="contact_number"
            class="pilarease-itrc-form-input"
          />
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="is_counselor">Is Counselor</label>
          <select
            name="is_counselor"
            id="is_counselor"
            class="pilarease-itrc-role-dropdown"
          >
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="is_itrc_staff">Is ITRC Staff</label>
          <select
            name="is_itrc_staff"
            id="is_itrc_staff"
            class="pilarease-itrc-role-dropdown"
          >
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="password">Password</label>
          <input
            type="password"
            name="password"
            id="password"
            required
            class="pilarease-itrc-form-input"
          />
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="avatar">Avatar</label>
          <input
            type="file"
            name="avatar"
            id="avatar"
            accept="image/*"
            class="pilarease-itrc-form-input"
          />
        </div>
        <div class="pilarease-itrc-form-group">
          <label for="is_active">Is Active</label>
          <select
            name="is_active"
            id="is_active"
            class="pilarease-itrc-role-dropdown"
          >
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="pilarease-itrc-modal-footer">
          <button
            type="button"
            class="pilarease-itrc-action-button reject-button"
            id="cancelAddUser"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="pilarease-itrc-action-button approve-button"
          >
            Add User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirmation Modal for Bulk Actions -->
<div
  class="pilarease-itrc-modal-overlay"
  id="bulkActionModalOverlay"
  style="display: none"
>
  <div class="pilarease-itrc-modal">
    <div class="pilarease-itrc-modal-header">
      <h2>Confirm Bulk Action</h2>
      <span class="pilarease-itrc-close-modal" id="closeBulkActionModal"
        >&times;</span
      >
    </div>
    <div class="pilarease-itrc-modal-body">
      <p>Are you sure you want to perform this action on the selected users?</p>
    </div>
    <div class="pilarease-itrc-modal-footer">
      <button
        type="button"
        class="pilarease-itrc-action-button reject-button"
        id="cancelBulkAction"
      >
        Cancel
      </button>
      <button
        type="button"
        class="pilarease-itrc-action-button approve-button"
        id="confirmBulkAction"
      >
        Confirm
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Select/Deselect All Checkboxes
    const selectAllCheckbox = document.getElementById("select-all");
    const userCheckboxes = document.querySelectorAll(
      ".pilarease-itrc-user-checkbox"
    );

    selectAllCheckbox.addEventListener("change", function () {
      userCheckboxes.forEach((cb) => (cb.checked = this.checked));
    });

    // Handle Bulk Action Form Submission
    const bulkActionForm = document.getElementById("bulk-action-form");
    const bulkActionSelect = document.getElementById("bulk-action-select");
    const bulkActionModalOverlay = document.getElementById(
      "bulkActionModalOverlay"
    );
    const closeBulkActionModal = document.getElementById(
      "closeBulkActionModal"
    );
    const cancelBulkAction = document.getElementById("cancelBulkAction");
    const confirmBulkAction = document.getElementById("confirmBulkAction");

    bulkActionForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const selectedAction = bulkActionSelect.value;
      const selectedUsers = Array.from(
        document.querySelectorAll(".pilarease-itrc-user-checkbox:checked")
      ).map((cb) => cb.value);

      if (!selectedAction) {
        toastr.error("Please select a bulk action to perform.");
        return;
      }

      if (selectedUsers.length === 0) {
        toastr.error("Please select at least one user to perform this action.");
        return;
      }

      // Show the confirmation modal
      bulkActionModalOverlay.style.display = "flex";
    });

    // Confirm Bulk Action
    confirmBulkAction.onclick = function () {
      const selectedAction = bulkActionSelect.value;
      const selectedUsers = Array.from(
        document.querySelectorAll(".pilarease-itrc-user-checkbox:checked")
      ).map((cb) => cb.value);

      // Create a hidden form dynamically to submit the selected action and users
      const form = document.createElement("form");
      form.method = "post";
      form.action = "{% url 'manage_users_bulk_action' %}";

      // CSRF Token
      const csrfToken = document.querySelector(
        'input[name="csrfmiddlewaretoken"]'
      ).value;
      const csrfInput = document.createElement("input");
      csrfInput.type = "hidden";
      csrfInput.name = "csrfmiddlewaretoken";
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);

      // Bulk Action
      const actionInput = document.createElement("input");
      actionInput.type = "hidden";
      actionInput.name = "bulk_action";
      actionInput.value = selectedAction;
      form.appendChild(actionInput);

      // Selected Users
      selectedUsers.forEach((userId) => {
        const userInput = document.createElement("input");
        userInput.type = "hidden";
        userInput.name = "selected_users";
        userInput.value = userId;
        form.appendChild(userInput);
      });

      document.body.appendChild(form);
      form.submit();
    };

    // Close Modal on Cancel or Close Button
    closeBulkActionModal.onclick = function () {
      bulkActionModalOverlay.style.display = "none";
    };

    cancelBulkAction.onclick = function () {
      bulkActionModalOverlay.style.display = "none";
    };

    // Close Modal when clicking outside the modal content
    window.onclick = function (event) {
      if (event.target == bulkActionModalOverlay) {
        bulkActionModalOverlay.style.display = "none";
      }
    };

    // Add User Modal Handling
    const addUserButton = document.getElementById("addUserButton");
    const addUserModalOverlay = document.getElementById("addUserModalOverlay");
    const closeAddUserModal = document.getElementById("closeAddUserModal");
    const cancelAddUser = document.getElementById("cancelAddUser");

    addUserButton.onclick = function () {
      addUserModalOverlay.style.display = "flex";
    };

    closeAddUserModal.onclick = function () {
      addUserModalOverlay.style.display = "none";
    };

    cancelAddUser.onclick = function () {
      addUserModalOverlay.style.display = "none";
    };

    // Close Add User Modal when clicking outside the modal content
    window.onclick = function (event) {
      if (event.target == addUserModalOverlay) {
        addUserModalOverlay.style.display = "none";
      }
    };

    // Activate Button Click Handler
    document.querySelectorAll(".activate-button").forEach(function (button) {
      button.addEventListener("click", function () {
        const userId = this.getAttribute("data-user-id");
        if (confirm("Are you sure you want to activate this user?")) {
          fetch(`/itrc/activate-user/${userId}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({}),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                toastr.success(data.message);
                location.reload();
              } else {
                toastr.error(data.message);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              toastr.error("An error occurred while activating the user.");
            });
        }
      });
    });

    // Deactivate Button Click Handler
    document.querySelectorAll(".deactivate-button").forEach(function (button) {
      button.addEventListener("click", function () {
        const userId = this.getAttribute("data-user-id");
        if (confirm("Are you sure you want to deactivate this user?")) {
          fetch(`/itrc/deactivate-user/${userId}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({}),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                toastr.success(data.message);
                location.reload();
              } else {
                toastr.error(data.message);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              toastr.error("An error occurred while deactivating the user.");
            });
        }
      });
    });

    // Edit Button Click Handler (Optional Enhancement)
    document.querySelectorAll(".edit-button").forEach(function (button) {
      button.addEventListener("click", function () {
        const userId = this.getAttribute("data-user-id");
        window.location.href = `/itrc/edit-user/${userId}/`; // Ensure this URL is defined
      });
    });

    // Role Dropdown Change Handler
    document
      .querySelectorAll(".pilarease-itrc-role-dropdown")
      .forEach(function (dropdown) {
        dropdown.addEventListener("change", function () {
          const userId = this.getAttribute("data-user-id");
          const newRole = this.value;

          fetch(`/itrc/change-role/${userId}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ role: newRole }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                toastr.success(data.message);
                location.reload();
              } else {
                toastr.error(data.message);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              toastr.error("An error occurred while changing the user's role.");
            });
        });
      });
  });
</script>
{% endblock %}
