<!-- itrc_tools/templates/itrc_tools/base_itrc.html -->
{% load static %} {% load compress %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PilarEase ITRC Tools</title>
    <!-- Include Boxicons -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <!-- Include Animate.css -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <!-- Include Toastr CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />
    {% compress css %}
    <link rel="stylesheet" href="{% static 'css/itrc.css' %}" />
    {% endcompress %}

    <!-- Custom CSS for Toastr Notifications (Optional) -->
    <style>
      /* Customize Toastr Notifications */
      #toast-container > .toast-success {
        background-color: #28a745;
      }

      #toast-container > .toast-error {
        background-color: #dc3545;
      }

      #toast-container > .toast-warning {
        background-color: #ffc107;
      }

      #toast-container > .toast-info {
        background-color: #17a2b8;
      }

      /* Style the Logout Button to look like a menu item */
      .pilarease-itrc-logout-form {
        display: block; /* Changed from inline to block for full-width */
      }

      .pilarease-itrc-logout-button {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        padding: 0;
        font: inherit;
        text-align: left;
        width: 100%;
        height: 100%;
      }

      .pilarease-itrc-logout-button:hover {
        background-color: #f0f0f0; /* Matches hover for other menu items */
      }

      /* Ensure the logout button spans the entire menu item area */
      .pilarease-itrc-menu-item {
        display: flex;
        align-items: center;
        padding: 10px 20px;
        text-decoration: none;
        color: #333;
        width: 100%; /* Ensure full width */
        box-sizing: border-box; /* Include padding in width */
      }

      .pilarease-itrc-menu-item i {
        margin-right: 10px;
      }

      .pilarease-itrc-menu-item:hover {
        background-color: #f0f0f0;
      }
      #notificationButton {
        width: 40px; /* Matches the avatar size */
        height: 40px; /* Matches the avatar size */
        font-size: 20px;
        color: #ffffff;
        background-color: var(--primary-color); /* Blue background */
        border: 2px solid var(--primary-color); /* Blue border */
        padding: 0;
        border-radius: 50%; /* Circular shape */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: background-color var(--transition-speed),
          border-color var(--transition-speed);
      }

      #notificationButton:hover {
        background-color: #357ab8; /* Slightly darker on hover */
        border-color: #357ab8; /* Matches background on hover */
      }

      .notification-dot {
        width: 10px;
        height: 10px;
        z-index: 10000;
        background-color: #e74c3c;
        border-radius: 50%;
        position: absolute;
        top: 8px;
        right: 8px;
        display: none;
      }

      .notification-dot.blink {
        animation: blinkDot 1s infinite;
      }

      /* Blinking red animation for the dot */
      @keyframes blinkDot {
        0% {
          opacity: 1;
          background-color: #e74c3c;
        }
        50% {
          opacity: 0.5;
          background-color: #c0392b;
        }
        100% {
          opacity: 1;
          background-color: #e74c3c;
        }
      }

      /* Notification List Styles */
      #notificationList {
        position: absolute;
        top: 50px;
        right: 20px;
        background: #fff;
        color: #000;
        width: 350px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        display: none;
        opacity: 0;
        max-height: 400px;
        overflow-y: auto;
      }

      #notificationList.active {
        display: block;
        animation: popDownNotification 0.3s ease-out forwards;
      }

      @keyframes popDownNotification {
        from {
          transform: translateY(-20px) scale(0.8);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .notification-header {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        font-size: 14px;
        font-weight: bold;
        border-bottom: 1px solid #ccc;
      }

      .notification-header .see-all a {
        color: #4a90e2;
        text-decoration: none;
      }

      .notification-header .see-all a:hover {
        text-decoration: underline;
      }

      .notification-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #fff;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .notification-item:hover {
        background-color: #f9f9f9;
      }

      .notification-item.unread {
        background-color: #fcfcfc;
      }

      .notification-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #f0f0f0;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .notification-content {
        flex-grow: 1;
        overflow: hidden;
      }

      .notification-content .message {
        font-size: 13px;
        color: #0f2326;
      }

      .notification-content .timestamp {
        font-size: 12px;
        color: #9095a0;
        margin-top: 3px;
      }

      .notification-content .timestamp-green {
        color: #4a90e2;
      }

      /* Loader Styles */
      .loader {
        text-align: center;
        padding: 20px;
        font-size: 14px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="pilarease-itrc-sidebar animate__animated animate__fadeInLeft">
      <div class="pilarease-itrc-sidebar-header">
        <img
          src="{% static 'images/PilarLogo.png' %}"
          alt="Logo"
          class="pilarease-itrc-sidebar-logo"
        />
        <span class="pilarease-itrc-sidebar-title">PilarEase</span>
      </div>
      <ul class="pilarease-itrc-sidebar-menu">
        <li>
          <a href="{% url 'itrc_dashboard' %}" class="pilarease-itrc-menu-item">
            <i class="bx bxs-dashboard"></i>
            <span class="pilarease-itrc-menu-text">Dashboard</span>
          </a>
        </li>
        <li>
          <a
            href="{% url 'upload_masterlist' %}"
            class="pilarease-itrc-menu-item"
          >
            <i class="bx bxs-cloud-upload"></i>
            <span class="pilarease-itrc-menu-text">Upload Masterlist</span>
          </a>
        </li>
        <li>
          <a href="{% url 'manage_users' %}" class="pilarease-itrc-menu-item">
            <i class="bx bxs-user-detail"></i>
            <span class="pilarease-itrc-menu-text">Manage Users</span>
          </a>
        </li>
        <li>
          <a
            href="{% url 'system_settings' %}"
            class="pilarease-itrc-menu-item"
          >
            <i class="bx bxs-cog"></i>
            <span class="pilarease-itrc-menu-text">System Settings</span>
          </a>
        </li>
        <li>
          <a
            href="{% url 'generate_reports' %}"
            class="pilarease-itrc-menu-item"
          >
            <i class="bx bxs-report"></i>
            <span class="pilarease-itrc-menu-text">Reports</span>
          </a>
        </li>
        <li>
          <a href="{% url 'audit_logs' %}" class="pilarease-itrc-menu-item">
            <i class="bx bx-book"></i>
            <span class="pilarease-itrc-menu-text">Audit Logs</span>
          </a>
        </li>
        <li>
          <!-- Logout Button as a Form -->
          <form
            action="{% url 'itrc_logout' %}"
            method="post"
            class="pilarease-itrc-logout-form"
          >
            {% csrf_token %}
            <button
              type="submit"
              class="pilarease-itrc-menu-item pilarease-itrc-logout-button"
            >
              <i class="bx bxs-log-out"></i>
              <span class="pilarease-itrc-menu-text">Logout</span>
            </button>
          </form>
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="pilarease-itrc-main-content">
      <!-- Header -->
      <div class="pilarease-itrc-header">
        <div class="pilarease-itrc-header-left">
          <h2 class="pilarease-itrc-page-title">
            {% block page_title %}{% endblock %}
          </h2>
        </div>
        <div class="pilarease-itrc-header-right" style="position: relative">
          <!-- Notification Button -->
          <button
            id="notificationButton"
            class="notification-button"
            aria-label="Notifications"
          >
            <i class="bx bxs-bell"></i>
            <span id="notificationDot" class="notification-dot"></span>
          </button>

          <!-- Notification List -->
          <div id="notificationList" class="notification-list">
            <div class="notification-header">
              <span class="earlier">Earlier</span>
              <span class="see-all">
                <a href="{% url 'notifications' %}">See All</a>
              </span>
            </div>

            <!-- Notification Items will be dynamically loaded here -->
            <div id="notificationItems">
              <div class="loader">Loading notifications...</div>
            </div>

            <!-- Load More Button -->
            <div
              id="notificationLoadMore"
              class="notification-load-more"
              style="display: none"
            >
              Load More
            </div>
          </div>

          <!-- Profile Icon -->
          <div
            class="pilarease-itrc-profile-icon"
            title="{{ request.user.username }}"
          >
            {{ request.user.username|slice:":1"|upper }}
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="pilarease-itrc-content">
        {% block itrc_content %}
        <!-- ITRC-specific content will be injected here -->
        {% endblock %}
      </div>
    </div>

    <!-- Include jQuery (required for Toastr and notifications) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Include Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- Include Custom JS -->
    <script src="{% static 'js/scripts.js' %}"></script>

    <!-- Toastr Notifications -->
    <script>
      $(document).ready(function () {
        {% if messages %}
          {% for message in messages %}
            toastr.options = {
              closeButton: true,
              progressBar: true,
              positionClass: "toast-top-right",
              timeOut: "5000",
              extendedTimeOut: "1000",
              showEasing: "swing",
              hideEasing: "linear",
              showMethod: "fadeIn",
              hideMethod: "fadeOut",
            };
            toastr["{{ message.tags }}"]("{{ message|escapejs }}");
          {% endfor %}
        {% endif %}
      });
    </script>

    <!-- Notification Dropdown Script -->
    <script>
      $(document).ready(function () {
        // Toggle Notification List
        $('#notificationButton').on('click', function (e) {
          e.stopPropagation();
          $('#notificationList').toggleClass('active');
          if ($('#notificationList').hasClass('active')) {
            loadNotifications(1); // Load the first page when opened
          }
        });

        // Hide Notification List when clicking outside
        $(document).on('click', function (e) {
          if (!$(e.target).closest('#notificationButton').length) {
            $('#notificationList').removeClass('active');
          }
        });

        // Update Notification Dot based on unread count
        function updateNotificationsDot() {
          var unreadCount = {{ unread_notifications_count|default:"0" }};
          if (unreadCount > 0) {
            $('#notificationDot').show();
            if (unreadCount > 5) {
              $('#notificationDot').addClass('blink');
            } else {
              $('#notificationDot').removeClass('blink');
            }
          } else {
            $('#notificationDot').hide();
            $('#notificationDot').removeClass('blink');
          }
        }

        updateNotificationsDot();

        // Function to load notifications via AJAX
        function loadNotifications(page) {
          $.ajax({
            url: "{% url 'fetch_notifications' %}",
            type: 'GET',
            data: {
              'page': page
            },
            beforeSend: function () {
              $('#notificationItems').html('<div class="loader">Loading notifications...</div>');
              $('#notificationLoadMore').hide();
            },
            success: function (data) {
              var notifications = data.notifications;
              var total_pages = data.total_pages;
              var html = '';

              if (notifications.length > 0) {
                notifications.forEach(function (notification) {
                  var itemClass = notification.is_read ? 'read' : 'unread';
                  var timestampClass = notification.is_read ? '' : 'timestamp-green';
                  html += `
                    <div class="notification-item ${itemClass}" data-id="${notification.id}">
                      <div class="notification-avatar">
                        <img src="${notification.avatar}" alt="Avatar" style="width:40px; height:40px; border-radius:50%;">
                      </div>
                      <div class="notification-content">
                        <span class="message">${notification.message}</span>
                        <div class="timestamp ${timestampClass}">${notification.timestamp}</div>
                      </div>
                    </div>
                  `;
                });

                $('#notificationItems').html(html);

                if (page < total_pages) {
                  $('#notificationLoadMore').show().data('page', page + 1);
                } else {
                  $('#notificationLoadMore').hide();
                }
              } else {
                $('#notificationItems').html('<div class="notification-item">No notifications.</div>');
              }

              // Attach click event to mark as read and redirect
              $('.notification-item').on('click', function () {
                var notificationId = $(this).data('id');
                var link = notifications.find(n => n.id === notificationId).link;

                // Mark as read via AJAX
                $.ajax({
                  url: "{% url 'mark_notification_as_read' 0 %}".replace('/0/', '/' + notificationId + '/'),
                  type: 'POST',
                  data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                  },
                  success: function (response) {
                    if(response.success) {
                      // Update the notification item class
                      $('.notification-item[data-id="' + notificationId + '"]').removeClass('unread').addClass('read');
                      // Optionally, update the notification dot count
                      updateNotificationsDot();
                    }
                  },
                  error: function(xhr, errmsg, err) {
                    console.error("Error marking notification as read:", errmsg);
                  }
                });

                // Redirect to the notification link
                window.location.href = link;
              });
            },
            error: function (xhr, errmsg, err) {
              $('#notificationItems').html('<div class="notification-item">Failed to load notifications.</div>');
              console.error("Error fetching notifications:", errmsg);
            }
          });
        }

        // Load more notifications when clicking 'Load More'
        $('#notificationLoadMore').on('click', function () {
          var nextPage = $(this).data('page');
          loadNotifications(nextPage);
        });
      });
    </script>

    <!-- Page Specific Scripts -->
    {% block extra_scripts %}{% endblock %}
  </body>
</html>
