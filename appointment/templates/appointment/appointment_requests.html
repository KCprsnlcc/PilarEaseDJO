{% extends 'appointment/base_appointment.html' %}
{% load static %}

{% block page_title %}Appointment Requests{% endblock %}
{% block content_title %}Appointment Requests{% endblock %}

{% block appointment_content %}
<div class="appointment-pilarease-content-wrapper">
  <div class="appointment-pilarease-content-header">
    <h1>Appointment Requests</h1>
    <div class="appointment-pilarease-filters">
      <form method="GET" class="appointment-pilarease-filter-form">
        <div class="form-row">
          <div class="form-group col-md-2">
            <label for="status">Status</label>
            <select name="status" id="status" class="form-control">
              <option value="">All Statuses</option>
              <option value="PENDING" {% if selected_status == 'PENDING' %}selected{% endif %}>Pending</option>
              <option value="APPROVED" {% if selected_status == 'APPROVED' %}selected{% endif %}>Approved</option>
              <option value="REJECTED" {% if selected_status == 'REJECTED' %}selected{% endif %}>Rejected</option>
              <option value="CANCELLED" {% if selected_status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
              <option value="COMPLETED" {% if selected_status == 'COMPLETED' %}selected{% endif %}>Completed</option>
            </select>
          </div>
          <div class="form-group col-md-3">
            <label for="daterange">Date Range</label>
            <input type="text" id="daterange" name="daterange" class="form-control" 
              value="{{ date_from|default:'' }} - {{ date_to|default:'' }}">
            <input type="hidden" name="date_from" id="date_from" value="{{ date_from|default:'' }}">
            <input type="hidden" name="date_to" id="date_to" value="{{ date_to|default:'' }}">
          </div>
          <div class="form-group col-md-4">
            <label for="search">Search</label>
            <input type="text" name="search" id="search" class="form-control" 
              placeholder="Search title, user, or counselor" value="{{ search|default:'' }}">
          </div>
          <div class="form-group col-md-3 d-flex align-items-end">
            <button type="submit" class="pilarease-admin-action-button approve-button">
              <i class="bx bx-filter-alt"></i> Apply Filters
            </button>
            <a href="{% url 'appointment:appointment_requests' %}" class="pilarease-admin-action-button export-button ml-2">
              <i class="bx bx-reset"></i> Reset
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Statistics -->
  <div class="appointment-pilarease-stats-row">
    <div class="appointment-pilarease-stat-card">
      <div class="appointment-pilarease-stat-icon pending">
        <i class="bx bx-time"></i>
      </div>
      <div class="appointment-pilarease-stat-info">
        <h3>{{ stats.pending }}</h3>
        <p>Pending</p>
      </div>
    </div>
    <div class="appointment-pilarease-stat-card">
      <div class="appointment-pilarease-stat-icon approved">
        <i class="bx bx-check-circle"></i>
      </div>
      <div class="appointment-pilarease-stat-info">
        <h3>{{ stats.approved }}</h3>
        <p>Approved</p>
      </div>
    </div>
    <div class="appointment-pilarease-stat-card">
      <div class="appointment-pilarease-stat-icon rejected">
        <i class="bx bx-x-circle"></i>
      </div>
      <div class="appointment-pilarease-stat-info">
        <h3>{{ stats.rejected }}</h3>
        <p>Rejected</p>
      </div>
    </div>
    <div class="appointment-pilarease-stat-card">
      <div class="appointment-pilarease-stat-icon">
        <i class="bx bx-calendar-check"></i>
      </div>
      <div class="appointment-pilarease-stat-info">
        <h3>{{ stats.total }}</h3>
        <p>Total</p>
      </div>
    </div>
  </div>

  <!-- Pending Requests Section -->
  {% if pending_requests %}
  <div class="appointment-pilarease-section">
    <div class="appointment-pilarease-section-header">
      <h2>Pending Requests</h2>
      <span class="appointment-pilarease-badge">{{ pending_requests.paginator.count }}</span>
    </div>
    
    <div class="appointment-pilarease-table-responsive">
      <table class="appointment-pilarease-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>User</th>
            <th>Title</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for request in pending_requests %}
          <tr>
            <td>{{ request.date|date:"M d, Y" }}</td>
            <td>{{ request.start_time|time:"H:i" }} - {{ request.end_time|time:"H:i" }}</td>
            <td>{{ request.user.full_name }}</td>
            <td>{{ request.title }}</td>
            <td>{{ request.created_at|date:"M d, Y" }}</td>
            <td>
              <div class="appointment-pilarease-actions">
                <a href="{% url 'appointment:appointment_detail' appointment_id=request.id %}" class="pilarease-admin-action-button view-button">
                  <i class="bx bx-detail"></i> View
                </a>
                <form method="post" action="{% url 'appointment:update_appointment_status' appointment_id=request.id %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="APPROVED">
                  <button type="submit" class="pilarease-admin-action-button approve-button">
                    <i class="bx bx-check"></i> Approve
                  </button>
                </form>
                <form method="post" action="{% url 'appointment:update_appointment_status' appointment_id=request.id %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="REJECTED">
                  <button type="submit" class="pilarease-admin-action-button delete-button">
                    <i class="bx bx-x"></i> Reject
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if pending_requests.has_other_pages %}
    <div class="appointment-pilarease-pagination">
      <ul class="pagination">
        {% if pending_requests.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ pending_requests.previous_page_number }}&status={{ selected_status }}&date_from={{ date_from }}&date_to={{ date_to }}&search={{ search }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}
        
        {% for i in pending_requests.paginator.page_range %}
          {% if pending_requests.number == i %}
          <li class="page-item active">
            <span class="page-link">{{ i }}</span>
          </li>
          {% else %}
          <li class="page-item">
            <a class="page-link" href="?page={{ i }}&status={{ selected_status }}&date_from={{ date_from }}&date_to={{ date_to }}&search={{ search }}">{{ i }}</a>
          </li>
          {% endif %}
        {% endfor %}
        
        {% if pending_requests.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ pending_requests.next_page_number }}&status={{ selected_status }}&date_from={{ date_from }}&date_to={{ date_to }}&search={{ search }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
      </ul>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- All Requests Section -->
  <div class="appointment-pilarease-section">
    <div class="appointment-pilarease-section-header">
      <h2>All Requests</h2>
      <span class="appointment-pilarease-badge">{{ all_requests.paginator.count }}</span>
    </div>
    
    <div class="appointment-pilarease-table-responsive">
      <table class="appointment-pilarease-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>User</th>
            <th>Title</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for request in all_requests %}
          <tr>
            <td>{{ request.date|date:"M d, Y" }}</td>
            <td>{{ request.start_time|time:"H:i" }} - {{ request.end_time|time:"H:i" }}</td>
            <td>{{ request.user.full_name }}</td>
            <td>{{ request.title }}</td>
            <td>
              <span class="pilarease-admin-status-label {% if request.status == 'PENDING' %}processing
                {% elif request.status == 'APPROVED' %}completed
                {% elif request.status == 'COMPLETED' %}completed
                {% elif request.status == 'REJECTED' %}failed
                {% elif request.status == 'CANCELLED' %}failed{% endif %}">
                {{ request.get_status_display }}
              </span>
            </td>
            <td>
              <div class="appointment-pilarease-actions">
                <a href="{% url 'appointment:appointment_detail' appointment_id=request.id %}" class="pilarease-admin-action-button view-button">
                  <i class="bx bx-detail"></i> View
                </a>
                {% if request.status == 'PENDING' %}
                <form method="post" action="{% url 'appointment:update_appointment_status' appointment_id=request.id %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="APPROVED">
                  <button type="submit" class="pilarease-admin-action-button approve-button">
                    <i class="bx bx-check"></i> Approve
                  </button>
                </form>
                {% elif request.status == 'APPROVED' %}
                <form method="post" action="{% url 'appointment:update_appointment_status' appointment_id=request.id %}" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="COMPLETED">
                  <button type="submit" class="pilarease-admin-action-button approve-button">
                    <i class="bx bx-check-double"></i> Complete
                  </button>
                </form>
                {% endif %}
                <a href="{% url 'appointment:edit_appointment' appointment_id=request.id %}" class="pilarease-admin-action-button export-button">
                  <i class="bx bx-edit"></i> Edit
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center">No requests found matching your criteria.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if all_requests.has_other_pages %}
    <div class="appointment-pilarease-pagination">
      <ul class="pagination">
        {% if all_requests.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?all_page={{ all_requests.previous_page_number }}&status={{ selected_status }}&date_from={{ date_from }}&date_to={{ date_to }}&search={{ search }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
        {% endif %}
        
        {% for i in all_requests.paginator.page_range %}
          {% if all_requests.number == i %}
          <li class="page-item active">
            <span class="page-link">{{ i }}</span>
          </li>
          {% else %}
          <li class="page-item">
            <a class="page-link" href="?all_page={{ i }}&status={{ selected_status }}&date_from={{ date_from }}&date_to={{ date_to }}&search={{ search }}">{{ i }}</a>
          </li>
          {% endif %}
        {% endfor %}
        
        {% if all_requests.has_next %}
        <li class="page-item">
          <a class="page-link" href="?all_page={{ all_requests.next_page_number }}&status={{ selected_status }}&date_from={{ date_from }}&date_to={{ date_to }}&search={{ search }}">Next</a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
        {% endif %}
      </ul>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
<script>
  $(function() {
    // Initialize date range picker
    $('#daterange').daterangepicker({
      opens: 'left',
      autoUpdateInput: false,
      locale: {
        format: 'YYYY-MM-DD',
        cancelLabel: 'Clear'
      }
    });
    
    $('#daterange').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('YYYY-MM-DD') + ' - ' + picker.endDate.format('YYYY-MM-DD'));
      $('#date_from').val(picker.startDate.format('YYYY-MM-DD'));
      $('#date_to').val(picker.endDate.format('YYYY-MM-DD'));
    });
    
    $('#daterange').on('cancel.daterangepicker', function(ev, picker) {
      $(this).val('');
      $('#date_from').val('');
      $('#date_to').val('');
    });
  });
</script>
{% endblock %} 