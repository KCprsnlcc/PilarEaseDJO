{% extends 'appointment/base_appointment.html' %}
{% load static %}

{% block page_title %}Appointment Calendar{% endblock %}
{% block content_title %}Appointment Calendar{% endblock %}
{% block appointment_content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css">
<style>
  /* Modern Calendar Styles */
  .appointment-pilarease-calendar-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 25px;
    padding: 25px;
    overflow: hidden;
  }
  
  .appointment-pilarease-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }
  
  .appointment-pilarease-calendar-title {
    font-size: 1.6rem;
    font-weight: 600;
    margin: 0;
    color: #333;
  }
  
  .appointment-pilarease-calendar-controls {
    display: flex;
    gap: 10px;
  }
  
  /* Status Indicators and Legend */
  .appointment-pilarease-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 20px;
    padding: 15px;
    background: rgba(248, 249, 250, 0.7);
    border-radius: 8px;
  }
  
  .appointment-pilarease-legend-item {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    padding: 5px 10px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  .appointment-pilarease-legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
  }
  
  /* Event Styles */
  .fc .fc-daygrid-day.fc-day-today {
    background-color: rgba(63, 81, 181, 0.1);
  }
  
  .fc-event {
    cursor: pointer;
    border-radius: 6px;
    padding: 2px 4px;
    font-size: 0.85rem;
    border: none !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .fc-event.pending {
    background-color: #FFC107;
    border-color: #FFC107;
    color: #000;
  }
  
  .fc-event.approved {
    background-color: #4CAF50;
    border-color: #4CAF50;
    color: white;
  }
  
  .fc-event.completed {
    background-color: #2196F3;
    border-color: #2196F3;
    color: white;
  }
  
  .fc-event.rejected {
    background-color: #F44336;
    border-color: #F44336;
    color: white;
  }
  
  .fc-event.cancelled {
    background-color: #9E9E9E;
    border-color: #9E9E9E;
    color: white;
  }
  
  .fc-event.blocked {
    background-color: #673AB7;
    border-color: #673AB7;
    color: white;
  }
  
  /* Action Buttons */
  .appointment-pilarease-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 25px;
  }
  
  .appointment-pilarease-actions button {
    border-radius: 8px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
  }
  
  .appointment-pilarease-actions button i {
    font-size: 1.2rem;
  }
  
  .appointment-pilarease-actions button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  /* Time Slots */
  .appointment-pilarease-time-slots {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 15px;
    max-height: 220px;
    overflow-y: auto;
    padding: 5px;
  }
  
  .appointment-pilarease-time-slot {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
  }
  
  .appointment-pilarease-time-slot:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }
  
  .appointment-pilarease-time-slot.selected {
    background-color: #4CAF50;
    color: white;
    border-color: #4CAF50;
    font-weight: 500;
  }
  
  .appointment-pilarease-time-slot.unavailable {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
    cursor: not-allowed;
    opacity: 0.7;
  }
  
  /* Custom FullCalendar Styling */
  .fc-theme-standard .fc-scrollgrid {
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e9ecef;
  }
  
  .fc-theme-standard th {
    background-color: #f8f9fa;
    padding: 12px 0;
  }
  
  .fc .fc-col-header-cell-cushion {
    padding: 8px 4px;
    color: #555;
    font-weight: 600;
  }
  
  .fc .fc-daygrid-day-number {
    padding: 8px;
    color: #333;
  }
  
  /* Dashboard cards */
  .dashboard-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }
  
  .summary-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    padding: 20px;
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }
  
  .summary-card h3 {
    font-size: 1rem;
    color: #555;
    margin-bottom: 10px;
    font-weight: 500;
  }
  
  .summary-card p {
    font-size: 2rem;
    font-weight: 700;
    color: #3F51B5;
    margin: 0;
  }
  
  /* Loading indicator & notifications */
  .loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 15px;
    z-index: 9999;
  }
  
  .loading-spinner i {
    font-size: 3rem;
    color: #3F51B5;
  }
  
  .loading-spinner span {
    font-size: 1rem;
    color: #333;
  }
  
  .spin {
    animation: spin 1.5s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .pilarease-admin-notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 300px;
  }
  
  .pilarease-admin-notification {
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: flex-start;
    gap: 10px;
    animation: slideIn 0.3s ease;
  }
  
  .pilarease-admin-notification.success {
    background-color: #e8f5e9;
    border-left: 4px solid #4caf50;
  }
  
  .pilarease-admin-notification.error {
    background-color: #ffebee;
    border-left: 4px solid #f44336;
  }
  
  .pilarease-admin-notification i {
    font-size: 1.2rem;
  }
  
  .pilarease-admin-notification.success i {
    color: #4caf50;
  }
  
  .pilarease-admin-notification.error i {
    color: #f44336;
  }
  
  .pilarease-admin-notification .close-btn {
    margin-left: auto;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    color: #555;
  }
  
  .pilarease-admin-notification.fade-out {
    animation: fadeOut 0.5s ease forwards;
  }
  
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
</style>


<!-- Dashboard Summary Cards -->
<div class="dashboard-summary appointment-pilarease-summary">
  <div class="summary-card appointment-pilarease-card">
    <h3>Total Appointments</h3>
    <p>{{ total_appointments }}</p>
  </div>
  <div class="summary-card appointment-pilarease-card">
    <h3>Pending Requests</h3>
    <p>{{ pending_appointments }}</p>
  </div>
  <div class="summary-card appointment-pilarease-card">
    <h3>Available Slots</h3>
    <p>{{ available_slots }}</p>
  </div>
  <div class="summary-card appointment-pilarease-card">
    <h3>Blocked Slots</h3>
    <p>{{ blocked_slots_count }}</p>
  </div>
</div>

<div class="appointment-pilarease-actions">
  <button class="pilarease-admin-action-button export-button" id="blockTimeBtn">
    <i class="bx bx-time"></i> Block Time Slot
  </button>
  <button class="pilarease-admin-action-button approve-button" id="createAppointmentBtn">
    <i class="bx bx-calendar-plus"></i> Create Appointment
  </button>
  <button class="pilarease-admin-action-button" id="setAvailabilityBtn">
    <i class="bx bx-calendar-check"></i> Set Regular Availability
  </button>
  <button class="pilarease-admin-action-button export-button" id="refreshCalendarBtn">
    <i class="bx bx-refresh"></i> Refresh Calendar
  </button>
</div>

<div class="appointment-pilarease-calendar-container">
  <div class="appointment-pilarease-calendar-header">
    <h2 class="appointment-pilarease-calendar-title">
      <i class="bx bx-calendar"></i> Appointment Calendar
    </h2>
    <div class="appointment-pilarease-calendar-controls">
      <button class="pilarease-admin-filter-button" id="today-btn">Today</button>
      <button class="pilarease-admin-filter-button" id="month-btn">Month</button>
      <button class="pilarease-admin-filter-button" id="week-btn">Week</button>
      <button class="pilarease-admin-filter-button" id="day-btn">Day</button>
    </div>
  </div>
  
  <div id="calendar"></div>

  <div class="appointment-pilarease-legend">
    <div class="appointment-pilarease-legend-item">
      <div class="appointment-pilarease-legend-color" style="background-color: #FFC107;"></div>
      <span>Pending</span>
    </div>
    <div class="appointment-pilarease-legend-item">
      <div class="appointment-pilarease-legend-color" style="background-color: #4CAF50;"></div>
      <span>Approved</span>
    </div>
    <div class="appointment-pilarease-legend-item">
      <div class="appointment-pilarease-legend-color" style="background-color: #2196F3;"></div>
      <span>Completed</span>
    </div>
    <div class="appointment-pilarease-legend-item">
      <div class="appointment-pilarease-legend-color" style="background-color: #F44336;"></div>
      <span>Rejected</span>
    </div>
    <div class="appointment-pilarease-legend-item">
      <div class="appointment-pilarease-legend-color" style="background-color: #9E9E9E;"></div>
      <span>Cancelled</span>
    </div>
    <div class="appointment-pilarease-legend-item">
      <div class="appointment-pilarease-legend-color" style="background-color: #673AB7;"></div>
      <span>Blocked Time</span>
    </div>
  </div>
</div>

<!-- Block Time Modal -->
<div class="pilarease-admin-modal" id="blockTimeModal">
  <div class="pilarease-admin-modal-content">
    <span class="pilarease-admin-close">&times;</span>
    <div class="pilarease-admin-modal-header">
      <h2><i class="bx bx-time"></i> Block Time Slot</h2>
    </div>
    <div class="pilarease-admin-modal-body">
      <form id="blockTimeForm" method="post" action="{% url 'appointment:add_blocked_slot' %}">
        {% csrf_token %}
        <div class="pilarease-admin-form-group">
          <label for="block_date">Date:</label>
          <input type="date" id="block_date" name="date" class="pilarease-admin-form-input" required>
        </div>
        
        <div class="pilarease-admin-form-group">
          <label for="block_start_time">Start Time:</label>
          <input type="time" id="block_start_time" name="start_time" class="pilarease-admin-form-input" required>
        </div>
        
        <div class="pilarease-admin-form-group">
          <label for="block_end_time">End Time:</label>
          <input type="time" id="block_end_time" name="end_time" class="pilarease-admin-form-input" required>
        </div>
      
        <div class="pilarease-admin-form-group">
          <label for="block_reason">Reason:</label>
          <textarea id="block_reason" name="reason" rows="3" class="pilarease-admin-form-input" required></textarea>
        </div>
      </form>
    </div>
    <div class="pilarease-admin-modal-footer">
      <button type="button" class="pilarease-admin-button" id="closeBlockModalBtn">Cancel</button>
      <button type="button" class="pilarease-admin-action-button approve-button" id="saveBlockBtn">
        <i class="bx bx-save"></i> Save
      </button>
    </div>
  </div>
</div>

<!-- Set Regular Availability Modal -->
<div class="pilarease-admin-modal" id="availabilityModal">
  <div class="pilarease-admin-modal-content">
    <span class="pilarease-admin-close">&times;</span>
    <div class="pilarease-admin-modal-header">
      <h2><i class="bx bx-calendar-check"></i> Set Regular Availability</h2>
    </div>
    <div class="pilarease-admin-modal-body">
      <form id="availabilityForm" method="post" action="{% url 'appointment:add_available_schedule' %}">
        {% csrf_token %}
        <div class="pilarease-admin-form-group">
          <label for="day_of_week">Day of Week:</label>
          <select id="day_of_week" name="day_of_week" class="pilarease-admin-form-select" required>
            <option value="0">Monday</option>
            <option value="1">Tuesday</option>
            <option value="2">Wednesday</option>
            <option value="3">Thursday</option>
            <option value="4">Friday</option>
            <option value="5">Saturday</option>
            <option value="6">Sunday</option>
          </select>
        </div>
        
        <div class="pilarease-admin-form-group">
          <label for="availability_start_time">Start Time:</label>
          <input type="time" id="availability_start_time" name="start_time" class="pilarease-admin-form-input" required>
        </div>
        
        <div class="pilarease-admin-form-group">
          <label for="availability_end_time">End Time:</label>
          <input type="time" id="availability_end_time" name="end_time" class="pilarease-admin-form-input" required>
        </div>
      </form>
    </div>
    <div class="pilarease-admin-modal-footer">
      <button type="button" class="pilarease-admin-button" id="closeAvailabilityModalBtn">Cancel</button>
      <button type="button" class="pilarease-admin-action-button approve-button" id="saveAvailabilityBtn">
        <i class="bx bx-save"></i> Save
      </button>
    </div>
  </div>
</div>
      
<!-- Create Appointment Modal -->
<div class="pilarease-admin-modal" id="createAppointmentModal">
  <div class="pilarease-admin-modal-content">
    <span class="pilarease-admin-close">&times;</span>
    <div class="pilarease-admin-modal-header">
      <h2><i class="bx bx-calendar-plus"></i> Create Appointment</h2>
    </div>
    <div class="pilarease-admin-modal-body">
      <form id="createAppointmentForm" method="post" action="{% url 'appointment:create_appointment' %}">
        {% csrf_token %}
        <div class="pilarease-admin-form-group">
          <label for="appointment_title">Title:</label>
          <input type="text" id="appointment_title" name="title" class="pilarease-admin-form-input" required>
        </div>
        
        <div class="pilarease-admin-form-group">
          <label for="appointment_user">User:</label>
          <select id="appointment_user" name="user" class="pilarease-admin-form-select" required>
            <option value="">Select User</option>
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.full_name }}</option>
            {% endfor %}
          </select>
        </div>
          
        <div class="pilarease-admin-form-group">
          <label for="appointment_date">Date:</label>
          <input type="date" id="appointment_date" name="date" class="pilarease-admin-form-input" required>
        </div>
          
        <div class="pilarease-admin-form-group">
          <label>Available Time Slots:</label>
          <div class="appointment-pilarease-time-slots" id="timeSlots">
            <!-- Time slots will be dynamically populated -->
            <div class="appointment-pilarease-time-slot">
              <span>Loading time slots...</span>
            </div>
          </div>
          <input type="hidden" id="appointment_start_time" name="start_time" required>
          <input type="hidden" id="appointment_end_time" name="end_time" required>
        </div>
          
        <div class="pilarease-admin-form-group">
          <label for="appointment_description">Description:</label>
          <textarea id="appointment_description" name="description" rows="3" class="pilarease-admin-form-input" required></textarea>
        </div>
      
        <div class="pilarease-admin-form-group">
          <label for="appointment_status">Status:</label>
          <select id="appointment_status" name="status" class="pilarease-admin-form-select" required>
            <option value="pending">Pending</option>
            <option value="approved" selected>Approved</option>
          </select>
        </div>
        
        <input type="hidden" name="counselor" value="{{ request.user.id }}">
      </form>
    </div>
    <div class="pilarease-admin-modal-footer">
      <button type="button" class="pilarease-admin-button" id="closeAppointmentModalBtn">Cancel</button>
      <button type="button" class="pilarease-admin-action-button approve-button" id="saveAppointmentBtn">
        <i class="bx bx-save"></i> Save
      </button>
    </div>
  </div>
</div>

<!-- Event Details Modal -->
<div class="pilarease-admin-modal" id="eventDetailModal">
  <div class="pilarease-admin-modal-content">
    <span class="pilarease-admin-close">&times;</span>
    <div class="pilarease-admin-modal-header">
      <h2 id="eventTitle"><i class="bx bx-calendar-event"></i> Event Details</h2>
    </div>
    <div class="pilarease-admin-modal-body" id="eventDetailContent">
      <!-- Event details will be loaded here dynamically -->
    </div>
    <div class="pilarease-admin-modal-footer">
      <button type="button" class="pilarease-admin-button" id="closeEventModalBtn">Close</button>
      <div id="eventActions"></div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Calendar with modern options
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      },
      dayMaxEvents: true,
      events: '{% url "appointment:calendar_events" %}',
      eventClassNames: function(arg) {
        return [arg.event.extendedProps.status];
      },
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        meridiem: false,
        hour12: false
      },
      firstDay: 1, // Monday as first day
      height: 'auto',
      aspectRatio: 1.8,
      nowIndicator: true,
      navLinks: true,
      businessHours: {
        daysOfWeek: [1, 2, 3, 4, 5], // Monday - Friday
        startTime: '09:00',
        endTime: '17:00',
      },
      slotDuration: '00:30:00',
      slotLabelInterval: '01:00:00',
      eventDidMount: function(info) {
        // Add status class to the event
        const eventEl = info.el;
        const status = info.event.extendedProps.status || 'pending';
        eventEl.classList.add(status);
        
        // Add tooltip with event details
        const tooltip = document.createElement('div');
        tooltip.className = 'event-tooltip';
        tooltip.innerHTML = `
          <strong>${info.event.title}</strong><br>
          ${info.event.start ? new Date(info.event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''} 
          ${info.event.end ? '- ' + new Date(info.event.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
        `;
        
        // Only show tooltip on hover
        eventEl.addEventListener('mouseover', function() {
          document.body.appendChild(tooltip);
          const rect = eventEl.getBoundingClientRect();
          tooltip.style.position = 'absolute';
          tooltip.style.top = (rect.bottom + window.scrollY + 5) + 'px';
          tooltip.style.left = (rect.left + window.scrollX) + 'px';
          tooltip.style.zIndex = 10000;
          tooltip.style.backgroundColor = 'white';
          tooltip.style.padding = '5px 10px';
          tooltip.style.borderRadius = '4px';
          tooltip.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
          tooltip.style.fontSize = '12px';
        });
        
        eventEl.addEventListener('mouseout', function() {
          if (document.body.contains(tooltip)) {
            document.body.removeChild(tooltip);
          }
        });
      },
      eventClick: function(info) {
        showEventDetails(info.event);
      },
      dateClick: function(info) {
        // Set the date in the create appointment modal
        document.getElementById('appointment_date').value = info.dateStr;
        loadTimeSlots(info.dateStr);
        
        // Open create appointment modal
        document.getElementById('createAppointmentModal').style.display = 'block';
      },
      datesSet: function(dateInfo) {
        // Update the calendar whenever the view changes (e.g., month/week/day changes)
        // This is a good place to fetch updated data if needed
      }
    });
    
    calendar.render();
    
    // Calendar Navigation Buttons
    document.getElementById('today-btn').addEventListener('click', function() {
      calendar.today();
    });
    
    document.getElementById('month-btn').addEventListener('click', function() {
      calendar.changeView('dayGridMonth');
    });
    
    document.getElementById('week-btn').addEventListener('click', function() {
      calendar.changeView('timeGridWeek');
    });
    
    document.getElementById('day-btn').addEventListener('click', function() {
      calendar.changeView('timeGridDay');
    });
    
    // Refresh calendar button
    document.getElementById('refreshCalendarBtn').addEventListener('click', function() {
      calendar.refetchEvents();
      showNotification('success', 'Calendar refreshed');
    });
    
    // Block Time Modal
    const blockTimeBtn = document.getElementById('blockTimeBtn');
    const blockTimeModal = document.getElementById('blockTimeModal');
    const closeBlockModalBtn = document.getElementById('closeBlockModalBtn');
    const saveBlockBtn = document.getElementById('saveBlockBtn');
    
    blockTimeBtn.addEventListener('click', function() {
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('block_date').value = today;
      document.getElementById('block_start_time').value = '09:00';
      document.getElementById('block_end_time').value = '10:00';
      
      // Show modal
      blockTimeModal.style.display = 'block';
    });
    
    closeBlockModalBtn.addEventListener('click', function() {
      blockTimeModal.style.display = 'none';
    });
    
    saveBlockBtn.addEventListener('click', function() {
      const form = document.getElementById('blockTimeForm');
      
      // Form validation
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Show loading indicator
      showLoadingIndicator();
      
      // Submit form via AJAX
      const formData = new FormData(form);
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        hideLoadingIndicator();
        
        if (data.success) {
          showNotification('success', 'Time slot blocked successfully');
          blockTimeModal.style.display = 'none';
          form.reset();
          calendar.refetchEvents();
        } else {
          showNotification('error', data.message || 'Failed to block time slot');
        }
      })
      .catch(error => {
        hideLoadingIndicator();
        showNotification('error', 'An error occurred. Please try again.');
        console.error('Error blocking time slot:', error);
      });
    });
    
    // Set Availability Modal
    const setAvailabilityBtn = document.getElementById('setAvailabilityBtn');
    const availabilityModal = document.getElementById('availabilityModal');
    const closeAvailabilityModalBtn = document.getElementById('closeAvailabilityModalBtn');
    const saveAvailabilityBtn = document.getElementById('saveAvailabilityBtn');
    
    setAvailabilityBtn.addEventListener('click', function() {
      // Set default start/end times
      document.getElementById('availability_start_time').value = '09:00';
      document.getElementById('availability_end_time').value = '17:00';
      
      // Show modal
      availabilityModal.style.display = 'block';
    });
    
    closeAvailabilityModalBtn.addEventListener('click', function() {
      availabilityModal.style.display = 'none';
    });
    
    saveAvailabilityBtn.addEventListener('click', function() {
      const form = document.getElementById('availabilityForm');
      
      // Form validation
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Show loading indicator
      showLoadingIndicator();
      
      // Submit form via AJAX
      const formData = new FormData(form);
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.message || `Server returned ${response.status}: ${response.statusText}`);
          }).catch(e => {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          });
        }
        return response.json();
      })
      .then(data => {
        hideLoadingIndicator();
        
        if (data.success) {
          showNotification('success', 'Regular availability set successfully');
          availabilityModal.style.display = 'none';
          form.reset();
          calendar.refetchEvents();
        } else {
          showNotification('error', data.message || 'Failed to set availability');
          console.error('Error details:', data);
        }
      })
      .catch(error => {
        hideLoadingIndicator();
        showNotification('error', `An error occurred: ${error.message}`);
        console.error('Error setting availability:', error);
      });
    });
    
    // Create Appointment Modal
    const createAppointmentBtn = document.getElementById('createAppointmentBtn');
    const createAppointmentModal = document.getElementById('createAppointmentModal');
    const closeAppointmentModalBtn = document.getElementById('closeAppointmentModalBtn');
    const saveAppointmentBtn = document.getElementById('saveAppointmentBtn');
    const appointmentDateInput = document.getElementById('appointment_date');
    
    createAppointmentBtn.addEventListener('click', function() {
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      appointmentDateInput.value = today;
      
      // Load time slots for today
      loadTimeSlots(today);
      
      // Show modal
      createAppointmentModal.style.display = 'block';
    });
    
    closeAppointmentModalBtn.addEventListener('click', function() {
      createAppointmentModal.style.display = 'none';
    });
    
    saveAppointmentBtn.addEventListener('click', function() {
      const form = document.getElementById('createAppointmentForm');
      
      // Additional validation for time slot selection
      if (!document.getElementById('appointment_start_time').value || 
          !document.getElementById('appointment_end_time').value) {
        showNotification('error', 'Please select an available time slot');
        return;
      }
      
      // Form validation
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Submit form using AJAX
      submitAppointmentForm(form);
    });
    
    // Load time slots when date changes
    appointmentDateInput.addEventListener('change', function() {
      loadTimeSlots(this.value);
    });
    
    // Event Details Modal
    const eventDetailModal = document.getElementById('eventDetailModal');
    const closeEventModalBtn = document.getElementById('closeEventModalBtn');
    
    closeEventModalBtn.addEventListener('click', function() {
      eventDetailModal.style.display = 'none';
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target === blockTimeModal) {
        blockTimeModal.style.display = 'none';
      }
      
      if (event.target === availabilityModal) {
        availabilityModal.style.display = 'none';
      }
      
      if (event.target === createAppointmentModal) {
        createAppointmentModal.style.display = 'none';
      }
      
      if (event.target === eventDetailModal) {
        eventDetailModal.style.display = 'none';
      }
    });
    
    // Close modals when clicking on X
    document.querySelectorAll('.pilarease-admin-close').forEach(function(closeBtn) {
      closeBtn.addEventListener('click', function() {
        this.closest('.pilarease-admin-modal').style.display = 'none';
      });
    });
    
    // Function to load time slots
    function loadTimeSlots(date) {
      const timeSlotsContainer = document.getElementById('timeSlots');
      
      // Show loading
      timeSlotsContainer.innerHTML = '<div class="appointment-pilarease-time-slot"><span>Loading time slots...</span></div>';
      
      // Call API to get available time slots - with the corrected URL
      fetch(`/appointment/api/available-slots/?date=${date}`)
        .then(response => {
          // Log the response status for debugging
          console.log(`Time slots fetch status: ${response.status} ${response.statusText}`);
          
          if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Time slots data:", data); // Log the data for debugging
          timeSlotsContainer.innerHTML = '';
          
          // Handle different response formats - either an array or {slots: [...]}
          const slots = Array.isArray(data) ? data : (data.slots || []);
          
          if (slots.length === 0) {
            timeSlotsContainer.innerHTML = '<div class="appointment-pilarease-time-slot unavailable"><span>No available time slots for this date.</span></div>';
            return;
          }
          
          // Generate time slots
          slots.forEach(slot => {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'appointment-pilarease-time-slot';
            
            if (!slot.available) {
              timeSlot.className += ' unavailable';
            }
            
            timeSlot.innerHTML = `<span>${slot.start_time} - ${slot.end_time}</span>`;
            
            // Add click event to select time slot
            if (slot.available) {
              timeSlot.addEventListener('click', function() {
                // Remove selected class from all slots
                document.querySelectorAll('.appointment-pilarease-time-slot').forEach(s => {
                  s.classList.remove('selected');
                });
                
                // Add selected class to this slot
                this.classList.add('selected');
                
                // Set the start and end time values in hidden inputs
                document.getElementById('appointment_start_time').value = slot.start_time;
                document.getElementById('appointment_end_time').value = slot.end_time;
              });
            }
            
            timeSlotsContainer.appendChild(timeSlot);
          });
        })
        .catch(error => {
          console.error('Error loading time slots:', error);
          timeSlotsContainer.innerHTML = `<div class="appointment-pilarease-time-slot unavailable"><span>Error loading time slots: ${error.message}</span></div>`;
        });
    }
    
    // Function to submit appointment form via AJAX
    function submitAppointmentForm(form) {
      // Get CSRF token
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      // Create FormData object
      const formData = new FormData(form);
      
      // Show loading indicator
      showLoadingIndicator();
      
      // Submit form via AJAX
      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading indicator
        hideLoadingIndicator();
        
        if (data.success) {
          // Show success message
          showNotification('success', data.message || 'Appointment created successfully!');
          
          // Close modal
          createAppointmentModal.style.display = 'none';
          
          // Refresh calendar to show the new appointment
          calendar.refetchEvents();
          
          // Reset form
          form.reset();
        } else {
          // Show error message
          showNotification('error', data.message || 'Failed to create appointment.');
        }
      })
      .catch(error => {
        // Hide loading indicator
        hideLoadingIndicator();
        
        // Show error message
        showNotification('error', 'An error occurred. Please try again.');
        console.error('Error creating appointment:', error);
      });
    }
    
    // Function to show event details
    function showEventDetails(event) {
      const eventId = event.id;
      const eventType = event.extendedProps.type || 'appointment';
      const eventTitle = document.getElementById('eventTitle');
      const eventDetailContent = document.getElementById('eventDetailContent');
      const eventActions = document.getElementById('eventActions');
      
      // Set loading state
      eventDetailContent.innerHTML = `
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
      `;
      
      // Clear actions
      eventActions.innerHTML = '';
      
      // Show modal
      eventDetailModal.style.display = 'block';
      
      if (eventType === 'appointment') {
        // Fetch event details
        fetch(`/appointment/appointment/${eventId}/`)
          .then(response => response.json())
          .then(data => {
            // Set title with appropriate icon
            eventTitle.innerHTML = `<i class="bx bx-calendar-check"></i> Appointment Details`;
            
            // Create content from event data
            eventDetailContent.innerHTML = `
              <div class="appointment-pilarease-detail">
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">Title:</div>
                  <div class="appointment-pilarease-detail-value">${data.title}</div>
                </div>
                
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">Date:</div>
                  <div class="appointment-pilarease-detail-value">${data.date}</div>
                </div>
                
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">Time:</div>
                  <div class="appointment-pilarease-detail-value">${data.start_time} - ${data.end_time}</div>
                </div>
                
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">Status:</div>
                  <div class="appointment-pilarease-detail-value">
                    <span class="pilarease-admin-status-label ${data.status}">
                      ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}
                    </span>
                  </div>
                </div>
                
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">User:</div>
                  <div class="appointment-pilarease-detail-value">${data.user.full_name}</div>
                </div>
                
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">Contact:</div>
                  <div class="appointment-pilarease-detail-value">${data.user.contact_number || 'Not provided'}</div>
                </div>
                
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">Email:</div>
                  <div class="appointment-pilarease-detail-value">${data.user.email || 'Not provided'}</div>
                </div>
                
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">Description:</div>
                  <div class="appointment-pilarease-detail-value">${data.description}</div>
                </div>
                
                ${data.counselor_notes ? `
                <div class="appointment-pilarease-detail-row">
                  <div class="appointment-pilarease-detail-label">Notes:</div>
                  <div class="appointment-pilarease-detail-value">${data.counselor_notes}</div>
                </div>
                ` : ''}
              </div>
            `;
            
            // Add actions based on status
            if (data.status === 'pending') {
              eventActions.innerHTML = `
                <form method="post" action="/appointment/appointment/${eventId}/update-status/" style="display: inline-block;">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                  <input type="hidden" name="status" value="approved">
                  <input type="hidden" name="next" value="${window.location.pathname}">
                  <button type="submit" class="pilarease-admin-action-button approve-button">
                    <i class="bx bx-check"></i> Approve
                  </button>
                </form>
                <form method="post" action="/appointment/appointment/${eventId}/update-status/" style="display: inline-block;">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                  <input type="hidden" name="status" value="rejected">
                  <input type="hidden" name="next" value="${window.location.pathname}">
                  <button type="submit" class="pilarease-admin-action-button delete-button">
                    <i class="bx bx-x"></i> Reject
                  </button>
                </form>
              `;
            } else if (data.status === 'approved') {
              eventActions.innerHTML = `
                <form method="post" action="/appointment/appointment/${eventId}/update-status/" style="display: inline-block;">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                  <input type="hidden" name="status" value="completed">
                  <input type="hidden" name="next" value="${window.location.pathname}">
                  <button type="submit" class="pilarease-admin-action-button approve-button">
                    <i class="bx bx-check-double"></i> Mark Complete
                  </button>
                </form>
                <form method="post" action="/appointment/appointment/${eventId}/update-status/" style="display: inline-block;">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                  <input type="hidden" name="status" value="cancelled">
                  <input type="hidden" name="next" value="${window.location.pathname}">
                  <button type="submit" class="pilarease-admin-action-button delete-button">
                    <i class="bx bx-x"></i> Cancel
                  </button>
                </form>
              `;
            }
            
            // Always add edit button
            eventActions.innerHTML += `
              <a href="/appointment/appointment/${eventId}/edit/" class="pilarease-admin-action-button export-button">
                <i class="bx bx-edit"></i> Edit
              </a>
            `;
          })
          .catch(error => {
            console.error('Error loading appointment details:', error);
            eventDetailContent.innerHTML = `
              <div class="error-message">
                <i class="bx bx-error-circle"></i>
                <p>Error loading appointment details. Please try again.</p>
              </div>
            `;
          });
      } else if (eventType === 'blocked') {
        // Set title with appropriate icon
        eventTitle.innerHTML = `<i class="bx bx-time-five"></i> Blocked Time Slot`;
        
        // Create content from event data
        eventDetailContent.innerHTML = `
          <div class="appointment-pilarease-detail">
            <div class="appointment-pilarease-detail-row">
              <div class="appointment-pilarease-detail-label">Date:</div>
              <div class="appointment-pilarease-detail-value">${new Date(event.start).toLocaleDateString()}</div>
            </div>
            
            <div class="appointment-pilarease-detail-row">
              <div class="appointment-pilarease-detail-label">Time:</div>
              <div class="appointment-pilarease-detail-value">
                ${new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - 
                ${new Date(event.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
              </div>
            </div>
            
            <div class="appointment-pilarease-detail-row">
              <div class="appointment-pilarease-detail-label">Reason:</div>
              <div class="appointment-pilarease-detail-value">${event.title.replace('Blocked: ', '')}</div>
            </div>
          </div>
        `;
        
        // Add remove action
        eventActions.innerHTML = `
          <form method="post" action="/appointment/calendar/block/${eventId}/remove/" style="display: inline-block;">
            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
            <button type="submit" class="pilarease-admin-action-button delete-button">
              <i class="bx bx-trash"></i> Remove
            </button>
          </form>
        `;
      }
    }
    
    // Helper functions
    function showLoadingIndicator() {
      if (!document.getElementById('loadingSpinner')) {
        const spinnerHtml = `
          <div id="loadingSpinner" class="loading-spinner">
            <i class="bx bx-loader-alt spin"></i>
            <span>Processing...</span>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', spinnerHtml);
      }
      
      document.getElementById('loadingSpinner').style.display = 'flex';
    }
    
    function hideLoadingIndicator() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = 'none';
      }
    }
    
    function showNotification(type, message) {
      // Create notification container if it doesn't exist
      let notificationsContainer = document.querySelector('.pilarease-admin-notifications');
      if (!notificationsContainer) {
        notificationsContainer = document.createElement('div');
        notificationsContainer.className = 'pilarease-admin-notifications';
        document.body.appendChild(notificationsContainer);
      }
      
      // Create notification element
      const notificationId = 'notification-' + Date.now();
      const notificationHtml = `
        <div id="${notificationId}" class="pilarease-admin-notification ${type}">
          <i class="bx ${type === 'success' ? 'bx-check-circle' : 'bx-error-circle'}"></i>
          <span>${message}</span>
          <button class="close-btn">&times;</button>
        </div>
      `;
      
      notificationsContainer.insertAdjacentHTML('beforeend', notificationHtml);
      
      // Add close button event
      const notification = document.getElementById(notificationId);
      notification.querySelector('.close-btn').addEventListener('click', function() {
        notification.classList.add('fade-out');
        setTimeout(() => {
          if (notification && notification.parentNode) {
            notification.remove();
          }
        }, 500);
      });
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification && notification.parentNode) {
          notification.classList.add('fade-out');
          setTimeout(() => {
            if (notification && notification.parentNode) {
              notification.remove();
            }
          }, 500);
        }
      }, 5000);
    }
  });
</script>
{% endblock %}

