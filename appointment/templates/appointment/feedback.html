{% extends 'appointment/base_appointment.html' %}
{% load static %}

{% block page_title %}Appointment Feedback{% endblock %}
{% block content_title %}Appointment Feedback{% endblock %}

{% block appointment_content %}
<div class="pilarease-admin-filter-form appointment-pilarease-filter">
  <form method="get" action="{% url 'appointment:feedback' %}">
    <div class="pilarease-admin-filter-group">
      <label for="rating" class="pilarease-admin-filter-label">Filter by Rating:</label>
      <select name="rating" id="rating" class="pilarease-admin-filter-select">
        <option value="">All Ratings</option>
        <option value="5" {% if request.GET.rating == '5' %}selected{% endif %}>5 Stars</option>
        <option value="4" {% if request.GET.rating == '4' %}selected{% endif %}>4 Stars</option>
        <option value="3" {% if request.GET.rating == '3' %}selected{% endif %}>3 Stars</option>
        <option value="2" {% if request.GET.rating == '2' %}selected{% endif %}>2 Stars</option>
        <option value="1" {% if request.GET.rating == '1' %}selected{% endif %}>1 Star</option>
      </select>
    </div>
    
    <div class="pilarease-admin-filter-group">
      <label for="search" class="pilarease-admin-filter-label">Search:</label>
      <input type="text" name="search" id="search" class="pilarease-admin-filter-input" placeholder="Search in comments..." value="{{ request.GET.search }}">
    </div>
    
    <div class="pilarease-admin-filter-buttons">
      <button type="submit" class="pilarease-admin-filter-button">Apply Filters</button>
      <a href="{% url 'appointment:feedback' %}" class="pilarease-admin-reset-button">Reset</a>
    </div>
  </form>
</div>

<!-- Feedback Statistics -->
<div class="pilarease-admin-statistics-cards appointment-pilarease-stats">
  <div class="pilarease-admin-statistics-card">
    <div class="pilarease-admin-statistics-card-content">
      <div class="pilarease-admin-statistics-card-icon">
        <i class="bx bx-star"></i>
      </div>
      <div class="pilarease-admin-statistics-card-info">
        <span>{{ average_rating|floatformat:1 }}</span>
        <p>Average Rating</p>
      </div>
    </div>
  </div>
  
  <div class="pilarease-admin-statistics-card">
    <div class="pilarease-admin-statistics-card-content">
      <div class="pilarease-admin-statistics-card-icon">
        <i class="bx bx-message-square-detail"></i>
      </div>
      <div class="pilarease-admin-statistics-card-info">
        <span>{{ feedback_count }}</span>
        <p>Total Feedback</p>
      </div>
    </div>
  </div>
  
  <div class="pilarease-admin-statistics-card">
    <div class="pilarease-admin-statistics-card-content">
      <div class="pilarease-admin-statistics-card-icon">
        <i class="bx bx-happy"></i>
      </div>
      <div class="pilarease-admin-statistics-card-info">
        <span>{{ positive_percentage }}%</span>
        <p>Positive Feedback</p>
      </div>
    </div>
  </div>
  
  <div class="pilarease-admin-statistics-card">
    <div class="pilarease-admin-statistics-card-content">
      <div class="pilarease-admin-statistics-card-icon">
        <i class="bx bx-sad"></i>
      </div>
      <div class="pilarease-admin-statistics-card-info">
        <span>{{ negative_percentage }}%</span>
        <p>Needs Improvement</p>
      </div>
    </div>
  </div>
</div>

<!-- Feedback Table -->
<div class="pilarease-admin-data-table-container appointment-pilarease-feedback-container">
  <h2 class="pilarease-admin-section-title">
    Appointment Feedback
    <i class="bx bx-info-circle pilarease-admin-info-icon"></i>
    <span class="pilarease-admin-tooltip">
      User submitted feedback for appointments
    </span>
  </h2>
  
  {% if feedback_list %}
    <table class="pilarease-admin-data-table appointment-pilarease-feedback-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>User</th>
          <th>Appointment</th>
          <th>Rating</th>
          <th>Comment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for feedback in feedback_list %}
          <tr>
            <td>{{ feedback.created_at|date:"M d, Y" }}</td>
            <td>{{ feedback.appointment.user.full_name }}</td>
            <td>{{ feedback.appointment.title }}</td>
            <td>
              <div class="appointment-pilarease-rating">
                {% for i in "12345" %}
                  {% if forloop.counter <= feedback.rating %}
                    <i class="bx bxs-star" style="color: #FFC107;"></i>
                  {% else %}
                    <i class="bx bx-star" style="color: #9e9e9e;"></i>
                  {% endif %}
                {% endfor %}
              </div>
            </td>
            <td>{{ feedback.comment|truncatechars:50 }}</td>
            <td>
              <button type="button" class="pilarease-admin-action-button view-button" data-feedback-id="{{ feedback.id }}">
                <i class="bx bx-detail"></i> View
              </button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    
    <!-- Pagination -->
    {% if feedback_list.has_other_pages %}
      <div class="pilarease-admin-pagination">
        <div class="pilarease-admin-step-links">
          {% if feedback_list.has_previous %}
            <a href="?page={{ feedback_list.previous_page_number }}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="pilarease-admin-step-link">Previous</a>
          {% else %}
            <span class="pilarease-admin-step-link disabled">Previous</span>
          {% endif %}
          
          <span class="pilarease-admin-current">
            Page {{ feedback_list.number }} of {{ feedback_list.paginator.num_pages }}
          </span>
          
          {% if feedback_list.has_next %}
            <a href="?page={{ feedback_list.next_page_number }}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="pilarease-admin-step-link">Next</a>
          {% else %}
            <span class="pilarease-admin-step-link disabled">Next</span>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="pilarease-admin-no-data">
      <i class="bx bx-info-circle"></i> No feedback found.
    </div>
  {% endif %}
</div>

<!-- Feedback Detail Modal -->
<div class="pilarease-admin-modal" id="feedbackDetailModal">
  <div class="pilarease-admin-modal-content">
    <span class="pilarease-admin-close">&times;</span>
    <div class="pilarease-admin-modal-header">
      <h2>Feedback Details</h2>
    </div>
    <div class="pilarease-admin-modal-body" id="feedbackDetailContent">
      <!-- Feedback details will be loaded here via AJAX -->
      <div class="text-center">
        <div class="spinner-border" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
    </div>
    <div class="pilarease-admin-modal-footer">
      <button type="button" class="pilarease-admin-button" id="closeFeedbackModalBtn">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // View Feedback Details
    const viewButtons = document.querySelectorAll('.view-button');
    viewButtons.forEach(button => {
      button.addEventListener('click', function() {
        const feedbackId = this.getAttribute('data-feedback-id');
        loadFeedbackDetails(feedbackId);
      });
    });
    
    // Close modal functionality
    const closeModal = document.querySelector('.pilarease-admin-close');
    const closeBtn = document.getElementById('closeFeedbackModalBtn');
    const modal = document.getElementById('feedbackDetailModal');
    
    closeModal.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    closeBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
    
    // Function to load feedback details via AJAX
    function loadFeedbackDetails(feedbackId) {
      // Set loading state
      document.getElementById('feedbackDetailContent').innerHTML = `
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
      `;
      
      // Show modal
      document.getElementById('feedbackDetailModal').style.display = 'block';
      
      // Fetch feedback details
      fetch(`/appointment/feedback/${feedbackId}/`)
        .then(response => response.json())
        .then(data => {
          // Create rating stars
          let ratingStars = '';
          for (let i = 1; i <= 5; i++) {
            if (i <= data.rating) {
              ratingStars += '<i class="bx bxs-star" style="color: #FFC107;"></i>';
            } else {
              ratingStars += '<i class="bx bx-star" style="color: #9e9e9e;"></i>';
            }
          }
          
          // Update modal content
          document.getElementById('feedbackDetailContent').innerHTML = `
            <div class="appointment-pilarease-feedback-detail">
              <h3>${data.appointment.title}</h3>
              <p><strong>Date:</strong> ${data.created_at}</p>
              <p><strong>User:</strong> ${data.appointment.user.full_name}</p>
              <p><strong>Rating:</strong> <span class="appointment-pilarease-rating">${ratingStars}</span></p>
              <p><strong>Comment:</strong></p>
              <div class="appointment-pilarease-feedback-comment">
                ${data.comment}
              </div>
            </div>
          `;
        })
        .catch(error => {
          console.error('Error loading feedback details:', error);
          document.getElementById('feedbackDetailContent').innerHTML = `
            <div class="alert alert-danger">
              Error loading feedback details. Please try again.
            </div>
          `;
        });
    }
  });
</script>
{% endblock %}
