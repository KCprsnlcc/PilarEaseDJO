<!-- templates/admin_tools/manage_users.html -->

{% extends "admin_tools/base_admin.html" %} {% load static %} {% load compress
%} {% block content %}
<div class="pilarease-admin-main-content animate__animated animate__fadeIn">
  <div
    class="pilarease-admin-dashboard-header"
    style="display: flex; justify-content: space-between; align-items: center"
  >
    <h1 class="pilarease-admin-manageusers-title">
      Manage Users
      <i
        class="bx bx-info-circle pilarease-admin-info-icon"
        aria-label="More information about Manage Users"
        tabindex="0"
      ></i>
      <span class="pilarease-admin-tooltip">
        Manage and oversee user accounts, including searching, filtering,
        blocking, and deletion.
      </span>
    </h1>
  </div>

  <div class="pilarease-admin-manageusers-container">
    <!-- Search Form -->
    <form
      method="get"
      class="pilarease-admin-manageusers-search-form pilarease-admin-feedback-search-form animate__animated animate__fadeInDown"
    >
      <input
        type="text"
        name="search"
        class="pilarease-admin-manageusers-search-input"
        placeholder="Search..."
        value="{{ search_query }}"
      />
      <button type="submit" class="pilarease-admin-button">Search</button>
      <a
        href="{% url 'manage_users' %}"
        class="pilarease-admin-button pilarease-admin-reset-button"
        >Reset</a
      >
    </form>

    <!-- Users Table -->
    <table
      class="pilarease-admin-manageusers-table pilarease-admin-feedback-table"
    >
      <thead>
        <tr>
          <th>No.</th>
          <th>Avatar</th>
          <!-- New Avatar Column -->
          <th>Student ID</th>
          <th>Username</th>
          <th>Full Name</th>
          <th>Academic Year Level</th>
          <th>Contact Number</th>
          <th>Email</th>
          <th>Last Joined</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr
          class="pilarease-admin-manageusers-row"
          data-user-id="{{ user.id }}"
        >
          <td>{{ forloop.counter }}</td>
          <td>
            <img
              src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}{% static 'images/avatars/placeholder.png' %}{% endif %}"
              alt="{{ user.username }}'s Avatar"
              class="pilarease-admin-avatar"
            />
          </td>
          <td>{{ user.student_id }}</td>
          <td>{{ user.username }}</td>
          <td>{{ user.full_name }}</td>
          <td>{{ user.academic_year_level }}</td>
          <td>{{ user.contact_number }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.last_login|date:"Y-m-d" }}</td>
          <td>
            <button
              class="pilarease-admin-manageusers-block-button"
              data-user-id="{{ user.id }}"
            >
              Block
            </button>
            <a
              href="{% url 'delete_user' user.id %}"
              class="pilarease-admin-action-button delete-button"
              aria-label="Delete User"
              onclick="return confirm('Are you sure you want to delete this user?');"
            >
              Delete
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if not users %}
    <p class="pilarease-admin-manageusers-no-users">No users found.</p>
    {% endif %}

    <!-- Pagination -->
    <div
      class="pilarease-admin-manageusers-pagination pilarease-admin-pagination animate__animated animate__fadeInUp"
    >
      <span class="pilarease-admin-step-links pilarease-admin-step-links">
        {% if page_obj.has_previous %}
        <a
          href="?page=1&search={{ search_query }}"
          class="pilarease-admin-step-link"
          >&laquo; First</a
        >
        <a
          href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}"
          class="pilarease-admin-step-link"
          >Previous</a
        >
        {% endif %}

        <span class="pilarease-admin-current pilarease-admin-current">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
        <a
          href="?page={{ page_obj.next_page_number }}&search={{ search_query }}"
          class="pilarease-admin-step-link"
          >Next</a
        >
        <a
          href="?page={{ page_obj.paginator.num_pages }}&search={{ search_query }}"
          class="pilarease-admin-step-link"
          >Last &raquo;</a
        >
        {% endif %}
      </span>
    </div>
  </div>
</div>

<!-- Block User Modal -->
<div
  id="pilarease-admin-manageusers-blockUserModal"
  class="pilarease-admin-manageusers-modal modal animate__animated animate__zoomIn"
>
  <div class="pilarease-admin-manageusers-modal-content">
    <span class="pilarease-admin-manageusers-close" id="closeBlockUserModal"
      >&times;</span
    >
    <h2>Block User</h2>
    <form id="pilarease-admin-manageusers-blockUserForm">
      <input
        type="hidden"
        name="user_id"
        id="pilarease-admin-manageusers-blockUserId"
      />
      <label for="reason">Reason for Blocking:</label>
      <input
        type="text"
        id="pilarease-admin-manageusers-reason"
        name="reason"
        required
      />
      <label for="duration">Duration (in days):</label>
      <input
        type="number"
        id="pilarease-admin-manageusers-duration"
        name="duration"
        required
      />
      <button type="submit" class="pilarease-admin-manageusers-block-button">
        Block User
      </button>
    </form>
  </div>
</div>

<!-- JavaScript for Modal and Form Handling -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Function to get CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie("csrftoken");

    // Select all block buttons
    const blockButtons = document.querySelectorAll(
      ".pilarease-admin-manageusers-block-button"
    );
    // Select the modal
    const modal = document.getElementById(
      "pilarease-admin-manageusers-blockUserModal"
    );
    // Select the close button
    const closeModal = document.getElementById("closeBlockUserModal");
    // Select the form inside the modal
    const blockUserForm = document.getElementById(
      "pilarease-admin-manageusers-blockUserForm"
    );
    // Select the hidden input for user ID
    const blockUserIdInput = document.getElementById(
      "pilarease-admin-manageusers-blockUserId"
    );

    // Function to open the modal with animation
    function openModal(userId) {
      blockUserIdInput.value = userId;
      modal.style.display = "block";
      modal.classList.remove("animate__zoomOut");
      modal.classList.add("animate__zoomIn");
    }

    // Function to close the modal with animation
    function closeModalFunction() {
      modal.classList.remove("animate__zoomIn");
      modal.classList.add("animate__zoomOut");
      // Wait for the animation to finish before hiding
      setTimeout(() => {
        modal.style.display = "none";
        modal.classList.remove("animate__zoomOut");
      }, 500); // Duration should match the animation duration
    }

    // Add click event listeners to all block buttons
    blockButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const userId = this.getAttribute("data-user-id");
        openModal(userId);
      });
    });

    // Add click event listener to the close button
    closeModal.addEventListener("click", function () {
      closeModalFunction();
    });

    // Add click event listener to window to close modal when clicking outside the content
    window.addEventListener("click", function (event) {
      if (event.target == modal) {
        closeModalFunction();
      }
    });

    // Handle form submission
    blockUserForm.addEventListener("submit", function (e) {
      e.preventDefault();
      // Retrieve form data
      const userId = blockUserIdInput.value;
      const reason = document.getElementById(
        "pilarease-admin-manageusers-reason"
      ).value;
      const duration = document.getElementById(
        "pilarease-admin-manageusers-duration"
      ).value;

      // Validate form data
      if (!reason || !duration) {
        alert("Please provide both reason and duration for blocking.");
        return;
      }

      // Send data via Fetch API
      fetch("{% url 'block_user' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({
          user_id: userId,
          reason: reason,
          duration: duration,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Close the modal
            closeModalFunction();
            // Optionally, show a success message
            alert("User has been blocked successfully.");
            // Reload the page to reflect changes
            location.reload();
          } else {
            // Handle errors (e.g., show error messages)
            alert("Error blocking user: " + data.error);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An unexpected error occurred.");
        });
    });

    // JavaScript for Expanded View Toggle (Removed as per request)
    // Removed all code related to expanded view to eliminate the expanded rows
  });
</script>
{% endblock %}
