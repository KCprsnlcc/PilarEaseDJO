{% extends "admin_tools/base_admin.html" %} {% load static %} {% load compress
%} {% block content %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Existing head content from base_admin.html -->
    <!-- Ensure Animate.css is included -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <!-- If you prefer to serve Animate.css locally, uncomment the following line and ensure the file exists -->
    <!-- <link rel="stylesheet" href="{% static 'css/animate.min.css' %}" /> -->
  </head>
  <body>
    <h1
      class="pilarease-admin-manageusers-title animate__animated animate__fadeInDown"
    >
      Manage Users
    </h1>
    <div class="pilarease-admin-manageusers-container">
      <form
        method="get"
        class="pilarease-admin-manageusers-search-form animate__animated animate__fadeIn"
      >
        <input
          type="text"
          name="search"
          placeholder="Search..."
          value="{{ search_query }}"
          class="pilarease-admin-manageusers-search-input"
        />
        <button
          type="submit"
          class="pilarease-admin-manageusers-search-button animate__animated animate__bounceIn"
        >
          Search
        </button>
      </form>

      <table
        class="pilarease-admin-manageusers-table animate__animated animate__fadeInUp"
      >
        <thead>
          <tr>
            <th>No.</th>
            <th>Student ID</th>
            <th>Username</th>
            <th>Full Name</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Academic Year Level</th>
            <th>Contact Number</th>
            <th>Email</th>
            <th>Last Joined</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr
            class="pilarease-admin-manageusers-row animate__animated animate__fadeIn"
          >
            <td>{{ forloop.counter }}</td>
            <td>{{ user.student_id }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.full_name }}</td>
            <td>{{ user.first_name }}</td>
            <td>{{ user.last_name }}</td>
            <td>{{ user.academic_year_level }}</td>
            <td>{{ user.contact_number }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.last_login|date:"Y-m-d" }}</td>
            <td>
              <button
                class="pilarease-admin-manageusers-block-button animate__animated animate__pulse"
                data-user-id="{{ user.id }}"
              >
                Block
              </button>
              <a
                href="{% url 'delete_user' user.id %}"
                class="pilarease-admin-manageusers-delete-icon"
              >
                <i class="bx bx-trash"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if not users %}
      <p
        class="pilarease-admin-manageusers-no-users animate__animated animate__fadeIn"
      >
        No users found.
      </p>
      {% endif %}
      <div
        class="pilarease-admin-manageusers-pagination animate__animated animate__fadeIn"
      >
        <span class="pilarease-admin-manageusers-step-links">
          {% if page_obj.has_previous %}
          <a
            href="?page=1&search={{ search_query }}"
            class="pilarease-admin-manageusers-page-link"
            >first</a
          >
          <a
            href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}"
            class="pilarease-admin-manageusers-page-link"
            >previous</a
          >
          {% endif %}

          <span class="pilarease-admin-manageusers-current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
          </span>

          {% if page_obj.has_next %}
          <a
            href="?page={{ page_obj.next_page_number }}&search={{ search_query }}"
            class="pilarease-admin-manageusers-page-link"
            >next</a
          >
          <a
            href="?page={{ page_obj.paginator.num_pages }}&search={{ search_query }}"
            class="pilarease-admin-manageusers-page-link"
            >last</a
          >
          {% endif %}
        </span>
      </div>
    </div>

    <!-- Block User Modal -->
    <div
      id="pilarease-admin-manageusers-blockUserModal"
      class="pilarease-admin-manageusers-modal modal animate__animated animate__zoomIn"
    >
      <div class="pilarease-admin-manageusers-modal-content">
        <span class="pilarease-admin-manageusers-close" id="closeBlockUserModal"
          >&times;</span
        >
        <h2>Block User</h2>
        <form id="pilarease-admin-manageusers-blockUserForm">
          <input
            type="hidden"
            name="user_id"
            id="pilarease-admin-manageusers-blockUserId"
          />
          <label for="reason">Reason for Blocking:</label>
          <input
            type="text"
            id="pilarease-admin-manageusers-reason"
            name="reason"
            required
          />
          <label for="duration">Duration (in days):</label>
          <input
            type="number"
            id="pilarease-admin-manageusers-duration"
            name="duration"
            required
          />
          <button
            type="submit"
            class="pilarease-admin-manageusers-block-button"
          >
            Block User
          </button>
        </form>
      </div>
    </div>

    <!-- Internal JavaScript -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Function to get CSRF token from cookies
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        const csrftoken = getCookie("csrftoken");

        // Select all block buttons
        const blockButtons = document.querySelectorAll(
          ".pilarease-admin-manageusers-block-button"
        );
        // Select the modal
        const modal = document.getElementById(
          "pilarease-admin-manageusers-blockUserModal"
        );
        // Select the close button
        const closeModal = document.getElementById("closeBlockUserModal");
        // Select the form inside the modal
        const blockUserForm = document.getElementById(
          "pilarease-admin-manageusers-blockUserForm"
        );
        // Select the hidden input for user ID
        const blockUserIdInput = document.getElementById(
          "pilarease-admin-manageusers-blockUserId"
        );

        // Function to open the modal with animation
        function openModal(userId) {
          blockUserIdInput.value = userId;
          modal.style.display = "block";
          modal.classList.remove("animate__zoomOut");
          modal.classList.add("animate__zoomIn");
        }

        // Function to close the modal with animation
        function closeModalFunction() {
          modal.classList.remove("animate__zoomIn");
          modal.classList.add("animate__zoomOut");
          // Wait for the animation to finish before hiding
          setTimeout(() => {
            modal.style.display = "none";
            modal.classList.remove("animate__zoomOut");
          }, 500); // Duration should match the animation duration
        }

        // Add click event listeners to all block buttons
        blockButtons.forEach((button) => {
          button.addEventListener("click", function () {
            const userId = this.getAttribute("data-user-id");
            openModal(userId);
          });
        });

        // Add click event listener to the close button
        closeModal.addEventListener("click", function () {
          closeModalFunction();
        });

        // Add click event listener to window to close modal when clicking outside the content
        window.addEventListener("click", function (event) {
          if (event.target == modal) {
            closeModalFunction();
          }
        });

        // Handle form submission
        blockUserForm.addEventListener("submit", function (e) {
          e.preventDefault();
          // Retrieve form data
          const userId = blockUserIdInput.value;
          const reason = document.getElementById(
            "pilarease-admin-manageusers-reason"
          ).value;
          const duration = document.getElementById(
            "pilarease-admin-manageusers-duration"
          ).value;

          // Validate form data
          if (!reason || !duration) {
            alert("Please provide both reason and duration for blocking.");
            return;
          }

          // Send data via Fetch API
          fetch("{% url 'block_user' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({
              user_id: userId,
              reason: reason,
              duration: duration,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Close the modal
                closeModalFunction();
                // Optionally, show a success message
                alert("User has been blocked successfully.");
                // Reload the page to reflect changes
                location.reload();
              } else {
                // Handle errors (e.g., show error messages)
                alert("Error blocking user: " + data.error);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An unexpected error occurred.");
            });
        });
      });
    </script>
  </body>
</html>
{% endblock %}
