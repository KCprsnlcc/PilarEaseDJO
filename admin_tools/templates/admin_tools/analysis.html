<!-- templates/admin_tools/analysis.html -->

{% extends "admin_tools/base_admin.html" %}
{% load static %}
{% load compress %}

{% block content %}
<div class="pilarease-admin-analysis animate__animated animate__fadeIn">
    <div class="pilarease-admin-dashboard-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h1 class="pilarease-admin-title">
            Analysis
            <i class="bx bx-info-circle pilarease-admin-info-icon" aria-label="More information about Analysis" tabindex="0"></i>
            <span class="pilarease-admin-tooltip">
                Comprehensive analysis of user emotions, trends, and keyword detections.
            </span>
        </h1>
    </div>

    <!-- Search and Filter Form -->
    <div class="pilarease-admin-search-filter animate__animated animate__fadeInDown">
        <form method="get" class="pilarease-admin-search-form search-form">
            <input type="text" name="search" placeholder="Search..." value="{{ search_query }}" class="pilarease-admin-input search-input">
            <select name="category" class="pilarease-admin-select category-select">
                <option value="all" {% if category == 'all' %}selected{% endif %}>All</option>
                <option value="anger" {% if category == 'anger' %}selected{% endif %}>Anger</option>
                <option value="disgust" {% if category == 'disgust' %}selected{% endif %}>Disgust</option>
                <option value="fear" {% if category == 'fear' %}selected{% endif %}>Fear</option>
                <option value="happiness" {% if category == 'happiness' %}selected{% endif %}>Happiness</option>
                <option value="neutral" {% if category == 'neutral' %}selected{% endif %}>Neutral</option>
                <option value="sadness" {% if category == 'sadness' %}selected{% endif %}>Sadness</option>
                <option value="surprise" {% if category == 'surprise' %}selected{% endif %}>Surprise</option>
            </select>
            <button type="submit" class="pilarease-admin-button search-button animate__animated animate__pulse">Search</button>
        </form>
    </div>

    <!-- Statuses Table -->
    <div class="pilarease-admin-statuses-table-container animate__animated animate__fadeInUp">
        <h2 class="pilarease-admin-subtitle">
            Statuses
            <i class="bx bx-info-circle pilarease-admin-info-icon" aria-label="More information about Statuses" tabindex="0"></i>
            <span class="pilarease-admin-tooltip">
                Overview of user statuses with corresponding emotion percentages.
            </span>
        </h2>
        <table class="pilarease-admin-statuses-table status-table">
            <thead>
                <tr>
                    <th>Status ID</th>
                    <th>Body</th>
                    <th>Anger</th>
                    <th>Disgust</th>
                    <th>Fear</th>
                    <th>Happiness</th>
                    <th>Neutral</th>
                    <th>Sadness</th>
                    <th>Surprise</th>
                    <th>Timestamp</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for status in statuses %}
                <tr class="pilarease-admin-status-row" data-status-id="{{ status.id }}">
                    <td>{{ status.id }}</td>
                    <td>{{ status.plain_description|truncatewords:10 }}</td>
                    <td class="pilarease-admin-progress-cell">
                        <div class="pilarease-admin-progress-bar-container">
                            <div class="pilarease-admin-progress-bar" style="width: {{ status.anger_percentage }}%; background-color: #FF5733;"></div>
                            <div class="pilarease-admin-progress-tooltip">
                                {{ status.anger_percentage }}%
                            </div>
                        </div>
                    </td>
                    <td class="pilarease-admin-progress-cell">
                        <div class="pilarease-admin-progress-bar-container">
                            <div class="pilarease-admin-progress-bar" style="width: {{ status.disgust_percentage }}%; background-color: #C70039;"></div>
                            <div class="pilarease-admin-progress-tooltip">
                                {{ status.disgust_percentage }}%
                            </div>
                        </div>
                    </td>
                    <td class="pilarease-admin-progress-cell">
                        <div class="pilarease-admin-progress-bar-container">
                            <div class="pilarease-admin-progress-bar" style="width: {{ status.fear_percentage }}%; background-color: #900C3F;"></div>
                            <div class="pilarease-admin-progress-tooltip">
                                {{ status.fear_percentage }}%
                            </div>
                        </div>
                    </td>
                    <td class="pilarease-admin-progress-cell">
                        <div class="pilarease-admin-progress-bar-container">
                            <div class="pilarease-admin-progress-bar" style="width: {{ status.happiness_percentage }}%; background-color: #FFC300;"></div>
                            <div class="pilarease-admin-progress-tooltip">
                                {{ status.happiness_percentage }}%
                            </div>
                        </div>
                    </td>
                    <td class="pilarease-admin-progress-cell">
                        <div class="pilarease-admin-progress-bar-container">
                            <div class="pilarease-admin-progress-bar" style="width: {{ status.neutral_percentage }}%; background-color: #DAF7A6;"></div>
                            <div class="pilarease-admin-progress-tooltip">
                                {{ status.neutral_percentage }}%
                            </div>
                        </div>
                    </td>
                    <td class="pilarease-admin-progress-cell">
                        <div class="pilarease-admin-progress-bar-container">
                            <div class="pilarease-admin-progress-bar" style="width: {{ status.sadness_percentage }}%; background-color: #581845;"></div>
                            <div class="pilarease-admin-progress-tooltip">
                                {{ status.sadness_percentage }}%
                            </div>
                        </div>
                    </td>
                    <td class="pilarease-admin-progress-cell">
                        <div class="pilarease-admin-progress-bar-container">
                            <div class="pilarease-admin-progress-bar" style="width: {{ status.surprise_percentage }}%; background-color: #900C3F;"></div>
                            <div class="pilarease-admin-progress-tooltip">
                                {{ status.surprise_percentage }}%
                            </div>
                        </div>
                    </td>
                    <td>{{ status.created_at|date:"Y-m-d" }}</td>
                    <td>
                        <a href="{% url 'delete_status' status.id %}" class="pilarease-admin-action-button delete-button" aria-label="Delete Status">Delete</a>
                    </td>
                </tr>
                <!-- Expanded View Row -->
                <tr class="pilarease-admin-expanded-view" id="expanded-view-{{ status.id }}" style="display: none;">
                    <td colspan="11">
                        <div class="pilarease-admin-expanded-content animate__animated animate__fadeIn">
                            <h3>{{ status.title }}</h3>
                            <p><strong>Description:</strong> {{ status.plain_description }}</p>
                            <p><strong>Category:</strong> {{ status.emotion|title }}</p>
                            <p><strong>Date Posted:</strong> {{ status.created_at|date:"Y-m-d H:i" }}</p>
                            <a href="{% url 'delete_status' status.id %}" class="pilarease-admin-action-button delete-button" aria-label="Delete Status" onclick="return confirm('Are you sure you want to delete this status?');">Delete</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not statuses %}
        <p class="pilarease-admin-no-data">No analysis data found.</p>
        {% endif %}
        <div class="pilarease-admin-pagination pagination">
            <span class="pilarease-admin-step-links step-links">
                {% if page_obj.has_previous %}
                    <a href="?page=1&search={{ search_query }}&category={{ category }}" class="pilarease-admin-pagination-link">First</a>
                    <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&category={{ category }}" class="pilarease-admin-pagination-link">Previous</a>
                {% endif %}

                <span class="pilarease-admin-current current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&category={{ category }}" class="pilarease-admin-pagination-link">Next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}&search={{ search_query }}&category={{ category }}" class="pilarease-admin-pagination-link">Last</a>
                {% endif %}
            </span>
        </div>
    </div>

    

    <!-- Keywords or Topics Detection Table -->
    <div class="pilarease-admin-keywords-section animate__animated animate__fadeInUp">
        <h2 class="pilarease-admin-subtitle">
            Keywords or Topics Detection
            <i class="bx bx-info-circle pilarease-admin-info-icon" aria-label="More information about Keywords or Topics Detection" tabindex="0"></i>
            <span class="pilarease-admin-tooltip">
                Detect and analyze keywords or topics from user statuses for better insights.
            </span>
        </h2>
        <table class="pilarease-admin-keywords-table keywords-table">
            <thead>
                <tr>
                    <th>Status ID</th>
                    <th>Keywords/Topics</th>
                </tr>
            </thead>
            <tbody>
                {% for keyword in keywords_data %}
                <tr>
                    <td>{{ keyword.status_id }}</td>
                    <td>
                        {% for kw in keyword.keywords %}
                            <span class="pilarease-admin-tag keyword-tag">{{ kw }}</span>
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not keywords_data %}
        <p class="pilarease-admin-no-data">No keywords data available.</p>
        {% endif %}
    </div>


    <!-- Contextual Emotion Comparison User Table -->
    <div class="pilarease-admin-comparison-section animate__animated animate__fadeInUp">
        <h2 class="pilarease-admin-subtitle">
            Contextual Emotion Comparison
            <i class="bx bx-info-circle pilarease-admin-info-icon" aria-label="More information about Contextual Emotion Comparison" tabindex="0"></i>
            <span class="pilarease-admin-tooltip">
                Compare current emotion statuses against average recent emotions for each user.
            </span>
        </h2>
        <table class="pilarease-admin-comparison-table comparison-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Anger (Current)</th>
                    <th>Anger (Avg Recent)</th>
                    <th>Disgust (Current)</th>
                    <th>Disgust (Avg Recent)</th>
                    <th>Fear (Current)</th>
                    <th>Fear (Avg Recent)</th>
                    <th>Neutral (Current)</th>
                    <th>Neutral (Avg Recent)</th>
                    <th>Happiness (Current)</th>
                    <th>Happiness (Avg Recent)</th>
                    <th>Sadness (Current)</th>
                    <th>Sadness (Avg Recent)</th>
                    <th>Surprise (Current)</th>
                    <th>Surprise (Avg Recent)</th>
                </tr>
            </thead>
            <tbody>
                {% for comparison in comparison_data %}
                <tr>
                    <td>{{ comparison.user_full_name }}</td>
                    <td>{{ comparison.current_status.anger }}%</td>
                    <td>{{ comparison.average_recent.anger|floatformat:1 }}%</td>
                    <td>{{ comparison.current_status.disgust }}%</td>
                    <td>{{ comparison.average_recent.disgust|floatformat:1 }}%</td>
                    <td>{{ comparison.current_status.fear }}%</td>
                    <td>{{ comparison.average_recent.fear|floatformat:1 }}%</td>
                    <td>{{ comparison.current_status.neutral }}%</td>
                    <td>{{ comparison.average_recent.neutral|floatformat:1 }}%</td>
                    <td>{{ comparison.current_status.happiness }}%</td>
                    <td>{{ comparison.average_recent.happiness|floatformat:1 }}%</td>
                    <td>{{ comparison.current_status.sadness }}%</td>
                    <td>{{ comparison.average_recent.sadness|floatformat:1 }}%</td>
                    <td>{{ comparison.current_status.surprise }}%</td>
                    <td>{{ comparison.average_recent.surprise|floatformat:1 }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not comparison_data %}
        <p class="pilarease-admin-no-data">No comparison data available.</p>
        {% endif %}
    </div>
</div>


    <!-- JavaScript for Tooltip Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Select all progress bar containers
            const progressBarContainers = document.querySelectorAll('.pilarease-admin-progress-bar-container');

            progressBarContainers.forEach(function(container) {
                const tooltip = container.querySelector('.pilarease-admin-progress-tooltip');

                // Ensure the tooltip exists
                if (!tooltip) {
                    console.warn('Tooltip not found in:', container);
                    return;
                }

                // Make the container focusable for accessibility
                container.setAttribute('tabindex', '0');

                // Show tooltip on mouse enter
                container.addEventListener('mouseenter', function() {
                    tooltip.style.opacity = '1';
                    tooltip.style.pointerEvents = 'auto';
                });

                // Hide tooltip on mouse leave
                container.addEventListener('mouseleave', function() {
                    tooltip.style.opacity = '0';
                    tooltip.style.pointerEvents = 'none';
                });

                // Show tooltip on focus (for keyboard navigation)
                container.addEventListener('focus', function() {
                    tooltip.style.opacity = '1';
                    tooltip.style.pointerEvents = 'auto';
                });

                // Hide tooltip on blur
                container.addEventListener('blur', function() {
                    tooltip.style.opacity = '0';
                    tooltip.style.pointerEvents = 'none';
                });
            });

            // Select all main status rows
            const statusRows = document.querySelectorAll('.pilarease-admin-status-row');

            statusRows.forEach(function(row) {
                row.addEventListener('click', function(event) {
                    // Prevent toggling when clicking on the Delete button or any actionable element
                    if (event.target.closest('.pilarease-admin-action-button')) {
                        return;
                    }

                    const statusId = this.getAttribute('data-status-id');
                    const expandedView = document.getElementById('expanded-view-' + statusId);
                    if (expandedView.style.display === 'table-row') {
                        expandedView.style.display = 'none';
                    } else {
                        expandedView.style.display = 'table-row';
                    }
                });
            });
        });
    </script>

</div>

{% endblock %}
