<!-- admin_tools/templates/admin_tools/performance_dashboard.html -->
{% extends "admin_tools/base_admin.html" %} {% load static %} {%block content%}
<div class="pilarease-admin-performance-dashboard-container">
  <h2 class="pilarease-admin-section-title">
    Performance Matrix
    <i class="bx bx-info-circle pilarease-admin-info-icon"></i>
    <div class="pilarease-admin-tooltip">
      Upload your dataset in CSV format to calculate performance metrics.
    </div>
  </h2>

  <!-- Display Messages -->
  {% if messages %}
  <ul class="pilarease-admin-messages">
    {% for message in messages %}
    <li class="pilarease-admin-message {{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}

  <!-- Display Form Errors -->
  {% if form.errors %}
  <div class="pilarease-admin-form-errors">
    <ul>
      {% for field in form %} {% for error in field.errors %}
      <li><strong>{{ field.label }}:</strong> {{ error }}</li>
      {% endfor %} {% endfor %} {% for error in form.non_field_errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %} {% if dataset_id %}
  <!-- Progress Bar Section -->
  <div class="pilarease-admin-progress-section">
    <h3>Processing Dataset</h3>
    <p id="current-task">Current Task: <span>Initializing...</span></p>
    <div class="pilarease-admin-progress-bar-container">
      <div
        id="progress-bar"
        class="pilarease-admin-progress-bar"
        style="width: 0%"
      ></div>
    </div>
    <p id="progress-percentage">0%</p>
  </div>

  <!-- JavaScript for Polling Progress -->
  <script>
    const datasetId = "{{ dataset_id }}";
    const progressBar = document.getElementById("progress-bar");
    const progressPercentage = document.getElementById("progress-percentage");
    const currentTask = document
      .getElementById("current-task")
      .querySelector("span");

    function updateProgress() {
      fetch("{% url 'get_progress' dataset_id=dataset_id %}")
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            alert(data.error);
            return;
          }
          const progress = data.progress;
          currentTask.textContent = progress.current_task;
          progressBar.style.width = progress.percentage + "%";
          progressPercentage.textContent = progress.percentage + "%";

          if (progress.percentage < 100) {
            setTimeout(updateProgress, 1000); // Poll every second
          } else {
            // Redirect to result page after completion
            window.location.href =
              "{% url 'performance_dashboard_result' %}?dataset_id=" +
              datasetId;
          }
        })
        .catch((error) => {
          console.error("Error fetching progress:", error);
          setTimeout(updateProgress, 1000); // Retry after a second
        });
    }

    // Start polling when the page loads
    document.addEventListener("DOMContentLoaded", function () {
      updateProgress();
    });
  </script>
  {% else %}
  <!-- Upload Form -->
  <form
    method="post"
    enctype="multipart/form-data"
    class="pilarease-admin-performance-form"
    id="performance-form"
  >
    {% csrf_token %} {{ form.as_p }}
    <button type="submit" class="pilarease-admin-filter-button">
      Upload & Calculate
    </button>
  </form>
  {% endif %}
</div>
{% endblock %}
