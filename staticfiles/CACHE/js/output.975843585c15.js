document.addEventListener("DOMContentLoaded",function(){document.getElementById("loader-overlay").style.display="none";function fontsAndIconsLoaded(){const fontNames=["Aguafina Script","Gothic A1","Inter","Epilogue"];const allFontsLoaded=fontNames.every((font)=>document.fonts.check(`1em ${font}`));const boxiconLoaded=document.fonts.check('1em "boxicons"');return allFontsLoaded&&boxiconLoaded;}
document.fonts.ready.then(()=>{if(fontsAndIconsLoaded()){document.getElementById("loader-overlay").style.display="none";document.getElementById("overlay").style.display="none";}else{const interval=setInterval(()=>{if(fontsAndIconsLoaded()){clearInterval(interval);document.getElementById("loader-overlay").style.display="none";document.getElementById("overlay").style.display="none";}},100);}});const avatarLoader=document.getElementById("avatarLoader");const currentAvatar=document.getElementById("currentAvatar");const avatarModal=document.getElementById("avatarModal");const closeAvatarModal=document.getElementById("closeAvatarModal");const saveAvatarBtn=document.getElementById("saveAvatarBtn");const cancelAvatarBtn=document.getElementById("cancelAvatarBtn");const avatarImages=document.querySelectorAll(".avatars-grid img.avatar-option");const uploadAvatarInput=document.getElementById("uploadAvatarInput");const cropperModal=document.getElementById("cropperModal");const closeCropperModal=document.getElementById("closeCropperModal");const cropImageBtn=document.getElementById("cropImageBtn");const cancelCropBtn=document.getElementById("cancelCropBtn");const imageToCrop=document.getElementById("imageToCrop");let selectedAvatar=null;let cropper;const uploadAvatarUrl=document.getElementById("uploadAvatarUrl").value;const placeholderUrl=currentAvatar.dataset.placeholderUrl;const statusModal=document.getElementById("statusModal");const statusForm=document.getElementById("statusForm");const feelingIcons=document.querySelectorAll(".feeling-icon");const statusTitle=document.getElementById("caption");const statusDescription=document.getElementById("description");const statusLoader=document.getElementById("statusLoader");const confirmStatusModal=document.getElementById("ConfirmStatusModal");const confirmBtn=document.getElementById("confirmBtn");const cancelBtn=document.getElementById("cancelBtn");const categoryElements=document.querySelectorAll(".v1_124 div");const contactUsButton=document.getElementById("contactUsButton");const contactUsModal=document.getElementById("contactUsModal");const closeContactUsModal=document.getElementById("closeContactUsModal");let selectedEmotion=null;let page=1;let isLoading=false;let hasNext=true;let activeCategory="recent";document.addEventListener("DOMContentLoaded",function(){const rememberMeCheckbox=document.getElementById("rememberMe");const usernameField=document.querySelector('input[name="username"]');const passwordField=document.querySelector('input[name="password"]');if(localStorage.getItem("rememberMe")==="true"){usernameField.value=localStorage.getItem("username");passwordField.value=localStorage.getItem("password");rememberMeCheckbox.checked=true;}
document.getElementById("loginForm").onsubmit=function(){if(rememberMeCheckbox.checked){localStorage.setItem("rememberMe","true");localStorage.setItem("username",usernameField.value);localStorage.setItem("password",passwordField.value);}else{localStorage.removeItem("rememberMe");localStorage.removeItem("username");localStorage.removeItem("password");}};});const forgotPasswordLink=document.getElementById("forgotPasswordLink");const forgotPasswordModal=document.getElementById("forgotPasswordModal");const closeForgotPasswordModal=document.getElementById("closeForgotPasswordModal");if(forgotPasswordLink){forgotPasswordLink.onclick=function(event){event.preventDefault();forgotPasswordModal.style.display="block";setTimeout(()=>{forgotPasswordModal.classList.add("pop-in");},10);};}
if(closeForgotPasswordModal){closeForgotPasswordModal.onclick=function(){forgotPasswordModal.classList.add("pop-out");setTimeout(()=>{forgotPasswordModal.style.display="none";forgotPasswordModal.classList.remove("pop-in","pop-out");},300);};}
document.getElementById("forgotPasswordForm").addEventListener("submit",function(event){event.preventDefault();const emailInput=document.querySelector('input[name="email"]');const email=emailInput.value;const submitButton=document.querySelector(".v53_207");const csrfToken=document.querySelector("[name=csrfmiddlewaretoken]").value;showForgotPassLoader();submitButton.disabled=true;fetch("/password-reset/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRFToken":csrfToken,},body:new URLSearchParams({email:email}),}).then((response)=>response.json()).then((data)=>{hideForgotPassLoader();if(data.success){forgotPasswordSuccessBox(data.message);}else{if(data.error.includes("3 minutes")){forgotPasswordCooldownBox(data.error);}else{forgotPasswordErrorBox(data.error);}}
setTimeout(()=>{submitButton.disabled=false;},3600);}).catch((error)=>{hideForgotPassLoader();console.error("Error:",error);forgotPasswordErrorBox("An error occurred. Please try again later.");setTimeout(()=>{submitButton.disabled=false;},3600);});});function showForgotPassLoader(){document.getElementById("forgotpassOverlay").style.display="block";}
function hideForgotPassLoader(){document.getElementById("forgotpassOverlay").style.display="none";}
function forgotPasswordSuccessBox(message){const successBox=document.getElementById("forgotPasswordSuccessBox");document.getElementById("forgotPasswordSuccessContent").innerText=message;successBox.classList.remove("pop-out");successBox.classList.add("pop-in");successBox.style.display="block";setTimeout(()=>{successBox.classList.remove("pop-in");successBox.classList.add("pop-out");setTimeout(()=>{successBox.style.display="none";successBox.classList.remove("pop-in","pop-out");window.location.reload();},300);},3000);}
function forgotPasswordErrorBox(error){const errorBox=document.getElementById("forgotPasswordErrorBox");document.getElementById("forgotPasswordErrorContent").innerText=error;errorBox.classList.remove("pop-out");errorBox.classList.add("pop-in");errorBox.style.display="block";setTimeout(()=>{errorBox.classList.remove("pop-in");errorBox.classList.add("pop-out");setTimeout(()=>{errorBox.style.display="none";errorBox.classList.remove("pop-in","pop-out");},300);},3000);}
function forgotPasswordCooldownBox(message){const cooldownBox=document.getElementById("forgotPasswordCooldownBox");document.getElementById("forgotPasswordCooldownContent").innerText=message;cooldownBox.classList.remove("pop-out");cooldownBox.classList.add("pop-in");cooldownBox.style.display="block";setTimeout(()=>{cooldownBox.classList.remove("pop-in");cooldownBox.classList.add("pop-out");setTimeout(()=>{cooldownBox.style.display="none";cooldownBox.classList.remove("pop-in","pop-out");},300);},3000);}
contactUsButton.addEventListener("click",function(event){event.preventDefault();contactUsModal.style.display="block";setTimeout(()=>{contactUsModal.classList.add("pop-in");document.querySelector(".modal-content").classList.add("pop-in");},10);});closeContactUsModal.addEventListener("click",function(){document.querySelector(".modal-content").classList.add("pop-out");contactUsModal.classList.add("pop-out");setTimeout(()=>{contactUsModal.style.display="none";document.querySelector(".modal-content").classList.remove("pop-out");contactUsModal.classList.remove("pop-out");},300);});window.addEventListener("click",function(event){if(event.target===contactUsModal){document.querySelector(".modal-content").classList.add("pop-out");contactUsModal.classList.add("pop-out");setTimeout(()=>{contactUsModal.style.display="none";document.querySelector(".modal-content").classList.remove("pop-out");contactUsModal.classList.remove("pop-out");},300);}});const contactUsForm=document.getElementById("contactUsForm");contactUsForm.addEventListener("submit",function(event){event.preventDefault();const formData=new FormData(contactUsForm);fetch("/contact_us/",{method:"POST",body:JSON.stringify({name:formData.get("name"),email:formData.get("email"),subject:formData.get("subject"),message:formData.get("message"),}),headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},}).then((response)=>response.json()).then((data)=>{if(data.success){alert("Your message has been sent successfully!");contactUsModal.style.display="none";contactUsForm.reset();}else{alert("There was an error sending your message. Please try again.");}}).catch((error)=>{console.error("Error:",error);alert("There was an error sending your message. Please try again.");});});const backButton=document.getElementById("backButton");if(backButton){backButton.addEventListener("click",function(){window.location.href="/";});}
function addPopAnimation(){const statusDetailContainer=document.querySelector(".status-detail-container");if(statusDetailContainer){statusDetailContainer.classList.add("pop-in");}}
addPopAnimation();const replyLabels=document.querySelectorAll(".reply-label");replyLabels.forEach((label)=>{label.addEventListener("click",function(){const replyId=this.getAttribute("data-reply-id");const replyForm=document.getElementById(`replyForm-${replyId}`);const username=this.getAttribute("data-username");if(replyForm.style.display==="none"||replyForm.style.display===""){replyForm.style.display="block";}else{replyForm.style.display="none";}
const textarea=replyForm.querySelector("textarea");textarea.value=`@${username} `;textarea.focus();});});const submitReplyButtons=document.querySelectorAll(".submit-reply");submitReplyButtons.forEach((button)=>{button.addEventListener("click",function(){const replyId=this.getAttribute("data-reply-id");const replyForm=document.getElementById(`replyForm-${replyId}`);const textarea=replyForm.querySelector("textarea");const replyText=textarea.value;fetch(`/add_reply/{{ status.id }}/${replyId}/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":"{{ csrf_token }}",},body:JSON.stringify({text:replyText}),}).then((response)=>response.json()).then((data)=>{if(data.success){const nestedRepliesContainer=document.getElementById(`nestedReplies-${replyId}`);const newReply=`
            <div class="reply nested-reply" id="reply-${
              data.reply.id
            }" style="margin-left: ${data.reply.depth * 40}px;">
              <img src="${
                data.reply.avatar_url
              }" alt="Avatar" class="reply-avatar" />
              <div class="reply-content">
                <strong>${data.reply.username}</strong>
                <p>${data.reply.text}</p>
                <div class="reply-footer">
                  <span class="reply-timestamp">${data.reply.created_at}</span>
                  <span class="reply-label" data-reply-id="${
                    data.reply.id
                  }" data-username="${data.reply.username}">Reply</span>
                </div>
              </div>
            </div>
          `;nestedRepliesContainer.insertAdjacentHTML("beforeend",newReply);textarea.value="";replyForm.style.display="none";}}).catch((error)=>{console.error("Error:",error);});});});categoryElements.forEach((categoryElement)=>{categoryElement.addEventListener("click",function(){categoryElements.forEach((el)=>el.querySelector("span").classList.remove("active"));this.querySelector("span").classList.add("active");activeCategory=this.id;page=1;document.getElementById("boxContainer").innerHTML="";fetchStatuses(page,activeCategory);});});fetchStatuses(page,activeCategory);window.addEventListener("scroll",()=>{if(window.innerHeight+window.scrollY>=document.body.offsetHeight-100&&!isLoading&&hasNext){page++;fetchStatuses(page);}});function showLoader(){statusLoader.style.display="block";}
function hideLoader(){statusLoader.style.display="none";}
feelingIcons.forEach((icon)=>{icon.addEventListener("click",()=>{feelingIcons.forEach((i)=>i.classList.remove("active"));icon.classList.add("active");selectedEmotion=icon.querySelector("img").alt;saveFormData();});});statusTitle.addEventListener("input",saveFormData);statusDescription.addEventListener("input",saveFormData);function showProfanityError(message){const dialogBox=document.getElementById("profanityErrorModal");const dialogContent=document.getElementById("profanityErrorContent");const overlay=document.getElementById("profanityErrorOverlay");dialogContent.innerHTML=message;dialogBox.style.display="block";overlay.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");}
document.getElementById("closeProfanityModal").addEventListener("click",function(){const dialogBox=document.getElementById("profanityErrorModal");dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);});function closeProfanityErrorModal(){const dialogBox=document.getElementById("profanityErrorModal");const overlay=document.getElementById("profanityErrorOverlay");dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");overlay.style.display="none";},300);}
function showGuidelinesModal(){const guidelinesModal=document.getElementById("guidelinesModal");const guidelinesOverlay=document.getElementById("guidelinesOverlay");guidelinesModal.style.display="block";guidelinesOverlay.style.display="block";guidelinesModal.classList.remove("pop-out");guidelinesModal.classList.add("pop-in");}
function closeGuidelinesModal(){const guidelinesModal=document.getElementById("guidelinesModal");const guidelinesOverlay=document.getElementById("guidelinesOverlay");guidelinesModal.classList.remove("pop-in");guidelinesModal.classList.add("pop-out");setTimeout(()=>{guidelinesModal.style.display="none";guidelinesModal.classList.remove("pop-out");guidelinesOverlay.style.display="none";},300);}
document.getElementById("closeProfanityModal").addEventListener("click",closeProfanityErrorModal);document.getElementById("profanityErrorOverlay").addEventListener("click",closeProfanityErrorModal);document.getElementById("showGuidelines").addEventListener("click",showGuidelinesModal);document.getElementById("closeGuidelinesModal").addEventListener("click",closeGuidelinesModal);document.getElementById("guidelinesOverlay").addEventListener("click",closeGuidelinesModal);function convertNewLinesToSpaces(text){return text.replace(/\n/g," ");}
document.getElementById("description").addEventListener("input",function(){const descriptionElement=document.getElementById("description");const plainDescription=descriptionElement.textContent;const tokenCount=countTokens(plainDescription);if(tokenCount>512){showStatusError("The description exceeds the 512 token limit.");const trimmedText=plainDescription.split(/\s+/).slice(0,512).join(" ");descriptionElement.textContent=trimmedText;moveCursorToEnd(descriptionElement);updateCounters();}else{updateCounters();}});function moveCursorToEnd(element){const range=document.createRange();const selection=window.getSelection();range.selectNodeContents(element);range.collapse(false);selection.removeAllRanges();selection.addRange(range);element.focus();}
document.getElementById("description").addEventListener("paste",function(event){handlePasteEvent(event);});document.getElementById("description").addEventListener("drop",function(event){event.preventDefault();showStatusError("Only text is allowed. Please do not drag and drop files or images.");});document.getElementById("description").addEventListener("dragover",function(event){event.preventDefault();});function handlePasteEvent(event){const clipboardData=event.clipboardData||window.clipboardData;const items=clipboardData.items;for(let i=0;i<items.length;i++){if(items[i].kind!=="string"){event.preventDefault();showStatusError("Only text is allowed. Please do not paste images, PDFs, or other files.");return;}}
setTimeout(()=>{const descriptionElement=document.getElementById("description");const plainDescription=descriptionElement.textContent;const tokenCount=countTokens(plainDescription);if(tokenCount>512){showStatusError("The description exceeds the 512 token limit.");const trimmedText=plainDescription.split(/\s+/).slice(0,512).join(" ");descriptionElement.textContent=trimmedText;moveCursorToEnd(descriptionElement);updateCounters();}else{updateCounters();}},0);}
document.getElementById("description").addEventListener("paste",function(event){event.preventDefault();const text=(event.clipboardData||window.clipboardData).getData("text/plain");const tokenCount=countTokens(text);const currentTokens=countTokens(document.getElementById("description").textContent);if(tokenCount+currentTokens>512){showStatusError("Pasting this text exceeds the 512 token limit.");return;}
insertTextAtCursor(text);updateCounters();});function insertTextAtCursor(text){const selection=window.getSelection();if(!selection.rangeCount)return;const range=selection.getRangeAt(0);range.deleteContents();const textNode=document.createTextNode(text);range.insertNode(textNode);range.setStartAfter(textNode);selection.removeAllRanges();selection.addRange(range);}
function countTokens(text){return text.split(/\s+/).filter(Boolean).length;}
function countWords(text){return text.split(/\s+/).filter(Boolean).length;}
function updateCounters(){const descriptionElement=document.getElementById("description");if(descriptionElement.classList.contains("placeholder")){document.getElementById("characterCount").textContent=`0 characters`;document.getElementById("wordCount").textContent=`0 words`;document.getElementById("tokenCount").textContent=`0 tokens`;return;}
const plainDescription=descriptionElement.textContent.trim();const characterCount=plainDescription.length;const wordCount=countWords(plainDescription);const tokenCount=countTokens(plainDescription);document.getElementById("characterCount").textContent=`${characterCount} characters`;document.getElementById("wordCount").textContent=`${wordCount} words`;document.getElementById("tokenCount").textContent=`${tokenCount} tokens`;if(tokenCount>512){document.getElementById("tokenCount").textContent=`512 tokens (Max reached)`;}}
document.getElementById("description").addEventListener("input",updateCounters);document.getElementById("description").addEventListener("input",updateCounters);document.getElementById("description").addEventListener("paste",function(e){setTimeout(updateCounters,0);});updateCounters();statusForm.addEventListener("submit",function(event){event.preventDefault();const title=statusTitle.value.trim();const description=statusDescription.classList.contains("placeholder")?"":statusDescription.textContent.trim();const plainDescription=description.replace(/\n+/g," ");const tokenCount=countTokens(plainDescription);if(!selectedEmotion){showStatusError("Choose your emotion label.");return;}
if(!title){showStatusError("Choose a title for this status.");return;}
if(!description){showStatusError("Write what you feel in the description.");return;}
if(tokenCount>512){showStatusError("The description exceeds the 512 token limit.");return;}
confirmStatusModal.style.display="block";setTimeout(()=>{confirmStatusModal.classList.add("pop-in");},10);});confirmBtn.addEventListener("click",function(){const title=statusTitle.value.trim();const description=statusDescription.classList.contains("placeholder")?"":statusDescription.innerHTML.trim();const plainDescription=statusDescription.textContent.trim().replace(/\n+/g," ");confirmStatusModal.classList.remove("pop-in");confirmStatusModal.classList.add("pop-out");setTimeout(()=>{confirmStatusModal.style.display="none";confirmStatusModal.classList.remove("pop-out");fetch("/check_profanity/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},body:JSON.stringify({title:title,description:plainDescription,}),}).then((response)=>response.json()).then((data)=>{if(data.contains_profanity){showProfanityError("Your post contains inappropriate content.");}else{uploadStatus(title,description,plainDescription);}}).catch((error)=>{console.error("Error:",error);showStatusError("Network error could not check profanity.");});},300);});cancelBtn.addEventListener("click",function(){confirmStatusModal.classList.remove("pop-in");confirmStatusModal.classList.add("pop-out");setTimeout(()=>{confirmStatusModal.style.display="none";confirmStatusModal.classList.remove("pop-out");},300);});function uploadStatus(title,description,plainDescription){const csrfToken=document.querySelector('input[name="csrfmiddlewaretoken"]').value;showLoader();statusModal.querySelector(".status-form").style.opacity="0.5";fetch("/submit_status/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":csrfToken,},body:JSON.stringify({emotion:selectedEmotion,title:title,description:description,plain_description:plainDescription,}),}).then((response)=>response.json()).then((data)=>{hideLoader();statusModal.querySelector(".status-form").style.opacity="1";if(data.success){showStatusSuccess("Status shared successfully!");setTimeout(()=>{const dialogBox=document.getElementById("statusNotificationSuccess");dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");statusModal.classList.remove("pop-in");statusModal.classList.add("pop-out");setTimeout(()=>{statusModal.style.display="none";statusModal.classList.remove("pop-out");window.location.reload();},300);},300);},3000);}else{showStatusError("Failed to share status: "+JSON.stringify(data.errors));}}).catch((error)=>{hideLoader();statusModal.querySelector(".status-form").style.opacity="1";console.error("Error:",error);showStatusError("Network error could not upload.");});}
function fetchStatuses(page,category){isLoading=true;const statusLoader=document.getElementById("statusLoader");const statusOverlay=document.getElementById("statusOverlay");statusLoader.style.display="block";statusOverlay.style.display="block";fetch(`/get_all_statuses/?page=${page}&category=${category}`).then((response)=>response.json()).then((data)=>{isLoading=false;statusLoader.style.display="none";statusOverlay.style.display="none";const container=document.getElementById("boxContainer");data.statuses.forEach((status)=>{const newBox=document.createElement("div");newBox.classList.add("box5","pop");newBox.innerHTML=`
                  <div class="avatar-content">
                      <a href="/status/${status.id}/">
                          <img src="${
                            status.avatar_url
                          }" alt="Avatar" class="circle-avatar-placeholder" />
                      </a>
                      <p class="username-placeholder">${status.username}</p>
                  </div>
                  <div class="content">
                      <a href="/status/${status.id}/">
                          <h2 class="title-placeholder">${status.title}</h2>
                          <p class="description-placeholder">${truncateText(
                            status.plain_description
                          )}</p>
                      </a>
                      <span class="time-stamp time-stamp-placeholder">${
                        status.created_at
                      } ago</span>
                      <span class="feelings feelings-placeholder">${getEmotionIcon(
                        status.emotion
                      )} ${mapEmotion(status.emotion)}</span>
                      <span class="replies replies-placeholder">${
                        status.replies
                      } ${status.replies === 1 ? "Reply" : "Replies"}</span>
                      ${
                        status.can_delete
                          ? `<button id="edit-${status.id}"class="edit-button status"><i class='bx bx-edit'></i></button><button id="delete-${status.id}"class="delete-button status"><i class='bx bxs-trash bx-flip-horizontal'></i></button>`
                          : ""
                      }
                      ${
                        !status.can_delete
                          ? `<button id="refer-${status.id}"class="refer-button status"><i class='bx bxs-user-voice bx-tada'></i></button>`
                          : ""
                      }
                  </div>
              `;container.appendChild(newBox);if(status.can_delete){document.getElementById(`delete-${status.id}`).addEventListener("click",function(){deleteStatus(status.id);});document.getElementById(`edit-${status.id}`).addEventListener("click",function(){editStatus(status.id);});}else{document.getElementById(`refer-${status.id}`).addEventListener("click",function(){referStatusToCounselor(status.id);});}
newBox.addEventListener("animationend",function(){newBox.classList.remove("pop");});});hasNext=data.has_next;}).catch((error)=>{isLoading=false;statusLoader.style.display="none";statusOverlay.style.display="none";console.error("Error fetching statuses:",error);});}
document.getElementById("referralReason").addEventListener("change",function(){const otherReasonContainer=document.getElementById("otherReasonContainer");if(this.value==="Other Concerns"){otherReasonContainer.style.display="block";}else{otherReasonContainer.style.display="none";}});let undoStack=[];function referStatusToCounselor(statusId){fetch(`/get_status/${statusId}/`).then((response)=>response.json()).then((data)=>{if(data.success){document.getElementById("referStatusTitle").textContent=data.status.title;document.getElementById("referStatusDescription").textContent=data.status.plain_description;const modalContent=document.getElementById("refercontent");const modalOverlay=document.getElementById("referralModalOverlay");modalOverlay.style.display="block";modalOverlay.classList.remove("fade-out");modalOverlay.classList.add("fade-in");modalContent.style.display="block";modalContent.classList.remove("pop-out");modalContent.classList.add("pop-in");enableCustomHighlighting("referStatusTitle");enableCustomHighlighting("referStatusDescription");document.getElementById("submitReferStatus").onclick=function(){showReferralConfirmation(statusId);};document.getElementById("clearHighlights").onclick=function(){clearAllHighlights();};document.getElementById("highlightAllTitle").onclick=function(){highlightAllText("referStatusTitle");};document.getElementById("highlightAllDescription").onclick=function(){highlightAllText("referStatusDescription");};document.addEventListener("keydown",handleUndoHighlight);}else{alert("Failed to load status data.");}}).catch((error)=>{console.error("Error:",error);alert("Error fetching status data. Please try again.");});}
function closeReferModal(){const modalContent=document.getElementById("refercontent");const modalOverlay=document.getElementById("referralModalOverlay");modalContent.classList.remove("pop-in");modalContent.classList.add("pop-out");modalOverlay.classList.remove("fade-in");modalOverlay.classList.add("fade-out");setTimeout(()=>{modalContent.style.display="none";modalOverlay.style.display="none";document.removeEventListener("keydown",handleUndoHighlight);},300);}
document.getElementById("closeReferStatusModal").onclick=function(){closeReferModal();};function enableCustomHighlighting(elementId){const element=document.getElementById(elementId);element.addEventListener("mouseup",function(){const selection=window.getSelection();if(selection.rangeCount>0){const range=selection.getRangeAt(0);if(range&&element.contains(range.commonAncestorContainer)){if(!rangeIsWithinHighlightedText(range)){wrapSelectedTextWithHighlight(range);}
selection.removeAllRanges();}}});}
function isValidHighlight(range,originalText){const selectedText=range.toString();const startOffset=originalText.indexOf(selectedText);return(startOffset!==-1&&selectedText.trim()!==""&&originalText.slice(startOffset,startOffset+selectedText.length)===selectedText);}
function mergeOrWrapSelectedText(range){const selectedText=range.toString().trim();if(selectedText!==""){const startContainer=range.startContainer;const endContainer=range.endContainer;let startSpan=startContainer.nodeType===3?startContainer.previousSibling:null;let endSpan=endContainer.nodeType===3?endContainer.nextSibling:null;if(startSpan&&startSpan.classList&&startSpan.classList.contains("highlighted-text")){const textBeforeRange=startSpan.textContent.slice(-1);const textBetween=startContainer.textContent.slice(0,range.startOffset);if(textBetween.trim()===""&&!/\s/.test(textBeforeRange)){startSpan.textContent+=selectedText;range.deleteContents();return;}}
if(endSpan&&endSpan.classList&&endSpan.classList.contains("highlighted-text")){const textAfterRange=endSpan.textContent.charAt(0);const textBetween=endContainer.textContent.slice(range.endOffset);if(textBetween.trim()===""&&!/\s/.test(textAfterRange)){endSpan.textContent=selectedText+endSpan.textContent;range.deleteContents();return;}}
const span=document.createElement("span");span.className="highlighted-text";span.textContent=selectedText;range.deleteContents();range.insertNode(span);undoStack.push(span);}}
function rangeIsWithinHighlightedText(range){const startContainer=range.startContainer;const endContainer=range.endContainer;return((startContainer.parentElement&&startContainer.parentElement.classList.contains("highlighted-text"))||(endContainer.parentElement&&endContainer.parentElement.classList.contains("highlighted-text")));}
function getHighlightedText(elementId){const element=document.getElementById(elementId);const highlightedElements=element.getElementsByClassName("highlighted-text");let highlightedText="";for(let i=0;i<highlightedElements.length;i++){highlightedText+=highlightedElements[i].textContent+" ";}
return highlightedText.trim();}
function wrapSelectedTextWithHighlight(range){const selectedText=range.toString().trim();if(selectedText!==""){const span=document.createElement("span");span.className="highlighted-text";range.surroundContents(span);undoStack.push(span);}}
function preventMergeWithSpaces(span){const prevSibling=span.previousSibling;const nextSibling=span.nextSibling;if(prevSibling&&prevSibling.nodeType===3&&/\s$/.test(prevSibling.textContent)){const newTextNode=document.createTextNode(prevSibling.textContent.trimEnd());span.parentNode.insertBefore(newTextNode,span);prevSibling.textContent=" ";}
if(nextSibling&&nextSibling.nodeType===3&&/^\s/.test(nextSibling.textContent)){const newTextNode=document.createTextNode(nextSibling.textContent.trimStart());span.parentNode.insertBefore(span,nextSibling);nextSibling.textContent=" ";}}
function clearHighlightsInElement(elementId){const element=document.getElementById(elementId);const highlightedElements=element.querySelectorAll(".highlighted-text");highlightedElements.forEach((highlighted)=>{const parent=highlighted.parentNode;parent.replaceChild(document.createTextNode(highlighted.textContent),highlighted);parent.normalize();});}
function clearAllHighlights(){clearHighlightsInElement("referStatusTitle");clearHighlightsInElement("referStatusDescription");undoStack=[];}
function highlightAllText(elementId){const element=document.getElementById(elementId);clearHighlightsInElement(elementId);const range=document.createRange();range.selectNodeContents(element);wrapSelectedTextWithHighlight(range);}
function handleUndoHighlight(event){if(event.ctrlKey&&event.key==="z"){const lastHighlighted=undoStack.pop();if(lastHighlighted){const parent=lastHighlighted.parentNode;const newTextNode=document.createTextNode(lastHighlighted.textContent);parent.replaceChild(newTextNode,lastHighlighted);parent.normalize();}}}
document.querySelectorAll(".refer-status-button").forEach((button)=>{button.addEventListener("click",function(){const statusId=this.dataset.statusId;referStatusToCounselor(statusId);});});function showReferralConfirmation(statusId){const confirmationDialog=document.getElementById("referralConfirmationDialog");confirmationDialog.classList.remove("pop-out");confirmationDialog.classList.add("pop-in");confirmationDialog.style.display="block";document.getElementById("confirmSubmitReferral").onclick=function(){confirmationDialog.classList.remove("pop-in");confirmationDialog.classList.add("pop-out");setTimeout(()=>{confirmationDialog.style.display="none";showReferralLoader();submitReferral(statusId);},300);};document.getElementById("cancelSubmitReferral").onclick=function(){confirmationDialog.classList.remove("pop-in");confirmationDialog.classList.add("pop-out");setTimeout(()=>{confirmationDialog.style.display="none";},300);};}
function showReferralLoader(){const loader=document.getElementById("referralLoader");const overlay=document.getElementById("referralOverlay");loader.style.display="block";overlay.style.display="block";}
function hideReferralLoader(){const loader=document.getElementById("referralLoader");const overlay=document.getElementById("referralOverlay");loader.style.display="none";overlay.style.display="none";}
function submitReferral(statusId){const highlightedTitle=getHighlightedText("referStatusTitle");const highlightedDescription=getHighlightedText("referStatusDescription");if(!highlightedTitle&&!highlightedDescription){showHighlightError();return;}
const referralReason=document.getElementById("referralReason").value;const otherReason=document.getElementById("otherReason").value;if(referralReason==="Other Concerns"&&otherReason.trim()===""){showOtherReasonError();return;}
const formData=new FormData();formData.append("highlightedTitle",highlightedTitle);formData.append("highlightedDescription",highlightedDescription);formData.append("referralReason",referralReason);if(referralReason==="Other Concerns"){formData.append("otherReason",otherReason);}
showReferralLoader();fetch(`/refer_status/${statusId}/`,{method:"POST",body:formData,headers:{"X-CSRFToken":getCookie("csrftoken"),},}).then((response)=>response.json()).then((data)=>{hideReferralLoader();if(data.success){showReferralSuccess();}else{showReferralError();}}).catch((error)=>{console.error("Error:",error);hideReferralLoader();showReferralError();});}
function showOtherReasonError(){hideReferralLoader();const errorDialog=document.getElementById("referralErrorDialog");errorDialog.classList.remove("pop-out");errorDialog.classList.add("pop-in");errorDialog.style.display="block";document.getElementById("referralErrorContent").textContent="Please provide referral reasons for 'Other Concerns'.";setTimeout(()=>{errorDialog.classList.remove("pop-in");errorDialog.classList.add("pop-out");setTimeout(()=>{errorDialog.style.display="none";},300);},3000);}
function showHighlightError(){hideReferralLoader();const errorDialog=document.getElementById("referralErrorDialog");errorDialog.classList.remove("pop-out");errorDialog.classList.add("pop-in");errorDialog.style.display="block";document.getElementById("referralErrorContent").textContent="Please provide a highlight for title or description for referral reasons.";setTimeout(()=>{errorDialog.classList.remove("pop-in");errorDialog.classList.add("pop-out");setTimeout(()=>{errorDialog.style.display="none";},300);},3000);}
function showReferralSuccess(){const successDialog=document.getElementById("referralSuccessDialog");successDialog.classList.remove("pop-out");successDialog.classList.add("pop-in");successDialog.style.display="block";setTimeout(()=>{successDialog.classList.remove("pop-in");successDialog.classList.add("pop-out");setTimeout(()=>{successDialog.style.display="none";closeReferModal();},300);},2000);setTimeout(()=>{window.location.reload();},2300);}
function showReferralError(){hideReferralLoader();const errorDialog=document.getElementById("referralErrorDialog");errorDialog.classList.remove("pop-out");errorDialog.classList.add("pop-in");errorDialog.style.display="block";setTimeout(()=>{errorDialog.classList.remove("pop-in");errorDialog.classList.add("pop-out");setTimeout(()=>{errorDialog.style.display="none";},300);},3000);}
window.getSelectionText=function(elementId){const element=document.getElementById(elementId);let selectedText="";if(window.getSelection){const selection=window.getSelection();if(selection.rangeCount>0){const range=selection.getRangeAt(0);if(range.commonAncestorContainer.parentNode===element||range.commonAncestorContainer===element){selectedText=selection.toString();}}
return selectedText;}};function deleteStatus(statusId){const deleteDialog=document.getElementById("deleteConfirmationDialog");const confirmDeleteButton=document.getElementById("confirmSubmitDelete");const cancelDeleteButton=document.getElementById("cancelSubmitDelete");deleteDialog.classList.remove("pop-out");deleteDialog.classList.add("pop-in");deleteDialog.style.display="block";cancelDeleteButton.onclick=function(){closeDeleteDialog();};confirmDeleteButton.onclick=function(){fetch(`/delete_status/${statusId}/`,{method:"DELETE",headers:{"X-CSRFToken":getCookie("csrftoken"),},}).then((response)=>response.json()).then((data)=>{if(data.success){document.getElementById(`delete-${statusId}`).closest(".box5").remove();closeDeleteDialog();}else{showStatusError(data.message);closeDeleteDialog();}}).catch((error)=>{console.error("Error deleting status:",error);showStatusError("Error deleting status. Please try again.");closeDeleteDialog();});};function closeDeleteDialog(){deleteDialog.classList.remove("pop-in");deleteDialog.classList.add("pop-out");setTimeout(()=>{deleteDialog.style.display="none";},300);}}
function getEmotionIcon(emotion){switch(emotion.toLowerCase()){case"happiness":return"<i class='bx bx-happy-alt'></i>";case"sadness":return"<i class='bx bx-sad'></i>";case"fear":return"<i class='bx bx-dizzy' ></i>";case"anger":return"<i class='bx bx-angry'></i>";case"surprise":return"<i class='bx bx-shocked' ></i>";case"disgust":return"<i class='bx bx-confused' ></i>";default:return"<i class='bx bx-face'></i>";}}
function mapEmotion(emotion){switch(emotion.toLowerCase()){case"happiness":return"Happy";case"sadness":return"Sad";case"fear":return"Fear";case"anger":return"Angry";case"surprise":return"Surprise";case"disgust":return"Disgust";default:return emotion;}}
function truncateText(text,maxLength=150){if(text.length<=maxLength){return text;}
return text.substring(0,maxLength)+"...";}
statusDescription.addEventListener("focus",hidePlaceholder);statusDescription.addEventListener("blur",showPlaceholder);function hidePlaceholder(){if(statusDescription.classList.contains("placeholder")){statusDescription.classList.remove("placeholder");statusDescription.innerHTML="";}}
function showPlaceholder(){if(!statusDescription.innerHTML.trim().length){statusDescription.classList.add("placeholder");statusDescription.innerHTML=statusDescription.getAttribute("placeholder");}}
showPlaceholder();function saveFormData(){const title=statusTitle.value.trim();const description=statusDescription.innerHTML.trim();const formData={selectedEmotion:selectedEmotion,title:title,description:description,};localStorage.setItem("statusFormData",JSON.stringify(formData));}
function loadFormData(){const formData=JSON.parse(localStorage.getItem("statusFormData"));if(formData){selectedEmotion=formData.selectedEmotion;statusTitle.value=formData.title;statusDescription.innerHTML=formData.description;feelingIcons.forEach((icon)=>{if(icon.querySelector("img").alt===selectedEmotion){icon.classList.add("active");}else{icon.classList.remove("active");}});}}
function clearFormData(){localStorage.removeItem("statusFormData");}
window.formatText=function(command,value=null){document.execCommand(command,false,value);saveFormData();};function showStatusSuccess(message){const dialogBox=document.getElementById("statusNotificationSuccess");const dialogContent=document.getElementById("statusNotificationSuccessContent");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");clearStatusComposerModal();closeStatusComposerModal(()=>{setTimeout(()=>{window.location.reload();},300);});},300);},3000);}
function showStatusError(message){const errorDialog=document.getElementById("statusNotificationError");document.getElementById("statusNotificationErrorContent").textContent=message;errorDialog.classList.remove("pop-out");errorDialog.classList.add("pop-in");errorDialog.style.display="block";setTimeout(()=>{errorDialog.classList.remove("pop-in");errorDialog.classList.add("pop-out");setTimeout(()=>{errorDialog.style.display="none";},300);},3000);}
function closeStatusComposerModal(callback){const statusModal=document.getElementById("statusModal");const statusModalOverlay=document.getElementById("statusModalOverlay");statusModal.classList.remove("pop-in");statusModal.classList.add("pop-out");statusModalOverlay.classList.remove("fade-in");statusModalOverlay.classList.add("fade-out");setTimeout(()=>{statusModal.style.display="none";statusModal.classList.remove("pop-out");statusModalOverlay.style.display="none";statusModalOverlay.classList.remove("fade-out");if(callback){callback();}},300);}
function clearStatusComposerModal(){const statusTitle=document.getElementById("caption");const statusDescription=document.getElementById("description");const feelingIcons=document.querySelectorAll(".feeling-icon");selectedEmotion=null;statusTitle.value="";statusDescription.innerHTML="";statusDescription.classList.add("placeholder");feelingIcons.forEach((icon)=>icon.classList.remove("active"));clearFormData();}
const statusComposerButton=document.getElementById("statuscomposer");if(statusComposerButton){statusComposerButton.addEventListener("click",function(){loadFormData();const statusModal=document.getElementById("statusModal");const statusModalOverlay=document.getElementById("statusModalOverlay");statusModal.style.display="block";statusModalOverlay.style.display="block";setTimeout(()=>{statusModal.classList.add("pop-in");statusModalOverlay.classList.add("fade-in");},10);});}
const closeStatusModal=document.getElementById("closeStatusModal");if(closeStatusModal){closeStatusModal.addEventListener("click",closeStatusComposerModal);}
const statusModalOverlay=document.getElementById("statusModalOverlay");if(statusModalOverlay){statusModalOverlay.addEventListener("click",closeStatusComposerModal);}
closeStatusModal.addEventListener("click",function(){closeStatusComposerModal();});statusModalOverlay.addEventListener("click",function(){closeStatusComposerModal();});fetch("/get_user_profile/").then((response)=>response.json()).then((data)=>{currentAvatar.src=data.avatar||placeholderUrl;avatarLoader.style.display="none";currentAvatar.style.display="block";}).catch((error)=>{console.error("",error);avatarLoader.style.display="none";currentAvatar.style.display="block";});const uploadAreaImg=document.querySelector(".upload-area img");avatarImages.forEach((img)=>{img.addEventListener("click",function(){avatarImages.forEach((i)=>i.classList.remove("selected"));uploadAreaImg.classList.remove("selected");this.classList.add("selected");selectedAvatar=this.src;saveAvatarBtn.style.display="inline-block";});});document.querySelector(".upload-area").addEventListener("click",function(){uploadAvatarInput.click();});document.querySelector(".upload-area").addEventListener("click",function(){avatarImages.forEach((i)=>i.classList.remove("selected"));uploadAreaImg.classList.add("selected");uploadAvatarInput.click();});uploadAvatarInput.addEventListener("change",function(){if(uploadAvatarInput.files.length>0){const uploadedFile=uploadAvatarInput.files[0];if(uploadedFile.size>1*1024*1024){showNotificationError("File size exceeds the 1MB limit.");return;}
const reader=new FileReader();reader.onload=function(e){imageToCrop.src=e.target.result;cropperModal.style.display="block";cropperModal.classList.add("pop-in");if(cropper){cropper.destroy();}
cropper=new Cropper(imageToCrop,{aspectRatio:1,viewMode:1,guides:false,center:false,highlight:false,background:false,autoCropArea:0.9,dragMode:"move",});};reader.readAsDataURL(uploadedFile);}});cropImageBtn.addEventListener("click",function(){if(cropper){const croppedCanvas=cropper.getCroppedCanvas({fillColor:"#ffffff",});const circleCanvas=document.createElement("canvas");const ctx=circleCanvas.getContext("2d");const radius=croppedCanvas.width/2;circleCanvas.width=croppedCanvas.width;circleCanvas.height=croppedCanvas.height;ctx.beginPath();ctx.arc(radius,radius,radius,0,2*Math.PI);ctx.clip();ctx.drawImage(croppedCanvas,0,0);circleCanvas.toBlob((blob)=>{const formData=new FormData();formData.append("avatar",blob,"avatar.png");fetch(uploadAvatarUrl,{method:"POST",headers:{"X-CSRFToken":getCookie("csrftoken"),},body:formData,}).then((response)=>{if(!response.ok){return response.json().then((data)=>{throw new Error(data.errors||"Unknown error");});}
return response.json();}).then((data)=>{if(data.success){showNotificationSuccess("Avatar updated successfully!");document.getElementById("currentAvatar").src=data.avatar_url;document.getElementById("profileIconImage").src=data.avatar_url;}else{showNotificationError(""+(data.errors||"Unknown error"));}
closeCropperModal.click();}).catch((error)=>{console.error("",error);showNotificationError(""+error.message);closeCropperModal.click();});});}});saveAvatarBtn.addEventListener("click",function(){if(selectedAvatar){fetch(selectedAvatar).then((response)=>response.blob()).then((blob)=>{const formData=new FormData();formData.append("avatar",blob,"avatar.png");fetch(uploadAvatarUrl,{method:"POST",headers:{"X-CSRFToken":getCookie("csrftoken"),},body:formData,}).then((response)=>{if(!response.ok){return response.json().then((data)=>{throw new Error(data.errors||"Unknown error");});}
return response.json();}).then((data)=>{if(data.success){showNotificationSuccess("Avatar updated successfully!");document.getElementById("currentAvatar").src=data.avatar_url;document.getElementById("profileIconImage").src=data.avatar_url;}else{showNotificationError(""+(data.errors||"Unknown error"));}}).catch((error)=>{console.error("",error);showNotificationError(""+error.message);});});}else{showNotificationError("Select or upload your avatar.");}});cancelCropBtn.addEventListener("click",function(){closeCropperModal.click();});closeCropperModal.addEventListener("click",function(){cropperModal.classList.remove("pop-in");cropperModal.classList.add("pop-out");setTimeout(()=>{cropperModal.style.display="none";cropperModal.classList.remove("pop-out");if(cropper){cropper.destroy();}},300);});function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==""){const cookies=document.cookie.split(";");for(let i=0;cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}
function showNotificationSuccess(message){const dialogBox=document.getElementById("notificationSuccessBox");const dialogContent=document.getElementById("notificationSuccessContent");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");avatarModal.classList.add("slide-upSolid");avatarModal.classList.remove("slide-downSolid");},300);},3000);}
function showNotificationError(message){const dialogBox=document.getElementById("notificationErrorBox");const dialogContent=document.getElementById("notificationErrorContent");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
cancelAvatarBtn.addEventListener("click",function(){avatarModal.classList.add("slide-upSolid");avatarModal.classList.remove("slide-downSolid");});closeAvatarModal.addEventListener("click",function(){avatarModal.classList.add("slide-upSolid");avatarModal.classList.remove("slide-downSolid");});});const newPasswordInput=document.getElementById("newPassword");const repeatPasswordInput=document.getElementById("repeatPassword");const currentPasswordInput=document.getElementById("currentPassword");const strengthBar=document.getElementById("strengthBar");const generatePasswordBtn=document.getElementById("generatePassword");const passwordForm=document.getElementById("passwordForm");newPasswordInput.addEventListener("input",function(){const password=newPasswordInput.value;const strength=calculatePasswordStrength(password);updateStrengthBar(strength);});generatePasswordBtn.addEventListener("click",function(){const generatedPassword=generateSecurePassword();newPasswordInput.value=generatedPassword;repeatPasswordInput.value=generatedPassword;const strength=calculatePasswordStrength(generatedPassword);updateStrengthBar(strength);});passwordForm.addEventListener("submit",function(event){event.preventDefault();const currentPassword=currentPasswordInput.value;const newPassword=newPasswordInput.value;const repeatPassword=repeatPasswordInput.value;if(newPassword!==repeatPassword){updatepassError("Passwords do not match.");return;}
const data={current_password:currentPassword,new_password:newPassword,repeat_new_password:repeatPassword,};fetch("/password_manager/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},body:JSON.stringify(data),}).then((response)=>response.json()).then((data)=>{if(data.success){updatepassSuccess("Password updated successfully!");passwordForm.reset();updateStrengthBar(0);}else{updatepassError("Please check your current password.");}}).catch((error)=>{console.error("Error:",error);updatepassError("Please check your current password.");});});function calculatePasswordStrength(password){let strength=0;if(password.length>=8)strength+=1;if(/[A-Z]/.test(password))strength+=1;if(/[0-9]/.test(password))strength+=1;if(/[^A-Za-z0-9]/.test(password))strength+=1;return strength;}
function updateStrengthBar(strength){const colors=["#ff4b4b","#ffb74b","#fff44b","#b4ff4b","#4bff4b"];strengthBar.style.width=strength*25+"%";strengthBar.style.backgroundColor=colors[strength];}
function generateSecurePassword(){const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";let password="";for(let i=0;i<12;i++){password+=chars.charAt(Math.floor(Math.random()*chars.length));}
return password;}
function updatepassSuccess(message){const dialogBox=document.getElementById("updatepasssuccess");const dialogContent=document.getElementById("updatepasssuccessContent");dialogContent.innerHTML=message;dialogBox.style.display="block";setTimeout(()=>{dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
function updatepassError(message){const dialogBox=document.getElementById("updatepasserror");const dialogContent=document.getElementById("updatepasserrorContent");dialogContent.innerHTML=message;dialogBox.style.display="block";setTimeout(()=>{dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
if(document.body.classList.contains("authenticated")){startSessionTimer();}
function startSessionTimer(){document.addEventListener("mousemove",resetTimer);document.addEventListener("keypress",resetTimer);const sessionTimeout=30*60*1000;let timeout;function resetTimer(){clearTimeout(timeout);timeout=setTimeout(endSession,sessionTimeout);}
function endSession(){showError("Session Expired, Please log in again.","session");fetch("/logout/",{method:"POST",headers:{"X-CSRFToken":csrftoken,},}).then((response)=>response.json()).then((data)=>{if(data.success){}});}
resetTimer();}
function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==""){const cookies=document.cookie.split(";");for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}
const csrftoken=getCookie("csrftoken");var loginModal=document.getElementById("loginModal");var registerModal=document.getElementById("registerModal");var loginRequiredModal=document.getElementById("loginRequiredModal");var openLoginModalButton=document.getElementById("openLoginModal");var overlay=document.getElementById("overlay");var loginLink=document.getElementById("loginLink");var registerLink=document.getElementById("registerLink");var closeLoginModal=document.getElementById("closeLoginModal");var closeRegisterModal=document.getElementById("closeRegisterModal");var loginLinkFromRegister=document.getElementById("loginLinkFromRegister");if(loginLink){loginLink.onclick=function(event){event.preventDefault();loginModal.style.display="block";overlay.style.display="flex";setTimeout(()=>{loginModal.classList.add("pop-in");overlay.classList.add("fade-in");},10);};}
if(registerLink){registerLink.onclick=function(event){event.preventDefault();registerModal.style.display="block";overlay.style.display="flex";setTimeout(()=>{registerModal.classList.add("pop-in");overlay.classList.add("fade-in");},10);};}
if(loginLinkFromRegister){loginLinkFromRegister.onclick=function(event){event.preventDefault();registerModal.classList.add("pop-out");setTimeout(()=>{registerModal.style.display="none";registerModal.classList.remove("pop-out");loginModal.style.display="block";setTimeout(()=>{loginModal.classList.add("pop-in");overlay.classList.add("fade-in");},10);},300);};}
if(closeLoginModal){closeLoginModal.onclick=function(){loginModal.classList.add("pop-out");overlay.classList.add("fade-out");setTimeout(()=>{loginModal.style.display="none";overlay.style.display="none";loginModal.classList.remove("pop-in","pop-out");overlay.classList.remove("fade-in","fade-out");},300);};}
if(closeRegisterModal){closeRegisterModal.onclick=function(){registerModal.classList.add("pop-out");loginModal.classList.add("pop-out");overlay.classList.add("fade-out");setTimeout(()=>{registerModal.style.display="none";loginModal.style.display="none";overlay.style.display="none";registerModal.classList.remove("pop-in","pop-out");loginModal.classList.remove("pop-in","pop-out");overlay.classList.remove("fade-in","fade-out");},300);};}
var expressFeelingsButton=document.getElementById("loginButton");if(expressFeelingsButton){expressFeelingsButton.onclick=function(event){event.preventDefault();loginRequiredModal.style.display="block";overlay.style.display="flex";setTimeout(()=>{loginRequiredModal.classList.add("pop-in");overlay.classList.add("fade-in");},10);};}
window.onclick=function(event){if(event.target==overlay){if(loginRequiredModal.style.display==="block"||document.querySelector(".flat-ui-dialog.session").style.display==="block"){closeModals();}}};function closeModals(){if(loginRequiredModal.style.display==="block"){loginRequiredModal.classList.add("pop-out");overlay.classList.add("fade-out");setTimeout(()=>{loginRequiredModal.style.display="none";overlay.style.display="none";loginRequiredModal.classList.remove("pop-in","pop-out");overlay.classList.remove("fade-in","fade-out");},300);}else if(document.querySelector(".flat-ui-dialog.session").style.display==="block"){const sessionDialogBox=document.querySelector(".flat-ui-dialog.session");sessionDialogBox.classList.add("pop-out");overlay.classList.add("fade-in");setTimeout(()=>{sessionDialogBox.style.display="none";overlay.style.display="none";sessionDialogBox.classList.remove("pop-in","pop-out");overlay.classList.remove("fade-in","fade-out");window.location.reload();},300);}}
if(openLoginModalButton){openLoginModalButton.onclick=function(){loginRequiredModal.classList.add("pop-out");setTimeout(()=>{loginRequiredModal.style.display="none";loginRequiredModal.classList.remove("pop-out");loginModal.style.display="block";setTimeout(()=>{loginModal.classList.add("pop-in");},10);},300);};}
function showError(message,type){const dialogBox=document.getElementById(type==="login"?"loginDialogBox":type==="register"?"registerDialogBox":"sessionDialogBox");const dialogContent=document.getElementById(type==="login"?"loginDialogContent":type==="register"?"registerDialogContent":"sessionDialogContent");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.add("error");dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");if(type==="session"){const overlay=document.getElementById("sessionOverlay");overlay.style.display="flex";overlay.classList.add("show");overlay.classList.remove("hide");function handleOverlayClick(event){if(!dialogBox.contains(event.target)){dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");overlay.classList.remove("show");overlay.classList.add("hide");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");overlay.style.display="none";overlay.classList.remove("hide");overlay.removeEventListener("click",handleOverlayClick);window.location.reload();},300);}}
overlay.addEventListener("click",handleOverlayClick);}else{setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}}
function showSuccess(message,type){const successBox=document.getElementById(type==="login"?"loginSuccessBox":type==="register"?"registerSuccessBox":"logoutSuccessBox");const successContent=document.getElementById(type==="login"?"loginSuccessContent":type==="register"?"registerSuccessContent":"logoutSuccessContent");successContent.innerHTML=message;successBox.style.display="block";successBox.classList.add("success");successBox.classList.remove("pop-out");successBox.classList.add("pop-in");setTimeout(()=>{successBox.classList.remove("pop-in");successBox.classList.add("pop-out");setTimeout(()=>{successBox.style.display="none";successBox.classList.remove("pop-out");if(type==="login"){window.location.reload();}},300);},3000);if(type==="logout"){overlay.addEventListener("click",function handleOverlayClick(){successBox.classList.add("pop-out");overlay.classList.add("fade-out");setTimeout(()=>{successBox.style.display="none";successBox.classList.remove("pop-out");overlay.style.display="none";overlay.classList.remove("fade-in","fade-out");overlay.removeEventListener("click",handleOverlayClick);window.location.reload();},300);});}}
function parseErrorMessages(errors){for(let field in errors){if(errors.hasOwnProperty(field)){return errors[field][0].message;}}
return"An error occurred. Please try again.";}
document.addEventListener("DOMContentLoaded",function(){const loginForm=document.getElementById("loginForm");const registerForm=document.getElementById("registerForm");const loginButton=document.getElementById("loginButton");const signupButton=document.getElementById("signupButton");const loginUsernameField=loginForm.querySelector('input[name="username"]');const loginPasswordField=loginForm.querySelector('input[name="password"]');const registerFields={student_id:registerForm.querySelector('input[name="student_id"]'),username:registerForm.querySelector('input[name="username"]'),full_name:registerForm.querySelector('input[name="full_name"]'),academic_year_level:registerForm.querySelector('input[name="academic_year_level"]'),contact_number:registerForm.querySelector('input[name="contact_number"]'),email:registerForm.querySelector('input[name="email"]'),password1:registerForm.querySelector('input[name="password1"]'),password2:registerForm.querySelector('input[name="password2"]'),};loginUsernameField.addEventListener("input",function(){validateField(loginUsernameField);});loginPasswordField.addEventListener("input",function(){validateField(loginPasswordField);});Object.values(registerFields).forEach((field)=>{field.addEventListener("input",function(){validateField(field);});});loginForm.addEventListener("submit",function(event){event.preventDefault();loginButton.disabled=true;const formData=new FormData(loginForm);let errorMessage=checkEmptyFields(formData,{username:"Username",password:"Password",});if(errorMessage){validateFieldOnSubmit(loginUsernameField);validateFieldOnSubmit(loginPasswordField);showError(errorMessage,"login");loginButton.disabled=false;return;}});registerForm.addEventListener("submit",function(event){event.preventDefault();signupButton.disabled=true;const formData=new FormData(registerForm);let errorMessage=checkEmptyFields(formData,{student_id:"Student ID No.",username:"Username",full_name:"Full Name",academic_year_level:"Academic Year Level",contact_number:"Contact Number",email:"Email",password1:"Password",password2:"Confirm Password",});if(errorMessage){Object.values(registerFields).forEach((field)=>{validateFieldOnSubmit(field);});showError(errorMessage,"register");signupButton.disabled=false;return;}});function validateField(field){if(field.value.trim()===""){field.classList.remove("valid");field.classList.add("invalid");}else{field.classList.remove("invalid");field.classList.add("valid");}}
function validateFieldOnSubmit(field){if(field.value.trim()===""){field.classList.add("invalid");}else{field.classList.remove("invalid");field.classList.add("valid");}}
function checkEmptyFields(formData,fields){let emptyFields=[];let allFieldsEmpty=true;for(let field in fields){if(formData.get(field)&&formData.get(field).trim()!==""){allFieldsEmpty=false;}else{emptyFields.push(fields[field]+" is required.");}}
if(allFieldsEmpty){return"All fields are required.";}
return emptyFields.length?emptyFields[0]:null;}});document.addEventListener("DOMContentLoaded",function(){const usernameField=document.querySelector('input[name="username"]');const passwordField=document.querySelector('input[name="password"]');const loginButton=document.getElementById("loginButton");usernameField.addEventListener("input",validateField);passwordField.addEventListener("input",validateField);document.getElementById("loginForm").addEventListener("submit",function(event){event.preventDefault();const formData=new FormData(this);loginButton.disabled=true;let errorMessage=checkEmptyFields(formData,{username:"Username",password:"Password",});if(errorMessage){validateFieldOnSubmit(usernameField);validateFieldOnSubmit(passwordField);showError(errorMessage,"login");loginButton.disabled=false;return;}
showLoginLoader();fetch(this.action,{method:"POST",headers:{"X-CSRFToken":csrftoken,"Content-Type":"application/x-www-form-urlencoded",},body:new URLSearchParams(formData).toString(),}).then((response)=>response.json()).then((data)=>{hideLoginLoader();if(data.success){showSuccess("Login successful!","login");setTimeout(()=>{document.getElementById("loginForm").reset();loginModal.classList.add("pop-out");overlay.classList.add("fade-in");setTimeout(()=>{loginModal.style.display="none";overlay.style.display="none";loginModal.classList.remove("pop-in","pop-out");overlay.classList.remove("fade-in","fade-out");window.location.href=data.redirect_url;},300);},1500);}else{let errorMessage=parseErrorMessages(data.error_message);showError(errorMessage,"login");}}).catch((error)=>{hideLoginLoader();showError("An error occurred. Please try again.","login");}).finally(()=>{setTimeout(()=>{loginButton.disabled=false;},3600);});});function validateField(event){const field=event.target;validateFieldStatus(field);}
function validateFieldStatus(field){if(field.value.trim()===""){field.classList.remove("valid");field.classList.add("invalid");}else{field.classList.remove("invalid");field.classList.add("valid");}}
function validateFieldOnSubmit(field){if(field.value.trim()===""){field.classList.add("invalid");}else{field.classList.remove("invalid");field.classList.add("valid");}}
function showLoginLoader(){const loginOverlay=document.getElementById("loginOverlay");loginOverlay.style.display="block";}
function hideLoginLoader(){const loginOverlay=document.getElementById("loginOverlay");loginOverlay.style.display="none";}});document.querySelectorAll(".logout-link").forEach((item)=>{item.addEventListener("click",function(event){event.preventDefault();this.style.pointerEvents="none";fetch(this.href,{method:"POST",headers:{"X-CSRFToken":csrftoken,},}).then((response)=>response.json()).then((data)=>{if(data.success){showSuccess("Logout successful!","logout");setTimeout(()=>{document.getElementById("logoutSuccessBox").classList.add("pop-out");overlay.classList.add("fade-out");setTimeout(()=>{document.getElementById("logoutSuccessBox").style.display="none";overlay.style.display="none";document.getElementById("logoutSuccessBox").classList.remove("pop-in","pop-out");overlay.classList.remove("fade-in","fade-out");window.location.href=data.redirect_url;},300);},1500);}else{window.location.reload();}}).catch((error)=>{window.location.reload();});});});function checkEmptyFields(formData,fields){let emptyFields=[];let allFieldsEmpty=true;for(let field in fields){if(formData.get(field)&&formData.get(field).trim()!==""){allFieldsEmpty=false;}else{emptyFields.push(fields[field]+" is required.");}}
if(allFieldsEmpty){return"All fields are required.";}
return emptyFields.length?emptyFields[0]:null;}
function showPolicyModal(){const policyModal=document.getElementById("policyModal");const policyOverlay=document.getElementById("policyOverlay");policyModal.style.display="block";policyOverlay.style.display="block";policyModal.classList.remove("pop-out");policyModal.classList.add("pop-in");}
function closePolicyModal(){const policyModal=document.getElementById("policyModal");const policyOverlay=document.getElementById("policyOverlay");policyModal.classList.remove("pop-in");policyModal.classList.add("pop-out");setTimeout(()=>{policyModal.style.display="none";policyModal.classList.remove("pop-out");policyOverlay.style.display="none";},300);}
document.getElementById("showPolicy").addEventListener("click",showPolicyModal);document.getElementById("policyOverlay").addEventListener("click",closePolicyModal);document.querySelectorAll(".v1_124 div").forEach((item)=>{item.addEventListener("click",function(){document.querySelectorAll(".v1_127, .v1_129, .v1_131, .v1_133, .v1_135, .v1_137, .v1_139, .v1_141").forEach((span)=>{span.classList.remove("active");});this.querySelector("span").classList.add("active");});});document.querySelectorAll(".curved-line path").forEach(function(path){var controlPointX1=Math.random()*50;var controlPointY1=Math.random()*50;var controlPointX2=100-Math.random()*50;var controlPointY2=Math.random()*50;var endPointX=Math.random()*100;var endPointY=Math.random()*100;var d=`M0,0 C${controlPointX1},${controlPointY1} ${controlPointX2},${controlPointY2} ${endPointX},${endPointY}`;path.setAttribute("d",d);});document.addEventListener("DOMContentLoaded",function(){const usernameField=document.getElementById("username");const contactNumberField=document.getElementById("contact-number");const emailField=document.getElementById("email");const academicYearField=document.getElementById("academic-year");const profileIcon=document.getElementById("profileIcon");const tooltip=document.getElementById("profileTooltip");const avatarModal=document.getElementById("avatarModal");profileIcon.addEventListener("mouseenter",function(){tooltip.classList.remove("popOut");tooltip.classList.add("popIn");tooltip.style.visibility="visible";});profileIcon.addEventListener("mouseleave",function(){tooltip.classList.remove("popIn");tooltip.classList.add("popOut");tooltip.addEventListener("animationend",function(){tooltip.style.visibility="hidden";},{once:true});});profileIcon.addEventListener("click",function(){avatarModal.classList.add("slide-downSolid");avatarModal.classList.remove("slide-upSolid");avatarModal.style.display="block";});document.getElementById("profileLink").addEventListener("click",function(){fetchUserProfile();profileModal.style.display="block";});const refreshAvatarBtn=document.getElementById("refreshAvatarBtn");refreshAvatarBtn.addEventListener("click",function(){fetchUserProfile();});const tips=["Keep your contact info updated for important notifications.","Make sure your academic year is accurate for proper service.","Use a unique email for account recovery.","Double-check your email to receive all communications.","Update your profile to avoid service disruptions.","Review your academic year each term for accuracy.","Update your contact number immediately if it changes.","Ensure your username is unique and memorable.","Use your most active email for notifications.","Verify your contact info regularly for smooth communication.","Check your spam folder for missed notifications.","Ensure your profile picture is appropriate and clear.","Log out of your account after using shared devices.","Keep your mailing address updated for physical notifications.","Make sure your name matches official documents.","Check your profile for any incomplete details.","Update your emergency contacts regularly for safety.","Review your email verification status for security.","Notify support if any personal details seem incorrect.","Ensure your student ID is correct for institutional access.","Refresh your avatar regularly to keep your profile current.","Complete your profile to unlock all features and services.","Review profile settings after every major update.",];function displayRandomTip(){const randomIndex=Math.floor(Math.random()*tips.length);const randomTipElement=document.getElementById("randomTip");randomTipElement.classList.remove("pop-in");setTimeout(()=>{randomTipElement.innerText=`Tip: ${tips[randomIndex]}`;randomTipElement.classList.add("pop-in");},10);}
setInterval(displayRandomTip,5000);function fetchUserProfile(){const avatarLoader=document.getElementById("avatarLoader");const profileIconImage=document.getElementById("profileIconImage");const placeholderUrl=profileIconImage.src;avatarLoader.style.display="block";profileIconImage.style.display="none";fetch("/get_user_profile/").then((response)=>response.json()).then((data)=>{document.getElementById("student-id").value=data.student_id;document.getElementById("username").value=data.username;document.getElementById("full-name").value=data.full_name;document.getElementById("academic-year").value=data.academic_year_level;document.getElementById("contact-number").value=data.contact_number;document.getElementById("email").value=maskEmail(data.email);profileIconImage.src=data.avatar||placeholderUrl;profileIconImage.onload=()=>{avatarLoader.style.display="none";profileIconImage.style.display="block";};}).catch((error)=>{console.error("Error fetching profile data:",error);avatarLoader.style.display="none";profileIconImage.style.display="block";});}
function showProfileSuccess(message){const dialogBox=document.getElementById("profileSuccessDialog");const dialogContent=document.getElementById("profileSuccessContent");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
function showProfileError(message){const dialogBox=document.getElementById("profileErrorDialog");const dialogContent=document.getElementById("profileErrorContent");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
const updateProfileBtn=document.getElementById("updateProfileBtn");const confirmUpdateDialog=document.getElementById("confirmUpdateDialog");const confirmUpdateBtn=document.getElementById("confirmUpdateBtn");const cancelUpdateBtn=document.getElementById("cancelUpdateBtn");updateProfileBtn.addEventListener("click",function(event){event.preventDefault();confirmUpdateDialog.style.display="block";confirmUpdateDialog.classList.remove("pop-out");confirmUpdateDialog.classList.add("pop-in");});confirmUpdateBtn.addEventListener("click",function(event){event.preventDefault();confirmUpdateDialog.classList.remove("pop-in");confirmUpdateDialog.classList.add("pop-out");setTimeout(()=>{confirmUpdateDialog.style.display="none";},300);updateUserProfile(event);});cancelUpdateBtn.addEventListener("click",function(event){event.preventDefault();confirmUpdateDialog.classList.remove("pop-in");confirmUpdateDialog.classList.add("pop-out");setTimeout(()=>{confirmUpdateDialog.style.display="none";},300);});function updateUserProfile(event){event.preventDefault();const username=document.getElementById("username").value;const contactNumber=document.getElementById("contact-number").value;const academicYear=document.getElementById("academic-year").value;const profileUpdateOverlay=document.getElementById("profileupdateOverlay");profileUpdateOverlay.style.display="block";fetch("/update_user_profile/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},body:JSON.stringify({username:username,contact_number:contactNumber,academic_year_level:academicYear,}),}).then((response)=>response.json()).then((data)=>{profileUpdateOverlay.style.display="none";if(data.success){showProfileSuccess("Profile updated successfully!");}else{showProfileError(data.errors||"Error updating profile.");}}).catch((error)=>{profileUpdateOverlay.style.display="none";console.error("Error updating profile:",error);showProfileError("Error updating profile. Please try again.");});}
document.getElementById("profileForm").addEventListener("submit",updateUserProfile);document.getElementById("profileLink").addEventListener("click",function(){fetchUserProfile();profileModal.style.display="block";});const verifyEmailBtn=document.getElementById("verifyEmailBtn");const emailVerifiedLabel=document.getElementById("emailVerifiedLabel");const resendCooldownLabel=document.getElementById("resendCooldownLabel");const cooldownTimer=document.getElementById("cooldownTimer");const verifyemailOverlay=document.getElementById("verifyemailOverlay");const changeemailSuccessBox=document.getElementById("changeemailSuccessBox");const changeemailErrorBox=document.getElementById("changeemailErrorBox");const verifyemailSuccessBox=document.getElementById("verifyemailSuccessBox");const verifyemailErrorBox=document.getElementById("verifyemailErrorBox");let cooldownInterval;const changeEmailBtn=document.getElementById("changeEmailBtn");const changeEmailDialog=document.getElementById("changeEmailDialog");const verifyNewEmailBtn=document.getElementById("verifyNewEmailBtn");const cancelChangeEmailBtn=document.getElementById("cancelChangeEmailBtn");const resendEmailCooldownLabel=document.getElementById("resendEmailCooldownLabel");let emailCooldownInterval;const resendNewEmailCooldownLabel=document.getElementById("resendNewEmailCooldownLabel");const cooldownNewEmailTimer=document.getElementById("cooldownNewEmailTimer");changeEmailBtn.addEventListener("click",function(){changeEmailDialog.classList.remove("pop-out");changeEmailDialog.classList.add("pop-in");changeEmailDialog.style.display="block";});cancelChangeEmailBtn.addEventListener("click",function(){changeEmailDialog.classList.remove("pop-in");changeEmailDialog.classList.add("pop-out");setTimeout(()=>{changeEmailDialog.style.display="none";},300);});function startNewEmailCooldown(seconds){resendNewEmailCooldownLabel.style.display="inline";cooldownNewEmailTimer.textContent=seconds;emailCooldownInterval=setInterval(()=>{seconds--;cooldownNewEmailTimer.textContent=seconds;if(seconds<=0){clearInterval(emailCooldownInterval);resendNewEmailCooldownLabel.style.display="none";verifyNewEmailBtn.innerText="Resend";verifyNewEmailBtn.style.display="inline-block";}},1000);}
function validateEmail(email){const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return re.test(String(email).toLowerCase());}
verifyNewEmailBtn.addEventListener("click",function(event){event.preventDefault();const newEmail=document.getElementById("new-email").value;if(!validateEmail(newEmail)){showChangeEmailError("Invalid email format.");return;}
const changeemailOverlay=document.getElementById("changeemailOverlay");changeemailOverlay.style.display="block";fetch("/request_email_change/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},body:JSON.stringify({new_email:newEmail}),}).then((response)=>response.json()).then((data)=>{changeemailOverlay.style.display="none";if(data.success){verifyNewEmailBtn.style.display="none";startNewEmailCooldown(60);showChangeEmailSuccess("Verification for email sent! Please check your inbox.");}else{showChangeEmailError(data.error||"Failed to update the email.");}}).catch((error)=>{console.error("Error:",error);changeemailOverlay.style.display="none";showChangeEmailError("An error occurred while sending the email change request.");});});document.getElementById("verifyEmailBtn").addEventListener("click",function(event){event.preventDefault();const emailField=document.getElementById("email");const email=emailField.value;if(!validateEmail(email)){showVerifyEmailError("Invalid email format.");return;}
const verifyemailOverlay=document.getElementById("verifyemailOverlay");verifyemailOverlay.style.display="block";fetch("/send_verification_email/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},body:JSON.stringify({email:email}),}).then((response)=>response.json()).then((data)=>{verifyemailOverlay.style.display="none";if(data.success){showVerifyEmailSuccess("Verification email sent! Please check your inbox.");}else{showVerifyEmailError(data.error||"Failed to send verification email.");}}).catch((error)=>{console.error("Error:",error);verifyemailOverlay.style.display="none";showVerifyEmailError("An error occurred while sending the verification email.");});});function maskEmail(email){const[localPart,domainPart]=email.split("@");const maskedLocal=localPart.slice(0,1)+"*****";const maskedDomain="*****."+domainPart.split(".").pop();return maskedLocal+"@"+maskedDomain;}
function startCooldown(seconds){resendCooldownLabel.style.display="inline";cooldownTimer.textContent=seconds;cooldownInterval=setInterval(()=>{seconds--;cooldownTimer.textContent=seconds;if(seconds<=0){clearInterval(cooldownInterval);resendCooldownLabel.style.display="none";showResendButton();}},1000);}
function showResendButton(){const resendBtn=document.createElement("button");resendBtn.innerText="Resend";resendBtn.classList.add("verify-btn");resendBtn.addEventListener("click",function(event){event.stopPropagation();event.preventDefault();startCooldown(60);resendBtn.style.display="none";sendVerificationEmail();});document.querySelector(".email-container").appendChild(resendBtn);}
function sendVerificationEmail(){const email=document.getElementById("email").value;verifyemailOverlay.style.display="block";fetch("/send_verification_email/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},body:JSON.stringify({email:email}),}).then((response)=>response.json()).then((data)=>{verifyemailOverlay.style.display="none";if(data.success){showVerifyEmailSuccess("Verification email sent! Please check your inbox.");}else{showVerifyEmailError("Error sending verification email.");}}).catch((error)=>{verifyemailOverlay.style.display="none";showVerifyEmailError("An error occurred while sending the verification email.");});}
function showVerifyEmailSuccess(message){const dialogBox=document.getElementById("verifyemailSuccessBox");const dialogContent=document.getElementById("verifyemailSuccessContent");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
function showVerifyEmailError(message){const dialogBox=document.getElementById("verifyemailErrorBox");const dialogContent=document.getElementById("verifyemailErrorContent");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
function showChangeEmailSuccess(message){const dialogBox=document.getElementById("changeemailSuccessBox");const dialogContent=document.getElementById("changeemailSuccessBox");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
function showChangeEmailError(message){const dialogBox=document.getElementById("changeemailErrorBox");const dialogContent=document.getElementById("changeemailErrorBox");dialogContent.innerHTML=message;dialogBox.style.display="block";dialogBox.classList.remove("pop-out");dialogBox.classList.add("pop-in");setTimeout(()=>{dialogBox.classList.remove("pop-in");dialogBox.classList.add("pop-out");setTimeout(()=>{dialogBox.style.display="none";dialogBox.classList.remove("pop-out");},300);},3000);}
verifyEmailBtn.addEventListener("click",function(event){event.stopPropagation();event.preventDefault();verifyEmailBtn.style.display="none";startCooldown(60);sendVerificationEmail();});function checkEmailVerificationStatus(){fetch("/check_email_verification/").then((response)=>response.json()).then((data)=>{if(data.is_verified){verifyEmailBtn.style.display="none";emailVerifiedLabel.style.display="inline";}else{verifyEmailBtn.style.display="inline";emailVerifiedLabel.style.display="none";}}).catch((error)=>console.error("Error checking email verification:",error));}
document.getElementById("profileLink").addEventListener("click",function(){checkEmailVerificationStatus();});const notificationButton=document.getElementById("notificationButton");const notificationDot=document.getElementById("notificationDot");const notificationList=document.getElementById("notificationList");const notificationItems=document.getElementById("notificationItems");const loadMoreButton=document.getElementById("notificationLoadMore");let currentPage=1;let totalPages=1;let renderedNotifications=new Map();function showNotificationLoader(){const loader=document.createElement("div");loader.className="loader-placeholder";for(let i=0;i<3;i++){const loaderItem=document.createElement("div");loaderItem.className="loader-item";loaderItem.innerHTML=`
      <div class="loader-item-avatar"></div>
      <div class="loader-item-content"></div>
      <div class="loader-item-timestamp"></div>
    `;loader.appendChild(loaderItem);}
notificationItems.appendChild(loader);}
function removeNotificationLoader(){const loader=document.querySelector(".loader-placeholder");if(loader){loader.remove();}}
async function fetchNotifications(page=1){try{showNotificationLoader();const response=await fetch(`/notifications/fetch/?page=${page}`);if(response.ok){const data=await response.json();totalPages=data.total_pages;return data.notifications;}else{console.error("Failed to fetch notifications.");return[];}}catch(error){console.error("Error fetching notifications:",error);return[];}finally{removeNotificationLoader();}}
async function markNotificationButtonClicked(){try{const response=await fetch(`/notifications/mark_button_clicked/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCSRFToken(),},});if(!response.ok){console.error("Failed to mark notification button as clicked.");}else{notificationDot.style.display="none";}}catch(error){console.error("Error marking notification button as clicked:",error);}}
async function markNotificationAsRead(notificationId){try{let cleanNotificationId=notificationId.replace("status_","").replace("replies_","");const response=await fetch(`/notifications/mark_as_read/${cleanNotificationId}/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCSRFToken(),},});if(!response.ok){console.error("Failed to mark notification as read.");}else{renderedNotifications.get(notificationId).is_read=true;}}catch(error){console.error("Error marking notification as read:",error);}}
function getCSRFToken(){return document.querySelector("[name=csrfmiddlewaretoken]").value;}
async function renderNotifications(page=1){const notifications=await fetchNotifications(page);if(notifications.length===0){loadMoreButton.style.display="none";return;}
notifications.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));let hasUnreadNotifications=false;notifications.forEach((notification)=>{if(!renderedNotifications.has(notification.id)){const item=document.createElement("div");item.classList.add("notification-item");item.dataset.id=notification.id;if(!notification.is_read){item.classList.add("unread");hasUnreadNotifications=true;}else{item.classList.add("read");}
item.addEventListener("click",async function(){const notificationId=item.dataset.id;if(!notification.is_read){await markNotificationAsRead(notificationId);item.classList.remove("unread");item.classList.add("read");const greenDot=item.querySelector(".notification-dot-green");if(greenDot){greenDot.remove();}
item.querySelector(".timestamp").classList.remove("timestamp-green");}
window.location.href=notification.link;});item.innerHTML=`
          <img class="notification-avatar" src="${
            notification.avatar
          }" alt="Avatar">
          <div class="notification-content">
            <div class="message">${notification.message}</div>
            <div class="timestamp ${
              notification.is_read ? "" : "timestamp-green"
            }">
              ${formatTimestamp(notification.timestamp)}
            </div>
          </div>
          ${
            notification.is_read
              ? ""
              : '<div class="notification-dot-green"></div>'
          }
        `;notificationItems.appendChild(item);renderedNotifications.set(notification.id,notification);}});if(currentPage<totalPages){loadMoreButton.style.display="block";}else{loadMoreButton.style.display="none";}
if(hasUnreadNotifications){notificationDot.style.display="block";notificationDot.classList.add("blink");}else{notificationDot.style.display="none";}}
async function checkNotificationStatus(){try{const response=await fetch(`/notifications/check_status/`);if(response.ok){const data=await response.json();if(data.has_unread_notifications&&!data.has_clicked_notification){notificationDot.style.display="block";notificationDot.classList.add("blink");}else{notificationDot.style.display="none";}}}catch(error){console.error("Error checking notification status:",error);}}
notificationButton.addEventListener("click",async function(){if(notificationList.style.display==="none"){await renderNotifications(currentPage);notificationList.classList.remove("pop-up");notificationList.classList.add("animated");notificationList.style.display="block";await markNotificationButtonClicked();}else{notificationList.classList.remove("animated");notificationList.classList.add("pop-up");setTimeout(()=>{notificationList.style.display="none";},300);}});loadMoreButton.addEventListener("click",async function(){currentPage++;await renderNotifications(currentPage);notificationList.style.maxHeight="700px";notificationList.style.overflowY="auto";});function formatTimestamp(timestamp){if(timestamp.includes("0 minutes ago")){return"Just Now";}
return timestamp;}
setInterval(async()=>{const notifications=await fetchNotifications();const hasUnread=notifications.some((notification)=>!notification.is_read);if(hasUnread){notificationDot.style.display="block";notificationDot.classList.add("blink");}},60000);window.addEventListener("click",function(event){if(!notificationButton.contains(event.target)&&!notificationList.contains(event.target)){if(notificationList.style.display==="block"){notificationList.classList.remove("animated");notificationList.classList.add("pop-up");setTimeout(()=>{notificationList.style.display="none";},300);}}});renderNotifications();checkNotificationStatus();});;const burger=document.getElementById("burger");const dropdown=document.querySelector(".dropdown");const profileLink=document.getElementById("profileLink");const profileModal=document.getElementById("profileModal");const closeProfileModal=document.getElementById("closeProfileModal");const avatarLink=document.getElementById("avatarLink");const avatarModal=document.getElementById("avatarModal");const closeAvatarModal=document.getElementById("closeAvatarModal");const passwordLink=document.getElementById("passwordLink");const passwordModal=document.getElementById("passwordModal");const closePasswordModal=document.getElementById("closePasswordModal");const statusModal=document.getElementById("statusModal");const statusModalOverlay=document.getElementById("statusModalOverlay");const closeStatusModal=document.getElementById("closeStatusModal");const descriptionDiv=document.getElementById("description");var statusComposerButton=document.getElementById("statuscomposer");var floatingButton=document.getElementById("floatingButton");var chatPopup=document.getElementById("chatPopup");var isDragging=false;var isOpen=false;var startX,startY,initialX,initialY;function updateChatPosition(){var buttonRect=floatingButton.getBoundingClientRect();chatPopup.style.bottom=window.innerHeight-buttonRect.bottom+70+"px";chatPopup.style.right=window.innerWidth-buttonRect.right+20+"px";}
window.addEventListener("resize",updateChatPosition);floatingButton.addEventListener("mousedown",function(e){isDragging=true;startX=e.clientX;startY=e.clientY;initialX=floatingButton.offsetLeft;initialY=floatingButton.offsetTop;document.addEventListener("mousemove",onMouseMove);document.addEventListener("mouseup",onMouseUp);floatingButton.style.animation="drag 0.5s infinite";});function onMouseMove(e){if(isDragging){var dx=e.clientX-startX;var dy=e.clientY-startY;floatingButton.style.left=initialX+dx+"px";floatingButton.style.top=initialY+dy+"px";updateChatPosition();}}
function onMouseUp(){isDragging=false;document.removeEventListener("mousemove",onMouseMove);document.removeEventListener("mouseup",onMouseUp);floatingButton.style.animation="float 3s ease-in-out infinite";}
floatingButton.addEventListener("click",function(){updateChatPosition();if(!isOpen){chatPopup.style.display="block";chatPopup.classList.remove("chatPopOut");chatPopup.classList.add("chatPopIn");floatingButton.firstElementChild.classList.add("icon-pop-out");setTimeout(()=>{floatingButton.firstElementChild.className="bx bx-x icon-pop-in";},300);isOpen=true;}else{chatPopup.classList.remove("chatPopIn");chatPopup.classList.add("chatPopOut");floatingButton.firstElementChild.classList.add("icon-pop-out");setTimeout(function(){chatPopup.style.display="none";floatingButton.firstElementChild.className="bx bxs-message icon-pop-in";},300);isOpen=false;}});let lastMessageTime=null;let greetingDisplayed=false;let currentQuestionIndex=-1;let sessionData=[];let sessionId=null;function restoreSession(){const chatBody=document.getElementById("chatBody");sessionData.forEach((message,index)=>{if(message.sender==="timestamp"){addTimestamp(chatBody,message.text);}else{generateMessage(message.text,message.sender);if(message.sender==="bot"&&message.questionIndex!==-1){currentQuestionIndex=message.questionIndex;}}});checkLatestMessageType();}
function renderChatSession(sessionData){const chatBody=document.getElementById("chatBody");chatBody.innerHTML="";sessionData.forEach((message)=>{generateMessage(message.text,message.sender);if(message.sender==="bot"&&message.questionIndex!==null){currentQuestionIndex=message.questionIndex;}});chatBody.scrollTop=chatBody.scrollHeight;}
document.getElementById("floatingButton").addEventListener("click",function(){document.getElementById("chatPopup").style.display="block";loadChatSession().then(()=>{if(!greetingDisplayed&&sessionData.length===0){displayGreeting();}else{restoreSession();}});});function displayGreeting(){const chatBody=document.getElementById("chatBody");showLoader(chatBody);setTimeout(function(){removeLoader(chatBody);addTimestampIfNeeded(chatBody);generateMessage("Hello! Welcome to Piracle, your emotional support companion. How can I assist you today? Should we start?","bot");saveChatSessionData("Hello! Welcome to Piracle, your emotional support companion. How can I assist you today? Should we start?","bot");setTimeout(displayOptions,500);greetingDisplayed=true;},1500);}
function displayOptions(){const chatBody=document.getElementById("chatBody");if(!document.getElementById("dialogOptions")){const optionsWrapper=document.createElement("div");optionsWrapper.className="message-wrapper options-wrapper pop-up";optionsWrapper.id="dialogOptions";const startButton=document.createElement("button");startButton.className="option-button";startButton.textContent="Start";startButton.onclick=function(){autoSendMessage("Start",optionsWrapper);};const notYetButton=document.createElement("button");notYetButton.className="option-button";notYetButton.textContent="Not Yet";notYetButton.onclick=function(){autoSendMessage("Not Yet",optionsWrapper);};optionsWrapper.appendChild(startButton);optionsWrapper.appendChild(notYetButton);chatBody.appendChild(optionsWrapper);chatBody.scrollTop=chatBody.scrollHeight;}}
function autoSendMessage(message,optionsWrapper){optionsWrapper.classList.remove("pop-up");optionsWrapper.classList.add("pop-down");setTimeout(()=>{optionsWrapper.remove();const chatInput=document.getElementById("chatInput");chatInput.value=message;sendMessage();},300);}
function sendMessage(){const chatInput=document.getElementById("chatInput");const chatBody=document.getElementById("chatBody");const messageText=chatInput.value;if(messageText.trim()!==""){generateMessage(messageText,"user");saveChatSessionData(messageText,"user");if(messageText.toLowerCase()==="start"){setTimeout(()=>{showLoader(chatBody);setTimeout(()=>{removeLoader(chatBody);displayQuestion(0);},1500);},1000);}else if(messageText.toLowerCase()==="not yet"){setTimeout(()=>{generateMessage("No worries, take your time.","bot");saveChatSessionData("No worries, take your time.","bot");},1000);}}
chatInput.value="";}
function startQuestionnaire(){setTimeout(()=>{showLoader(document.getElementById("chatBody"));setTimeout(()=>{removeLoader(document.getElementById("chatBody"));displayQuestion(0);},1500);},1000);}
function checkAndHandleAnswer(messageText){const answers=["Managing multiple assignments and deadlines.","Understanding difficult subjects or topics.","Balancing academics with extracurricular activities.","Generally positive, with only occasional low moods.","Mixed, with frequent ups and downs.","Often stressed or anxious.","Very comfortable, I often share how I’m feeling.","Somewhat comfortable, I share occasionally.","Not comfortable, I usually keep things to myself.","Almost daily, it’s a constant presence.","Occasionally, but only around stressful times like exams.","Rarely, I don’t get anxious easily.","Less than 6 hours, I often stay up late.","Between 6 and 8 hours, it varies.","More than 8 hours, I prioritize my sleep.","Very confident, I believe in my abilities.","Somewhat confident, but I have doubts sometimes.","Not very confident, I often worry about my performance.","Excited and ready to adapt.","Nervous but willing to adjust.","Stressed and resistant to change.","I create a schedule and stick to it as much as possible.","I try to balance things, but it’s a challenge.","I often struggle to manage my time effectively.","Highly motivated, I’m eager to succeed.","Moderately motivated, but it depends on the task.","Often unmotivated, I struggle to find the drive.","Yes, I know where to find help if I need it.","Somewhat, I’ve heard of some resources but haven’t explored them.","No, I’m not aware of the available resources.",];const answerIndex=answers.findIndex((answer)=>answer.toLowerCase()===messageText.toLowerCase());if(answerIndex!==-1&&currentQuestionIndex!==-1){handleAnswerSelection(currentQuestionIndex,answerIndex,answers[answerIndex]);}}
function showLoader(chatBody){const loaderElement=document.createElement("div");loaderElement.className="loader";loaderElement.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>';chatBody.appendChild(loaderElement);chatBody.scrollTop=chatBody.scrollHeight;}
function removeLoader(chatBody){const loaderElement=chatBody.querySelector(".loader");if(loaderElement){chatBody.removeChild(loaderElement);}}
function loadSession(){fetch("/load_session/").then((response)=>response.json()).then((data)=>{if(data.success){const chatBody=document.getElementById("chatBody");const sessionData=data.session_data;sessionData.forEach((message)=>{if(message.sender==="timestamp"){addTimestamp(chatBody,message.text);}else{generateMessage(message.text,message.sender);}});const lastMessage=sessionData[sessionData.length-1];if(lastMessage.sender==="bot"&&lastMessage.text.includes("Hello! Welcome to Piracle")){setTimeout(displayOptions,500);}else if(lastMessage.sender==="bot"&&currentQuestionIndex>=0&&currentQuestionIndex<questions.length){setTimeout(displayAnswerOptions,500,currentQuestionIndex);}}});}
function addTimestamp(chatBody,time){const sessionTimestamp=document.createElement("div");sessionTimestamp.className="session-timestamp";sessionTimestamp.textContent=time;chatBody.appendChild(sessionTimestamp);}
function saveSession(){fetch("/save_chat_session/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},body:JSON.stringify({session_data:sessionData,}),});}
function saveSession(){fetch("/save_chat_session/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},body:JSON.stringify({session_data:sessionData,}),});}
function generateMessage(text,sender){const chatBody=document.getElementById("chatBody");const messageWrapper=document.createElement("div");messageWrapper.className="message-wrapper";const messageElement=document.createElement("div");messageElement.className=sender==="user"?"user-message chat-message":"chatbot-message chat-message";messageElement.textContent=text;messageWrapper.appendChild(messageElement);chatBody.appendChild(messageWrapper);chatBody.scrollTop=chatBody.scrollHeight;sessionData.push({text:text,sender:sender,timestamp:new Date().toISOString(),});saveSession();}
function displayQuestion(questionIndex){const questions=["What aspects of your academic life cause you the most stress?","How would you describe your overall emotional state in the past month?","How comfortable do you feel talking to friends or family about your mental health?","How frequently do you experience feelings of anxiety or worry related to school?","How many hours of sleep do you usually get on a school night?","How confident do you feel in your academic abilities?","How do you usually feel about changes in your academic or personal life?","How do you manage your time between schoolwork, extracurricular activities, and relaxation?","How motivated do you feel to complete your academic tasks?","Are you aware of the mental health resources available at your school?",];if(questionIndex>=questions.length){generateMessage("Thank you for answering all the questions!","bot");saveChatSessionData("Thank you for answering all the questions!","bot");return;}
currentQuestionIndex=questionIndex;showLoader(document.getElementById("chatBody"));setTimeout(()=>{removeLoader(document.getElementById("chatBody"));generateMessage(questions[questionIndex],"bot");saveChatSessionData(questions[questionIndex],"bot");setTimeout(()=>{displayAnswerOptions(questionIndex);},500);},1500);}
function displayAnswerOptions(questionIndex){const chatBody=document.getElementById("chatBody");if(!document.querySelector(".answers-wrapper")){const answersWrapper=document.createElement("div");answersWrapper.className="message-wrapper answers-wrapper";const answers=[["Managing multiple assignments and deadlines.","Understanding difficult subjects or topics.","Balancing academics with extracurricular activities.",],["Generally positive, with only occasional low moods.","Mixed, with frequent ups and downs.","Often stressed or anxious.",],["Very comfortable, I often share how I’m feeling.","Somewhat comfortable, I share occasionally.","Not comfortable, I usually keep things to myself.",],["Almost daily, it’s a constant presence.","Occasionally, but only around stressful times like exams.","Rarely, I don’t get anxious easily.",],["Less than 6 hours, I often stay up late.","Between 6 and 8 hours, it varies.","More than 8 hours, I prioritize my sleep.",],["Very confident, I believe in my abilities.","Somewhat confident, but I have doubts sometimes.","Not very confident, I often worry about my performance.",],["Excited and ready to adapt.","Nervous but willing to adjust.","Stressed and resistant to change.",],["I create a schedule and stick to it as much as possible.","I try to balance things, but it’s a challenge.","I often struggle to manage my time effectively.",],["Highly motivated, I’m eager to succeed.","Moderately motivated, but it depends on the task.","Often unmotivated, I struggle to find the drive.",],["Yes, I know where to find help if I need it.","Somewhat, I’ve heard of some resources but haven’t explored them.","No, I’m not aware of the available resources.",],];answers[questionIndex].forEach((answerText,index)=>{const answerButton=document.createElement("button");answerButton.className="answers-button";answerButton.textContent=answerText;answerButton.onclick=function(){handleAnswerSelection(questionIndex,index,answerText);};answersWrapper.appendChild(answerButton);});chatBody.appendChild(answersWrapper);chatBody.scrollTop=chatBody.scrollHeight;}}
function checkLastGeneratedMessage(){const lastMessage=sessionData[sessionData.length-1];if(lastMessage.text.includes("Hello! Welcome to Piracle, your emotional support companion. How can I assist you today? Should we start?")&&currentQuestionIndex===-1){setTimeout(displayOptions,500);}else{checkLastGeneratedMessage();const questions=["What aspects of your academic life cause you the most stress?","How would you describe your overall emotional state in the past month?","How comfortable do you feel talking to friends or family about your mental health?","How frequently do you experience feelings of anxiety or worry related to school?","How many hours of sleep do you usually get on a school night?","How confident do you feel in your academic abilities?","How do you usually feel about changes in your academic or personal life?","How do you manage your time between schoolwork, extracurricular activities, and relaxation?","How motivated do you feel to complete your academic tasks?","Are you aware of the mental health resources available at your school?",];const questionIndex=questions.findIndex((q)=>q===lastMessage.text);if(questionIndex!==-1){currentQuestionIndex=questionIndex;setTimeout(()=>{displayAnswerOptions(questionIndex);},500);}}}
function handleAnswerSelection(questionIndex,answerIndex,answerText){const chatBody=document.getElementById("chatBody");const answersWrapper=document.querySelector(".answers-wrapper");if(answersWrapper){answersWrapper.classList.remove("pop-up");answersWrapper.classList.add("pop-down");setTimeout(()=>answersWrapper.remove(),300);}
generateMessage(answerText,"user");const responses=getResponses(questionIndex);const selectedResponse=responses[answerIndex];setTimeout(()=>{showLoader(chatBody);setTimeout(()=>{removeLoader(chatBody);generateMessage(selectedResponse,"bot");saveToDatabase(questionIndex,answerText,selectedResponse);if(questionIndex<questions.length-1){setTimeout(()=>{displayQuestion(questionIndex+1);},2000);}else{generateMessage("Thank you for answering all the questions!","bot");saveChatSessionData("Thank you for answering all the questions!","bot");}},1500);},1000);}
function getResponses(questionIndex){const responses=[["Managing multiple assignments can lead to significant stress, which can impact your mental health. It's important to develop strategies to manage this workload to protect your well-being.","Struggling with difficult subjects can cause stress and anxiety. Seeking help or using different study methods can reduce these feelings and improve your mental health.","Balancing academics and extracurriculars can be stressful and may overwhelm your mental health. Finding a healthy balance is key to maintaining your mental well-being.",],["It's great to hear that you've been feeling generally positive. Maintaining a positive emotional state is important for good mental health, so keep focusing on what keeps you feeling well.","Experiencing frequent ups and downs can be challenging for your mental health. It might be helpful to explore techniques to stabilize your emotions and support your well-being.","Feeling stressed or anxious often can take a toll on your mental health. It's important to address these feelings and find ways to manage them to protect your mental and emotional well-being.",],["It’s excellent that you feel comfortable discussing your mental health with others. Having a support system is crucial for maintaining good mental health.","It’s good that you share your feelings sometimes. Being open about your mental health can provide relief and support, which are important for emotional well-being.","Keeping your feelings to yourself can lead to increased stress and affect your mental health. Consider finding a trusted person to talk to, as sharing can be very beneficial.",],["Experiencing daily anxiety can significantly impact your mental health. It's important to seek ways to reduce this anxiety, as prolonged stress can have serious effects on your well-being.","Feeling anxious during stressful times like exams is common, but managing this anxiety is key to protecting your mental health during these periods.","It's great that you rarely experience anxiety. Maintaining this level of calm is beneficial for your mental health, and it’s important to continue practicing whatever keeps you feeling this way.",],["Getting less than 6 hours of sleep can negatively affect your mental health, leading to increased stress and reduced emotional resilience. Prioritizing sleep is crucial for your well-being.","Getting between 6 and 8 hours of sleep is important, but inconsistency can impact your mental health. A regular sleep routine can improve your emotional stability and reduce stress.","Prioritizing sleep is one of the best things you can do for your mental health. It helps maintain emotional balance and resilience, which are key to handling stress.",],["Feeling confident in your abilities is excellent for your mental health. It can reduce anxiety and stress, contributing to a more positive and balanced state of mind.","Having some doubts is normal, but too much self-doubt can negatively impact your mental health. Building confidence through small successes can help improve your overall well-being.","Constant worry about your performance can lead to anxiety and stress, affecting your mental health. It's important to address these worries and work on building self-confidence.",],["Being excited about change is a positive sign for your mental health. Adaptability and a positive outlook can help you manage stress and maintain emotional well-being.","It’s normal to feel nervous about change, but being willing to adjust is important for your mental health. Embracing change gradually can help reduce stress and anxiety.","Resistance to change can cause stress, which may impact your mental health. Finding ways to cope with change is crucial for maintaining emotional stability.",],["Having a schedule and sticking to it is excellent for your mental health. It helps reduce stress and ensures you have time for relaxation, which is crucial for emotional well-being.","Balancing your responsibilities can be challenging and impact your mental health. Developing better time management skills can reduce stress and improve your overall well-being.","Struggling with time management can lead to stress and affect your mental health. Working on these skills can help you feel more in control and reduce anxiety.",],["High motivation is a great indicator of good mental health. Staying motivated helps you manage stress and keep a positive outlook.","It's normal for motivation to vary, but staying engaged in your tasks can support your mental health by providing a sense of accomplishment.","Struggling with motivation can be a sign of mental fatigue or stress. It’s important to address these feelings to prevent them from negatively impacting your mental health.",],["It’s great that you’re aware of the mental health resources available. Knowing where to get help is crucial for maintaining your mental well-being.","It’s good that you’re somewhat aware, but exploring these resources further can ensure you have the support you need when challenges arise.","It’s important to be informed about mental health resources, as they can provide crucial support when needed. Taking the time to learn about them can make a big difference.",],];return responses[questionIndex];}
function checkLatestMessageType(){if(sessionData.length===0)return;const lastMessage=sessionData[sessionData.length-1];if(lastMessage.text.includes("Hello! Welcome to Piracle, your emotional support companion. How can I assist you today? Should we start?")&&currentQuestionIndex===-1){setTimeout(displayOptions,500);}else if(lastMessage.sender==="bot"&&lastMessage.questionIndex!==null){if(currentQuestionIndex<questions.length-1){setTimeout(()=>{displayAnswerOptions(currentQuestionIndex);},500);}else{generateMessage("Thank you for answering all the questions!","bot");saveChatSessionData("Thank you for answering all the questions!","bot");}}}
function saveChatSessionData(text,sender){sessionData.push({text,sender,timestamp:new Date().toISOString(),questionIndex:currentQuestionIndex,});saveSession();}
function loadChatSession(){return fetch("/load_chat_session/",{method:"GET",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken"),},}).then((response)=>response.json()).then((data)=>{if(data.success&&data.session_data){sessionData=data.session_data;sessionId=data.session_id;}});}
function addTimestampIfNeeded(chatBody){const currentTime=new Date();if(!lastMessageTime||currentTime-lastMessageTime>300000){addTimestamp(chatBody,getCurrentTime());sessionData.push({text:getCurrentTime(),sender:"timestamp",});saveSession();}
lastMessageTime=currentTime;}
function getCurrentTime(){const now=new Date();let hours=now.getHours();const minutes=now.getMinutes();const ampm=hours>=12?"PM":"AM";hours=hours%12;hours=hours?12:0;const strMinutes=minutes<10?"0"+minutes:minutes;return hours+":"+strMinutes+" "+ampm;}
function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==""){const cookies=document.cookie.split(";");for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}
document.addEventListener("DOMContentLoaded",updateChatPosition);if(statusComposerButton){statusComposerButton.addEventListener("click",function(){statusModal.style.display="block";statusModalOverlay.style.display="block";setTimeout(()=>{statusModal.classList.add("pop-in");statusModalOverlay.classList.add("pop-in");},10);});}
closeStatusModal.addEventListener("click",function(){closeModal();});statusModalOverlay.addEventListener("click",function(){closeModal();});function closeModal(){statusModal.classList.remove("pop-in");statusModal.classList.add("pop-out");statusModalOverlay.classList.remove("pop-in");statusModalOverlay.classList.add("pop-out");setTimeout(()=>{statusModal.style.display="none";statusModal.classList.remove("pop-out");statusModalOverlay.style.display="none";statusModalOverlay.classList.remove("pop-out");},300);}
function showPlaceholder(){if(!descriptionDiv.textContent.trim().length){descriptionDiv.classList.add("placeholder");descriptionDiv.textContent=descriptionDiv.getAttribute("placeholder");}}
function hidePlaceholder(){if(descriptionDiv.classList.contains("placeholder")){descriptionDiv.classList.remove("placeholder");descriptionDiv.textContent="";}}
descriptionDiv.addEventListener("focus",hidePlaceholder);descriptionDiv.addEventListener("blur",showPlaceholder);showPlaceholder();const feelingIcons=document.querySelectorAll(".feeling-icon");feelingIcons.forEach((icon)=>{icon.addEventListener("click",()=>{feelingIcons.forEach((i)=>i.classList.remove("active"));icon.classList.add("active");});});window.formatText=function(command,value=null){document.execCommand(command,false,value);};function closeCurrentModal(){const modals=document.querySelectorAll(".modal-content");modals.forEach((modal)=>{if(modal.style.display==="block"){modal.classList.add("slide-upSolid");modal.classList.remove("slide-downSolid");}});}
document.querySelectorAll(".modal-content").forEach((modal)=>{modal.addEventListener("animationend",(event)=>{if(event.animationName==="slideUpSolid"){modal.style.display="none";}});});profileLink.addEventListener("click",(e)=>{e.preventDefault();closeCurrentModal();profileModal.style.display="block";profileModal.classList.add("slide-downSolid");profileModal.classList.remove("slide-upSolid");fetchUserProfile();});burger.addEventListener("change",()=>{if(burger.checked){dropdown.classList.add("slide-down");dropdown.classList.remove("slide-up");dropdown.style.display="block";}else{dropdown.classList.add("slide-up");dropdown.classList.remove("slide-down");}});dropdown.addEventListener("animationend",(event)=>{if(event.animationName==="slideUp"){dropdown.style.display="none";}});document.querySelectorAll(".dropdown a").forEach((link)=>{link.addEventListener("click",()=>{burger.checked=false;dropdown.classList.add("slide-up");dropdown.classList.remove("slide-down");});});profileLink.addEventListener("click",(e)=>{e.preventDefault();closeCurrentModal();profileModal.style.display="block";profileModal.classList.add("slide-downSolid");profileModal.classList.remove("slide-upSolid");});closeProfileModal.addEventListener("click",()=>{profileModal.classList.add("slide-upSolid");profileModal.classList.remove("slide-downSolid");});avatarLink.addEventListener("click",(e)=>{e.preventDefault();closeCurrentModal();avatarModal.style.display="block";avatarModal.classList.add("slide-downSolid");avatarModal.classList.remove("slide-upSolid");});closeAvatarModal.addEventListener("click",()=>{avatarModal.classList.add("slide-upSolid");avatarModal.classList.remove("slide-downSolid");});passwordLink.addEventListener("click",(e)=>{e.preventDefault();closeCurrentModal();passwordModal.style.display="block";passwordModal.classList.add("slide-downSolid");passwordModal.classList.remove("slide-upSolid");});closePasswordModal.addEventListener("click",()=>{passwordModal.classList.add("slide-upSolid");passwordModal.classList.remove("slide-downSolid");});;const profanityCheckUrl="/check_profanity/";;